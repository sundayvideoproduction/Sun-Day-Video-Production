<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kachin Visions Empire</title>
    
    <!-- Import Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-storage-compat.js"></script>
    
    <!-- Import HLS.js for adaptive bitrate streaming -->
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    
    <!-- Import jsPDF for PDF generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <!-- Import CryptoJS for encryption -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    
    <!-- Import Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* ===== GLOBAL STYLES ===== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            -webkit-tap-highlight-color: transparent;
        }

        /* Normal Mode (Default) - Color Version */
        body.normal-mode {
            --primary: #4a6baf;
            --secondary: #3a5999;
            --accent: #5a8dee;
            --accent-glow: rgba(90, 141, 238, 0.3);
            --dark: #f8f9fa;
            --darker: #e9ecef;
            --light: #212529;
            --gray: #6c757d;
            --success: #28a745;
            --warning: #ffc107;
            --danger: #dc3545;
            --card-bg: #ffffff;
            --card-border: #dee2e6;
            --card-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            --card-glow: none;
            --transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            --transition-slow: all 0.5s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            --border-radius: 6px;
            background: #f8f9fa;
            color: #212529;
            filter: none;
        }

        /* Digital Mode (Current) - Enhanced with 3D effects */
        body.digital-mode {
            --primary: #ff9900;
            --secondary: #ff5500;
            --accent: #ffcc00;
            --accent-glow: rgba(255, 204, 0, 0.7);
            --dark: #0a0a1a;
            --darker: #050510;
            --light: #f0f8ff;
            --gray: #8a93a7;
            --success: #00ffcc;
            --warning: #ffcc00;
            --danger: #ff3e3e;
            --card-bg: rgba(15, 20, 40, 0.9);
            --card-border: rgba(255, 153, 0, 0.3);
            --card-shadow: 0 4px 12px rgba(0, 0, 0, 0.6);
            --card-glow: 0 0 15px rgba(255, 153, 0, 0.4);
            --transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            --transition-slow: all 0.5s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            --border-radius: 12px;
            background: linear-gradient(135deg, var(--darker), var(--dark), #1a0f0a);
            color: var(--light);
            filter: none;
        }

        /* Dark Mode - No changes */
        body.dark-mode {
            --primary: #6c5ce7;
            --secondary: #a29bfe;
            --accent: #fd79a8;
            --accent-glow: rgba(253, 121, 168, 0.7);
            --dark: #121212;
            --darker: #0a0a0a;
            --light: #e0e0e0;
            --gray: #9e9e9e;
            --success: #00b894;
            --warning: #fdcb6e;
            --danger: #d63031;
            --card-bg: rgba(30, 30, 30, 0.9);
            --card-border: rgba(108, 92, 231, 0.3);
            --card-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
            --card-glow: 0 0 15px rgba(108, 92, 231, 0.4);
            --transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            --transition-slow: all 0.5s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            --border-radius: 12px;
            background: #121212;
            color: #e0e0e0;
            filter: none;
        }

        body {
            min-height: 100vh;
            overflow-x: hidden;
            line-height: 1.6;
            position: relative;
            font-size: 8px;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 10px;
            padding-bottom: 60px;
        }

        /* ===== SCREEN STYLES ===== */
        .screen {
            display: none;
            min-height: 100vh;
            padding: 10px;
            animation: fadeIn 0.5s ease-in-out;
            position: relative;
        }

        .active {
            display: block;
        }

        /* ===== TOP BAR STYLES ===== */
        .top-bar {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
            position: relative;
            z-index: 10;
            gap: 10px;
            flex-wrap: wrap;
        }

        .top-bar-left {
            display: flex;
            flex-direction: column;
            gap: 8px;
            flex: 1;
            max-width: 200px;
        }

        /* NEW: Story and Password Row Container */
        .story-password-row {
            display: flex;
            flex-direction: column;
            gap: 10px;
            flex: 1;
            max-width: 300px;
            align-items: flex-end;
        }

        @media (min-width: 768px) {
            .story-password-row {
                flex-direction: row;
                align-items: flex-start;
                justify-content: flex-end;
            }
        }

        /* ===== 3D KACHIN VISIONS EMPIRE LOGO WITH ANIMATION ===== */
        .logo-container {
            position: relative;
            display: flex;
            justify-content: flex-start;
            align-items: center;
            margin-bottom: 5px;
        }

        .kachin-visions-logo {
            font-size: 14px;
            font-weight: 700;
            text-transform: uppercase;
            position: relative;
            perspective: 1000px;
        }

        body.normal-mode .kachin-visions-logo {
            color: #4a6baf;
        }

        body.digital-mode .kachin-visions-logo {
            color: #ff9900;
            animation: sunRise 3s ease-in-out infinite alternate;
            text-shadow: 0 0 10px rgba(255, 153, 0, 0.5),
                         0 0 20px rgba(255, 153, 0, 0.3),
                         0 0 30px rgba(255, 153, 0, 0.1);
        }

        body.dark-mode .kachin-visions-logo {
            color: #6c5ce7;
        }

        .kachin-visions-logo .kachin {
            color: inherit;
            display: inline-block;
            position: relative;
            animation: sunGlow 2s ease-in-out infinite alternate;
        }

        body.digital-mode .kachin-visions-logo .kachin {
            animation: sunPulse 3s ease-in-out infinite;
        }

        .kachin-visions-logo .visions {
            color: inherit;
            display: inline-block;
            position: relative;
            transform-style: preserve-3d;
            transition: var(--transition-slow);
        }

        body.digital-mode .kachin-visions-logo .visions {
            animation: lightWave 4s ease-in-out infinite;
        }

        @keyframes sunRise {
            0% {
                transform: translateY(0) rotateX(0deg);
                text-shadow: 0 0 10px rgba(255, 153, 0, 0.5);
            }
            100% {
                transform: translateY(-5px) rotateX(20deg);
                text-shadow: 0 0 20px rgba(255, 153, 0, 0.8),
                             0 0 40px rgba(255, 153, 0, 0.4);
            }
        }

        @keyframes sunGlow {
            0% {
                text-shadow: 0 0 5px rgba(255, 153, 0, 0.3);
            }
            100% {
                text-shadow: 0 0 15px rgba(255, 153, 0, 0.8),
                             0 0 25px rgba(255, 204, 0, 0.4);
            }
        }

        @keyframes sunPulse {
            0%, 100% {
                transform: scale(1);
                color: #ff9900;
            }
            50% {
                transform: scale(1.1);
                color: #ffcc00;
            }
        }

        @keyframes lightWave {
            0%, 100% {
                transform: translateX(0) skewY(0deg);
                color: #f0f8ff;
            }
            50% {
                transform: translateX(5px) skewY(-5deg);
                color: #ffffff;
                text-shadow: 0 0 15px rgba(255, 255, 255, 0.7);
            }
        }

        /* 3D Effect for Digital Mode */
        body.digital-mode .kachin-visions-logo {
            position: relative;
        }

        body.digital-mode .kachin-visions-logo::before {
            content: 'Kachin Visions Empire';
            position: absolute;
            top: 2px;
            left: 2px;
            color: rgba(255, 85, 0, 0.5);
            z-index: -1;
            filter: blur(2px);
        }

        /* ===== COMPACT PASSWORD SECTION ===== */
        .compact-password-section {
            background: var(--card-bg);
            backdrop-filter: blur(10px);
            border-radius: var(--border-radius);
            padding: 8px;
            box-shadow: var(--card-shadow);
            border: 1px solid var(--card-border);
            transition: var(--transition);
            width: 100%;
            font-size: 8px;
            overflow: hidden;
            position: relative;
        }

        .compact-password-section:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .compact-password-section .form-title {
            font-size: 8px;
            margin-bottom: 6px;
            color: var(--light);
            text-align: center;
            font-weight: 600;
            transition: var(--transition);
        }

        .compact-password-section .form-group {
            margin-bottom: 6px;
            transition: var(--transition);
        }

        .compact-password-section .form-input {
            padding: 6px;
            font-size: 8px;
            background: var(--dark);
            border: 1px solid var(--card-border);
            border-radius: var(--border-radius);
            color: var(--light);
            width: 100%;
            transition: var(--transition);
            min-height: 28px;
            box-sizing: border-box;
        }

        .compact-password-section .form-input:focus {
            outline: none;
            border-color: var(--primary);
        }

        .compact-password-section .form-input::placeholder {
            color: var(--gray);
            font-size: 8px;
        }

        .compact-password-section .submit-btn {
            padding: 6px;
            font-size: 8px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-weight: 600;
            transition: var(--transition);
            width: 100%;
            min-height: 28px;
            box-sizing: border-box;
            overflow: hidden;
            white-space: nowrap;
        }

        .compact-password-section .submit-btn:hover {
            transform: translateY(-2px);
        }

        .compact-password-section .login-status {
            text-align: center;
            margin-top: 6px;
            font-size: 8px;
            transition: var(--transition);
        }

        /* Small state for password box */
        .compact-password-section.small-state .form-input {
            width: 6px !important;
            height: 4px !important;
            padding: 0 !important;
            font-size: 0 !important;
            min-height: 4px !important;
            overflow: hidden;
        }

        .compact-password-section.small-state .submit-btn {
            width: 6px !important;
            height: 4px !important;
            padding: 0 !important;
            font-size: 0 !important;
            min-height: 4px !important;
            overflow: hidden;
        }

        .compact-password-section.small-state .form-title {
            font-size: 0 !important;
            height: 0 !important;
            margin: 0 !important;
            padding: 0 !important;
            overflow: hidden;
            opacity: 0;
        }

        .compact-password-section.small-state .form-group {
            margin-bottom: 2px !important;
        }

        .compact-password-section.small-state .login-status {
            font-size: 0 !important;
            height: 0 !important;
            margin: 0 !important;
            padding: 0 !important;
            overflow: hidden;
            opacity: 0;
        }

        /* ===== STORY COLLECTION MENU ===== */
        .story-collection-menu {
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            flex: 0 0 auto;
            min-width: 80px;
        }

        .story-menu-toggle {
            background: var(--card-bg);
            backdrop-filter: blur(10px);
            border-radius: var(--border-radius);
            padding: 6px 8px;
            cursor: pointer;
            transition: var(--transition);
            border: 1px solid var(--card-border);
            box-shadow: var(--card-shadow);
            font-size: 8px;
            color: var(--light);
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 4px;
            min-height: 28px;
            width: 100%;
            justify-content: center;
        }

        .story-menu-toggle:hover {
            background: rgba(0, 0, 0, 0.1);
            transform: translateY(-2px);
        }

        .story-menu {
            background: var(--card-bg);
            backdrop-filter: blur(10px);
            border-radius: var(--border-radius);
            padding: 8px;
            box-shadow: var(--card-shadow);
            border: 1px solid var(--card-border);
            position: absolute;
            top: 100%;
            right: 0;
            margin-top: 5px;
            min-width: 120px;
            z-index: 100;
            display: none;
        }

        .story-menu.active {
            display: block;
            animation: fadeIn 0.3s ease-in-out;
        }

        .story-menu-title {
            text-align: center;
            margin-bottom: 8px;
            font-size: 8px;
            color: var(--light);
            font-weight: 600;
        }

        .story-list {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .story-item {
            background: rgba(0, 0, 0, 0.1);
            padding: 6px 8px;
            border-radius: 4px;
            cursor: pointer;
            transition: var(--transition);
            border: 1px solid var(--card-border);
            font-weight: 600;
            font-size: 8px;
            min-height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .story-item:hover {
            background: rgba(0, 0, 0, 0.2);
            transform: translateY(-2px);
        }

        .story-item.active {
            background: rgba(0, 0, 0, 0.3);
        }

        /* ===== STORY PASSWORD SECTION ===== */
        .story-password-section {
            background: var(--card-bg);
            backdrop-filter: blur(10px);
            border-radius: var(--border-radius);
            padding: 8px;
            box-shadow: var(--card-shadow);
            border: 1px solid var(--card-border);
            margin-bottom: 0;
            display: none;
            width: 180px;
            flex: 0 0 auto;
            min-width: 150px;
            position: relative;
            overflow: hidden;
        }

        .story-password-section.active {
            display: block;
            animation: slideIn 0.3s ease-out;
        }

        .story-password-section .form-title {
            font-size: 8px;
            margin-bottom: 6px;
            color: var(--light);
            text-align: center;
            font-weight: 600;
        }

        .story-password-section .form-group {
            margin-bottom: 6px;
        }

        .story-password-section .form-input {
            padding: 6px;
            font-size: 8px;
            background: var(--dark);
            border: 1px solid var(--card-border);
            border-radius: var(--border-radius);
            color: var(--light);
            width: 100%;
            transition: var(--transition);
            min-height: 28px;
        }

        .story-password-section .form-input:focus {
            outline: none;
            border-color: var(--primary);
        }

        .story-password-section .form-input::placeholder {
            color: var(--gray);
            font-size: 8px;
        }

        .story-password-section .submit-btn {
            padding: 6px;
            font-size: 8px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-weight: 600;
            transition: var(--transition);
            width: 100%;
            min-height: 28px;
        }

        .story-password-section .submit-btn:hover {
            transform: translateY(-2px);
        }

        .story-password-section .login-status {
            text-align: center;
            margin-top: 6px;
            font-size: 8px;
        }

        /* ===== PASSWORD TIMER DISPLAY ===== */
        .password-timer-display {
            position: fixed;
            top: 5px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.7);
            color: var(--light);
            padding: 6px 10px;
            border-radius: 15px;
            font-size: 8px;
            z-index: 1000;
            text-align: center;
            backdrop-filter: blur(5px);
            border: 1px solid var(--card-border);
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
        }

        /* ===== FOOTER ===== */
        .app-footer {
            position: fixed;
            bottom: 10px;
            left: 10px;
            font-size: 8px;
            opacity: 0.4;
            color: var(--light);
            font-family: 'Courier New', monospace;
            z-index: 1000;
        }

        /* ===== HEADER STYLES ===== */
        .header {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            align-items: flex-start;
            padding: 15px 0;
            margin-bottom: 20px;
            position: relative;
            gap: 15px;
        }

        .site-title {
            font-size: clamp(1.5rem, 4vw, 2rem);
            font-weight: 700;
            background: var(--light);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 15px;
            letter-spacing: 1px;
            position: relative;
            z-index: 2;
            flex: 1;
            min-width: 200px;
            text-align: center;
        }

        .back-btn-container {
            position: absolute;
            top: 15px;
            left: 15px;
            z-index: 100;
        }

        .back-btn {
            background: var(--danger);
            color: white;
            border: none;
            padding: 8px 10px;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-weight: 600;
            transition: var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
            font-size: 8px;
            min-height: 28px;
        }

        .back-btn:hover {
            transform: translateY(-2px);
        }

        /* ===== VIDEO PLAYER STYLES ===== */
        .video-section {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 20px;
        }

        .main-video-container {
            width: 100%;
            background: var(--card-bg);
            backdrop-filter: blur(10px);
            border-radius: var(--border-radius);
            overflow: hidden;
            box-shadow: var(--card-shadow);
            position: relative;
            aspect-ratio: 16/9;
            border: 1px solid var(--card-border);
            transition: var(--transition);
        }

        .main-video-container:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
        }

        .video-player {
            width: 100%;
            height: 100%;
            background: #000;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow: hidden;
        }

        .video-player-wrapper {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        .black-bars {
            position: absolute;
            left: 0;
            right: 0;
            background: #000;
            z-index: 10;
            pointer-events: none;
        }

        .top-bar {
            top: 0;
        }

        .bottom-bar {
            bottom: 0;
        }

        .video-content {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            z-index: 1;
        }

        .video-list-container {
            width: 100%;
            background: var(--card-bg);
            backdrop-filter: blur(10px);
            border-radius: var(--border-radius);
            padding: 12px;
            box-shadow: var(--card-shadow);
            border: 1px solid var(--card-border);
            transition: var(--transition);
            font-size: 8px;
        }

        .video-list-container:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
        }

        .video-list-title {
            text-align: center;
            margin-bottom: 12px;
            font-size: 9px;
            color: var(--light);
            font-weight: 600;
        }

        .video-list {
            max-height: 200px;
            overflow-y: auto;
            padding-right: 5px;
            font-size: 8px;
        }

        /* Custom scrollbar */
        .video-list::-webkit-scrollbar {
            width: 4px;
        }

        .video-list::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 5px;
        }

        .video-list::-webkit-scrollbar-thumb {
            background: var(--primary);
            border-radius: 5px;
        }

        .video-list::-webkit-scrollbar-thumb:hover {
            background: var(--secondary);
        }

        .video-item {
            background: rgba(0, 0, 0, 0.05);
            margin-bottom: 6px;
            padding: 8px;
            border-radius: 6px;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-left: 3px solid transparent;
            position: relative;
            overflow: hidden;
            min-height: 40px;
            font-size: 8px;
        }

        .video-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent);
            transition: var(--transition-slow);
        }

        .video-item:hover::before {
            left: 100%;
        }

        .video-item:hover {
            background: rgba(0, 0, 0, 0.1);
            transform: translateX(4px);
            border-left-color: var(--accent);
        }

        .video-item.locked {
            background: rgba(255, 0, 0, 0.05);
            cursor: not-allowed;
        }

        .video-item.locked:hover {
            background: rgba(255, 0, 0, 0.1);
            transform: none;
            border-left-color: transparent;
        }

        .video-item.free {
            background: rgba(0, 255, 204, 0.03);
            border-left-color: var(--success);
        }

        .video-item.free:hover {
            background: rgba(0, 255, 204, 0.06);
        }

        .offline-badge {
            background: var(--success);
            color: white;
            padding: 2px 4px;
            border-radius: 10px;
            font-size: 6px;
            margin-left: 6px;
            font-weight: 600;
        }

        .free-badge {
            background: var(--secondary);
            color: white;
            padding: 2px 4px;
            border-radius: 10px;
            font-size: 6px;
            margin-left: 6px;
            font-weight: 600;
        }

        /* ===== FORM STYLES ===== */
        .form-container {
            background: var(--card-bg);
            backdrop-filter: blur(10px);
            border-radius: var(--border-radius);
            padding: 12px;
            margin-bottom: 20px;
            box-shadow: var(--card-shadow);
            border: 1px solid var(--card-border);
            transition: var(--transition);
            font-size: 8px;
        }

        .form-container:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
        }

        .form-title {
            text-align: center;
            margin-bottom: 12px;
            font-size: 9px;
            color: var(--light);
            font-weight: 600;
        }

        .form-group {
            margin-bottom: 12px;
        }

        .form-label {
            display: block;
            margin-bottom: 4px;
            font-weight: 600;
            color: var(--light);
            font-size: 8px;
        }

        .form-input {
            width: 100%;
            padding: 8px;
            border-radius: var(--border-radius);
            border: 1px solid var(--card-border);
            background: var(--dark);
            font-size: 8px;
            color: var(--light);
            transition: var(--transition);
            min-height: 32px;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--primary);
        }

        .form-input::placeholder {
            color: var(--gray);
            font-size: 8px;
        }

        .form-textarea {
            width: 100%;
            padding: 8px;
            border-radius: var(--border-radius);
            border: 1px solid var(--card-border);
            background: var(--dark);
            font-size: 8px;
            min-height: 80px;
            resize: vertical;
            color: var(--light);
            transition: var(--transition);
        }

        .form-textarea:focus {
            outline: none;
            border-color: var(--primary);
        }

        .form-textarea::placeholder {
            color: var(--gray);
            font-size: 8px;
        }

        .submit-btn {
            width: 100%;
            padding: 8px;
            border-radius: var(--border-radius);
            border: none;
            background: var(--success);
            color: white;
            font-size: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            min-height: 32px;
        }

        .submit-btn:hover {
            transform: translateY(-3px);
        }

        /* ===== BUTTON STYLES ===== */
        .btn-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 15px;
        }

        .nav-btn {
            padding: 8px 12px;
            border-radius: var(--border-radius);
            border: none;
            background: var(--primary);
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            box-shadow: var(--card-shadow);
            font-size: 8px;
            min-height: 32px;
        }

        .nav-btn:hover {
            transform: translateY(-3px);
        }

        .nav-btn.back {
            background: var(--danger);
        }

        .admin-login-btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-weight: 600;
            transition: var(--transition);
            box-shadow: var(--card-shadow);
            width: 100%;
            max-width: 150px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            margin-top: 15px;
            font-size: 8px;
            letter-spacing: 0.3px;
            min-height: 32px;
        }

        .admin-login-btn:hover {
            transform: translateY(-3px);
        }

        /* ===== ADMIN SECTION STYLES ===== */
        .admin-section {
            background: var(--card-bg);
            backdrop-filter: blur(10px);
            border-radius: var(--border-radius);
            padding: 12px;
            margin-bottom: 15px;
            box-shadow: var(--card-shadow);
            border: 1px solid var(--card-border);
            transition: var(--transition);
            font-size: 8px;
        }

        .admin-section:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
        }

        .admin-title {
            text-align: center;
            margin-bottom: 12px;
            font-size: 9px;
            color: var(--light);
            font-weight: 600;
        }

        .video-source-form {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-bottom: 12px;
        }

        .source-input {
            width: 100%;
            padding: 8px;
            border-radius: var(--border-radius);
            border: 1px solid var(--card-border);
            background: var(--dark);
            color: var(--light);
            transition: var(--transition);
            font-size: 8px;
            min-height: 32px;
        }

        .source-input:focus {
            outline: none;
            border-color: var(--primary);
        }

        .source-input::placeholder {
            color: var(--gray);
            font-size: 8px;
        }

        .add-btn {
            padding: 8px 12px;
            border-radius: var(--border-radius);
            border: none;
            background: var(--success);
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            font-size: 8px;
            min-height: 32px;
        }

        .add-btn:hover {
            transform: translateY(-3px);
        }

        .user-list, .video-admin-list {
            margin-top: 12px;
        }

        .user-item, .video-admin-item {
            background: rgba(0, 0, 0, 0.05);
            margin-bottom: 8px;
            padding: 10px;
            border-radius: 6px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            border-left: 3px solid var(--primary);
            transition: var(--transition);
            position: relative;
            overflow: hidden;
            font-size: 8px;
        }

        .user-item::before, .video-admin-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent);
            transition: var(--transition-slow);
        }

        .user-item:hover::before, .video-admin-item:hover::before {
            left: 100%;
        }

        .user-item:hover, .video-admin-item:hover {
            background: rgba(0, 0, 0, 0.1);
            transform: translateX(3px);
        }

        .user-info, .video-admin-info {
            flex: 1;
            font-size: 8px;
        }

        .user-actions, .video-admin-actions {
            display: flex;
            gap: 6px;
        }

        .edit-btn, .delete-btn, .reset-device-btn, .export-btn, .bulk-delete-btn, .cache-btn, .move-up-btn, .move-down-btn, .first-play-btn {
            padding: 6px 8px;
            border-radius: 4px;
            border: none;
            cursor: pointer;
            font-weight: 600;
            transition: var(--transition);
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
            font-size: 7px;
            min-height: 24px;
        }

        .edit-btn {
            background: var(--primary);
            color: white;
        }

        .delete-btn {
            background: var(--danger);
            color: white;
        }

        .reset-device-btn {
            background: var(--warning);
            color: white;
        }

        .export-btn {
            background: #2196F3;
            color: white;
        }

        .bulk-delete-btn {
            background: #9C27B0;
            color: white;
        }

        .cache-btn {
            background: var(--success);
            color: white;
        }

        .move-up-btn {
            background: var(--warning);
            color: white;
        }

        .move-down-btn {
            background: #2196F3;
            color: white;
        }

        .first-play-btn {
            background: #9C27B0;
            color: white;
        }

        .first-play-btn.active {
            background: var(--success);
        }

        .edit-btn:hover, .delete-btn:hover, .reset-device-btn:hover, .export-btn:hover, .bulk-delete-btn:hover, .cache-btn:hover, .move-up-btn:hover, .move-down-btn:hover, .first-play-btn:hover {
            transform: translateY(-2px);
        }

        .online-status {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 4px;
        }

        .online {
            background: var(--success);
        }

        .offline {
            background: var(--danger);
        }

        .device-info {
            background: rgba(0, 0, 0, 0.1);
            padding: 8px;
            border-radius: 4px;
            margin-top: 8px;
        }

        .device-list {
            margin-top: 8px;
        }

        .device-item {
            background: rgba(255, 255, 255, 0.05);
            padding: 6px;
            margin-bottom: 4px;
            border-radius: 4px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        /* ===== MODAL STYLES ===== */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            padding: 10px;
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background: var(--dark);
            padding: 15px;
            border-radius: var(--border-radius);
            width: 100%;
            max-width: 300px;
            box-shadow: var(--card-shadow);
            border: 1px solid var(--card-border);
            animation: modalSlideIn 0.4s ease-out;
            font-size: 8px;
        }

        .modal-title {
            text-align: center;
            margin-bottom: 12px;
            font-size: 9px;
            color: var(--light);
            font-weight: 600;
        }

        .close-modal {
            float: right;
            font-size: 1rem;
            cursor: pointer;
            color: var(--light);
            transition: var(--transition);
            min-height: 24px;
            min-width: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .close-modal:hover {
            transform: scale(1.1);
        }

        /* ===== PASSWORD GENERATION STYLES ===== */
        .password-generation-container {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 12px;
        }

        .generated-passwords {
            background: rgba(0, 0, 0, 0.1);
            border-radius: var(--border-radius);
            padding: 10px;
            max-height: 150px;
            overflow-y: auto;
            font-size: 8px;
        }

        .password-item {
            padding: 6px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: var(--transition);
            font-size: 8px;
        }

        .password-item:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .password-item:last-child {
            border-bottom: none;
        }

        .copy-btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            padding: 4px 6px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 7px;
            transition: var(--transition);
            min-height: 24px;
        }

        .copy-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
        }

        /* ===== CONTACT LINKS STYLES ===== */
        .contact-links {
            display: flex;
            justify-content: center;
            gap: 8px;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        .contact-btn {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 8px 12px;
            border-radius: 25px;
            text-decoration: none;
            font-weight: 600;
            transition: var(--transition);
            min-width: 100px;
            justify-content: center;
            font-size: 8px;
            min-height: 32px;
        }

        .facebook-btn {
            background: #1877F2;
            color: white;
        }

        .telegram-btn {
            background: #0088cc;
            color: white;
        }

        .viber-btn {
            background: #7360F2;
            color: white;
        }

        .contact-btn:hover {
            transform: translateY(-3px);
        }

        /* ===== INSTAGRAM & TIKTOK VIDEO STYLES ===== */
        .instagram-iframe, .tiktok-iframe {
            width: 100%;
            height: 100%;
            border: none;
            border-radius: var(--border-radius);
        }

        .instagram-container, .tiktok-container {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        /* ===== SEARCH BAR STYLES ===== */
        .search-container {
            margin-bottom: 12px;
        }

        .search-input {
            width: 100%;
            padding: 8px;
            border-radius: var(--border-radius);
            border: 1px solid var(--card-border);
            background: var(--dark);
            font-size: 8px;
            color: var(--light);
            transition: var(--transition);
            min-height: 32px;
        }

        .search-input:focus {
            outline: none;
            border-color: var(--primary);
        }

        .search-input::placeholder {
            color: var(--gray);
            font-size: 8px;
        }

        /* ===== CONNECTION STATUS ===== */
        .connection-status {
            position: fixed;
            top: 10px;
            right: 10px;
            padding: 6px 8px;
            border-radius: 15px;
            font-size: 8px;
            z-index: 1000;
            backdrop-filter: blur(5px);
            display: flex;
            align-items: center;
            gap: 4px;
            font-weight: 600;
        }

        .online-status-badge {
            background: var(--success);
        }

        .offline-status-badge {
            background: var(--danger);
        }

        /* ===== ADMIN MESSAGE STYLES ===== */
        .admin-message-container {
            background: var(--card-bg);
            backdrop-filter: blur(10px);
            border-radius: var(--border-radius);
            padding: 12px;
            margin-bottom: 12px;
            box-shadow: var(--card-shadow);
            border: 1px solid var(--card-border);
            transition: var(--transition);
            font-size: 8px;
        }

        .admin-message-container:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
        }

        .admin-message-title {
            text-align: center;
            margin-bottom: 8px;
            font-size: 9px;
            color: var(--light);
            font-weight: 600;
        }

        .admin-message-content {
            background: rgba(255, 255, 255, 0.05);
            padding: 10px;
            border-radius: 6px;
            margin-bottom: 10px;
            min-height: 60px;
            user-select: text;
            -webkit-user-select: text;
            -moz-user-select: text;
            -ms-user-select: text;
            font-size: 8px;
            line-height: 1.6;
        }

        /* ===== RICH TEXT EDITOR STYLES ===== */
        .rich-text-editor {
            background: rgba(255, 255, 255, 0.1);
            border-radius: var(--border-radius);
            overflow: hidden;
            margin-bottom: 10px;
            border: 1px solid var(--card-border);
        }

        .toolbar {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
            padding: 8px;
            background: rgba(0, 0, 0, 0.8);
            border-bottom: 1px solid var(--card-border);
        }

        .toolbar-group {
            display: flex;
            gap: 4px;
            margin-right: 8px;
        }

        .toolbar-btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            padding: 6px 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 8px;
            transition: var(--transition);
            min-height: 24px;
            min-width: 24px;
        }

        .toolbar-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
        }

        .toolbar-btn.active {
            background: var(--primary);
        }

        .toolbar-select {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            padding: 6px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 8px;
            min-height: 24px;
        }

        .toolbar-color {
            width: 30px;
            height: 24px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            background: rgba(255, 255, 255, 0.2);
        }

        .editor-content {
            min-height: 150px;
            padding: 10px;
            color: #333;
            font-size: 8px;
            line-height: 1.6;
            outline: none;
            overflow-y: auto;
            max-height: 200px;
            user-select: text;
            -webkit-user-select: text;
            -moz-user-select: text;
            -ms-user-select: text;
            background: white;
        }

        .editor-content:empty:before {
            content: "Type your admin message here...";
            color: #999;
        }

        /* ===== YOUTUBE VIDEO STYLES ===== */
        .youtube-iframe {
            width: 100%;
            height: 100%;
            border: none;
        }

        /* ===== FULLSCREEN STYLES ===== */
        .fullscreen-btn {
            position: absolute;
            bottom: 10px;
            right: 10px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            border: none;
            padding: 6px 8px;
            border-radius: 4px;
            cursor: pointer;
            z-index: 10;
            font-size: 8px;
            display: flex;
            align-items: center;
            gap: 4px;
            transition: var(--transition);
            min-height: 24px;
        }

        .fullscreen-btn:hover {
            background: rgba(0, 0, 0, 0.9);
            transform: translateY(-2px);
        }

        /* ===== ERROR MESSAGE STYLES ===== */
        .error-message {
            color: var(--danger);
            text-align: center;
            padding: 12px;
            background: rgba(255, 0, 0, 0.05);
            border-radius: 6px;
            margin: 10px 0;
            border: 1px solid rgba(255, 0, 0, 0.1);
            font-size: 8px;
        }

        /* ===== TEXT SELECTION TOOLBAR ===== */
        .text-selection-toolbar {
            position: absolute;
            background: rgba(0, 0, 0, 0.8);
            border-radius: 6px;
            padding: 6px;
            display: none;
            flex-wrap: wrap;
            gap: 4px;
            z-index: 1000;
            backdrop-filter: blur(5px);
        }

        .selection-btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            padding: 6px 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 7px;
            transition: var(--transition);
            min-height: 24px;
        }

        .selection-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
        }

        /* ===== BLACK BAR CONFIGURATION STYLES ===== */
        .black-bar-config {
            background: rgba(0, 0, 0, 0.1);
            border-radius: 6px;
            padding: 10px;
            margin-top: 10px;
        }

        .bar-config-group {
            display: flex;
            gap: 6px;
            margin-bottom: 8px;
            align-items: center;
        }

        .bar-config-label {
            min-width: 80px;
            font-weight: 600;
            font-size: 8px;
        }

        .bar-config-input {
            width: 50px;
            padding: 6px;
            border-radius: 4px;
            border: 1px solid var(--card-border);
            background: rgba(255, 255, 255, 0.1);
            color: var(--light);
            font-size: 8px;
        }

        .bar-config-btn {
            padding: 6px 8px;
            border-radius: 4px;
            border: none;
            background: var(--primary);
            color: white;
            cursor: pointer;
            font-weight: 600;
            transition: var(--transition);
            font-size: 8px;
            min-height: 24px;
        }

        .bar-config-btn:hover {
            transform: translateY(-2px);
        }

        /* ===== VIDEO REORDERING STYLES ===== */
        .video-admin-item.dragging {
            opacity: 0.5;
            background: rgba(255, 255, 255, 0.2);
        }

        .video-admin-item.drag-over {
            border: 2px dashed var(--accent);
        }

        .video-order-controls {
            display: flex;
            gap: 4px;
            margin-top: 8px;
        }

        .order-btn {
            padding: 6px 8px;
            border-radius: 4px;
            border: none;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            cursor: pointer;
            font-size: 7px;
            transition: var(--transition);
            min-height: 24px;
        }

        .order-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
        }

        .order-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        /* ===== NO INTERNET CONNECTION MODAL ===== */
        .no-internet-modal {
            background: var(--dark);
            padding: 15px;
            border-radius: var(--border-radius);
            width: 100%;
            max-width: 300px;
            box-shadow: var(--card-shadow);
            text-align: center;
            border: 1px solid var(--card-border);
            animation: modalSlideIn 0.4s ease-out;
        }

        .no-internet-icon {
            font-size: 2rem;
            margin-bottom: 10px;
            color: var(--accent);
        }

        /* ===== CONTACT LINKS SCREEN STYLES ===== */
        .contact-links-screen {
            background: var(--card-bg);
            backdrop-filter: blur(10px);
            border-radius: var(--border-radius);
            padding: 12px;
            margin-bottom: 12px;
            box-shadow: var(--card-shadow);
            border: 1px solid var(--card-border);
            transition: var(--transition);
            font-size: 8px;
        }

        .contact-links-screen:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
        }

        .contact-link-screen-item {
            background: rgba(255, 255, 255, 0.05);
            margin-bottom: 8px;
            padding: 10px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: var(--transition);
            border-left: 3px solid transparent;
            position: relative;
            overflow: hidden;
            min-height: 50px;
            font-size: 9px;
        }

        .contact-link-screen-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent);
            transition: var(--transition-slow);
        }

        .contact-link-screen-item:hover::before {
            left: 100%;
        }

        .contact-link-screen-item:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateX(4px);
            border-left-color: var(--accent);
        }

        .contact-link-screen-icon {
            font-size: 1rem;
            width: 30px;
            text-align: center;
        }

        .contact-link-screen-info {
            flex: 1;
        }

        .contact-link-screen-name {
            font-weight: 600;
            margin-bottom: 3px;
            font-size: 9px;
        }

        .contact-link-screen-type {
            font-size: 8px;
            opacity: 0.8;
        }

        .contact-link-screen-btn {
            padding: 6px 8px;
            border-radius: 15px;
            text-decoration: none;
            color: white;
            font-weight: 600;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: 8px;
            min-height: 28px;
        }

        .facebook-screen-btn {
            background: #1877F2;
        }

        .telegram-screen-btn {
            background: #0088cc;
        }

        .viber-screen-btn {
            background: #7360F2;
        }

        .other-screen-btn {
            background: var(--primary);
        }

        .contact-link-screen-btn:hover {
            transform: translateY(-3px);
        }

        /* ===== DIGITAL BACKGROUND ELEMENTS - ENHANCED ===== */
        .digital-bg {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(circle at 20% 80%, rgba(255, 153, 0, 0.25) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(255, 204, 0, 0.25) 0%, transparent 50%),
                radial-gradient(circle at 40% 40%, rgba(255, 85, 0, 0.25) 0%, transparent 50%),
                linear-gradient(45deg, transparent 30%, rgba(255, 153, 0, 0.1) 50%, transparent 70%);
            z-index: -1;
            animation: bgPulse 10s infinite alternate;
        }

        .digital-grid {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: 
                linear-gradient(rgba(255, 153, 0, 0.1) 1px, transparent 1px),
                linear-gradient(90deg, rgba(255, 153, 0, 0.1) 1px, transparent 1px),
                linear-gradient(rgba(255, 204, 0, 0.05) 1px, transparent 1px),
                linear-gradient(90deg, rgba(255, 204, 0, 0.05) 1px, transparent 1px);
            background-size: 50px 50px, 50px 50px, 20px 20px, 20px 20px;
            z-index: -1;
            opacity: 0.8;
            animation: gridMove 20s linear infinite;
        }

        .digital-particles {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            overflow: hidden;
        }

        .particle {
            position: absolute;
            background: radial-gradient(circle, rgba(255, 204, 0, 0.8) 0%, rgba(255, 153, 0, 0.4) 50%, transparent 70%);
            border-radius: 50%;
            animation: float 15s infinite linear;
            filter: blur(1px);
        }

        .particle.sun {
            background: radial-gradient(circle, rgba(255, 255, 255, 0.9) 0%, rgba(255, 204, 0, 0.6) 30%, rgba(255, 153, 0, 0.3) 60%, transparent 80%);
            box-shadow: 0 0 20px rgba(255, 204, 0, 0.5);
        }

        @keyframes bgPulse {
            0% {
                opacity: 0.7;
                transform: scale(1);
            }
            100% {
                opacity: 1;
                transform: scale(1.02);
            }
        }

        @keyframes gridMove {
            0% {
                background-position: 0 0, 0 0, 0 0, 0 0;
            }
            100% {
                background-position: 50px 50px, 50px 50px, 20px 20px, 20px 20px;
            }
        }

        @keyframes float {
            0% {
                transform: translateY(100vh) translateX(0) rotate(0deg);
                opacity: 0;
            }
            10% {
                opacity: 1;
            }
            90% {
                opacity: 1;
            }
            100% {
                transform: translateY(-100px) translateX(100px) rotate(360deg);
                opacity: 0;
            }
        }

        /* ===== STYLE SELECTOR ===== */
        .style-selector {
            position: fixed;
            bottom: 10px;
            right: 10px;
            display: flex;
            gap: 6px;
            z-index: 1000;
        }

        .style-btn {
            padding: 6px 8px;
            border-radius: 15px;
            border: none;
            cursor: pointer;
            font-weight: 600;
            transition: var(--transition);
            font-size: 8px;
            min-height: 28px;
        }

        .normal-mode-btn {
            background: #4a6baf;
            color: white;
        }

        .digital-mode-btn {
            background: #ff9900;
            color: white;
            animation: buttonGlow 2s infinite alternate;
        }

        .dark-mode-btn {
            background: #6c5ce7;
            color: white;
        }

        .style-btn:hover {
            transform: translateY(-2px);
        }

        .style-btn.active {
            box-shadow: 0 0 8px rgba(255, 255, 255, 0.6);
        }

        @keyframes buttonGlow {
            0% {
                box-shadow: 0 0 5px rgba(255, 153, 0, 0.5);
            }
            100% {
                box-shadow: 0 0 15px rgba(255, 204, 0, 0.8);
            }
        }

        /* ===== ANIMATIONS ===== */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.02); }
            100% { transform: scale(1); }
        }

        @keyframes slideIn {
            from { transform: translateY(10px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        @keyframes modalSlideIn {
            from { transform: translateY(-20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        /* ===== LOADING ANIMATION ===== */
        .loading {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* ===== VIDEO QUALITY SELECTOR ===== */
        .quality-selector {
            position: absolute;
            bottom: 10px;
            left: 10px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            border: none;
            padding: 6px 8px;
            border-radius: 4px;
            cursor: pointer;
            z-index: 10;
            font-size: 8px;
            transition: var(--transition);
            min-height: 28px;
        }

        .quality-selector:hover {
            background: rgba(0, 0, 0, 0.9);
        }

        /* ===== VIDEO AUTO-PLAY ANIMATION ===== */
        .video-item.playing {
            animation: pulse 2s infinite;
            border-left-color: var(--accent);
        }

        /* ===== CONTACT LINK MANAGEMENT STYLES ===== */
        .contact-link-item {
            background: rgba(255, 255, 255, 0.05);
            margin-bottom: 8px;
            padding: 10px;
            border-radius: 6px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            border-left: 3px solid transparent;
            transition: var(--transition);
            position: relative;
            overflow: hidden;
            font-size: 8px;
        }

        .contact-link-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent);
            transition: var(--transition-slow);
        }

        .contact-link-item:hover::before {
            left: 100%;
        }

        .contact-link-item:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateX(3px);
        }

        .contact-link-info {
            flex: 1;
        }

        .contact-link-actions {
            display: flex;
            gap: 6px;
        }

        .contact-link-item.free {
            border-left-color: var(--success);
        }

        .contact-link-item.password-protected {
            border-left-color: var(--warning);
        }

        .contact-link-badge {
            display: inline-block;
            padding: 4px 6px;
            border-radius: 10px;
            font-size: 7px;
            margin-left: 6px;
            background: var(--success);
            color: white;
            font-weight: 600;
        }

        .contact-link-badge.password {
            background: var(--warning);
        }

        /* ===== SYSTEM INFO SCREEN STYLES ===== */
        .system-info-container {
            background: var(--card-bg);
            backdrop-filter: blur(10px);
            border-radius: var(--border-radius);
            padding: 12px;
            margin-bottom: 12px;
            box-shadow: var(--card-shadow);
            border: 1px solid var(--card-border);
        }

        .system-info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 8px;
            margin-bottom: 12px;
        }

        .system-info-card {
            background: rgba(255, 255, 255, 0.05);
            padding: 10px;
            border-radius: 6px;
            border-left: 3px solid var(--primary);
        }

        .system-info-title {
            font-size: 9px;
            margin-bottom: 8px;
            color: var(--light);
            font-weight: 600;
        }

        .system-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 8px;
            margin-top: 10px;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.05);
            padding: 8px;
            border-radius: 6px;
            text-align: center;
        }

        .stat-number {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--primary);
            margin-bottom: 3px;
        }

        .stat-label {
            font-size: 8px;
            opacity: 0.8;
        }

        /* ===== FIREBASE INFO STYLES ===== */
        .firebase-info {
            background: rgba(255, 153, 0, 0.1);
            padding: 10px;
            border-radius: 6px;
            margin-top: 10px;
            border: 1px solid rgba(255, 153, 0, 0.3);
        }

        .firebase-info-title {
            font-size: 9px;
            margin-bottom: 8px;
            color: var(--light);
            font-weight: 600;
            text-align: center;
        }

        .firebase-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 8px;
        }

        .firebase-stat {
            background: rgba(0, 0, 0, 0.1);
            padding: 8px;
            border-radius: 4px;
            font-size: 8px;
        }

        /* ===== RESPONSIVE DESIGN ===== */
        @media (min-width: 768px) {
            .container {
                padding: 15px;
            }
            
            .screen {
                padding: 15px;
            }
            
            .header {
                flex-direction: row;
                justify-content: space-between;
                text-align: left;
            }
            
            .site-title {
                font-size: 1.5rem;
                margin-bottom: 0;
                text-align: left;
            }
            
            .admin-login-btn {
                width: auto;
            }
            
            .video-section {
                flex-direction: row;
            }
            
            .main-video-container {
                flex: 2;
            }
            
            .video-list-container {
                flex: 1;
            }
            
            .btn-group {
                flex-direction: row;
                justify-content: space-between;
            }
            
            .nav-btn {
                width: auto;
            }
            
            .video-source-form {
                flex-direction: row;
            }
            
            .user-item, .video-admin-item {
                flex-direction: row;
                align-items: flex-start;
            }
            
            .user-actions, .video-admin-actions {
                flex-direction: column;
            }
            
            .password-generation-container {
                flex-direction: row;
            }
            
            .generated-passwords {
                flex: 1;
            }
            
            .contact-links {
                flex-direction: row;
            }

            .toolbar {
                flex-wrap: nowrap;
            }
            
            .text-selection-toolbar {
                flex-wrap: nowrap;
            }
            
            .bar-config-group {
                flex-direction: row;
            }

            .video-order-controls {
                flex-direction: row;
                margin-top: 0;
                margin-left: 10px;
            }

            .story-list {
                justify-content: flex-start;
            }
            
            .top-bar {
                flex-direction: row;
                align-items: flex-start;
            }
            
            .top-bar-left {
                flex: 0 0 200px;
            }

            .story-password-row {
                flex-direction: row;
                align-items: flex-start;
                justify-content: flex-end;
            }
        }

        @media (min-width: 992px) {
            .container {
                padding: 20px;
            }
        }

        /* ===== PASSWORD MANAGEMENT ENHANCED STYLES ===== */
        .password-management-section {
            background: var(--card-bg);
            border-radius: var(--border-radius);
            padding: 12px;
            margin-bottom: 15px;
            border: 1px solid var(--card-border);
        }

        .password-filter-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 12px;
        }

        .password-filter-btn {
            padding: 6px 10px;
            border-radius: 4px;
            border: 1px solid var(--card-border);
            background: rgba(255, 255, 255, 0.1);
            color: var(--light);
            cursor: pointer;
            font-size: 8px;
            transition: var(--transition);
            min-height: 28px;
        }

        .password-filter-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .password-filter-btn.active {
            background: var(--primary);
            color: white;
        }

        .password-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 8px;
            margin-bottom: 12px;
        }

        .password-stat-item {
            background: rgba(255, 255, 255, 0.05);
            padding: 8px;
            border-radius: 4px;
            text-align: center;
        }

        .password-stat-number {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--primary);
        }

        .password-stat-label {
            font-size: 8px;
            opacity: 0.8;
        }

        .password-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 12px;
        }

        .password-action-btn {
            padding: 8px 12px;
            border-radius: 4px;
            border: none;
            background: var(--secondary);
            color: white;
            cursor: pointer;
            font-size: 8px;
            font-weight: 600;
            transition: var(--transition);
            min-height: 32px;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .password-action-btn:hover {
            transform: translateY(-2px);
        }

        .password-action-btn.delete-used {
            background: var(--warning);
        }

        .password-action-btn.delete-unused {
            background: var(--danger);
        }

        .password-action-btn.delete-all {
            background: #9C27B0;
        }

        .password-list-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            padding: 8px;
            background: rgba(0, 0, 0, 0.1);
            border-radius: 4px;
        }

        .password-header-item {
            font-weight: 600;
            font-size: 9px;
            flex: 1;
            text-align: center;
        }

        .password-list-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            transition: var(--transition);
        }

        .password-list-item:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .password-list-cell {
            flex: 1;
            text-align: center;
            font-size: 8px;
            padding: 4px;
        }

        .password-status-badge {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 7px;
            font-weight: 600;
        }

        .password-status-used {
            background: var(--success);
            color: white;
        }

        .password-status-unused {
            background: var(--warning);
            color: white;
        }

        .password-status-offline {
            background: var(--gray);
            color: white;
        }

        .password-status-online {
            background: var(--primary);
            color: white;
        }

        .password-edit-input {
            width: 100%;
            padding: 4px;
            border: 1px solid var(--card-border);
            border-radius: 3px;
            background: rgba(0, 0, 0, 0.2);
            color: var(--light);
            font-size: 8px;
        }

        .password-list-actions {
            display: flex;
            gap: 4px;
        }

        .password-action-icon {
            padding: 4px 6px;
            border-radius: 3px;
            border: none;
            background: rgba(255, 255, 255, 0.1);
            color: var(--light);
            cursor: pointer;
            font-size: 8px;
            transition: var(--transition);
        }

        .password-action-icon:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .password-action-icon.edit {
            background: var(--primary);
        }

        .password-action-icon.delete {
            background: var(--danger);
        }

        .password-action-icon.save {
            background: var(--success);
        }

        .password-action-icon.cancel {
            background: var(--warning);
        }

        .story-passwords-section {
            margin-bottom: 20px;
        }

        .story-passwords-title {
            font-size: 10px;
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--light);
            padding: 8px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 4px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .story-passwords-count {
            background: var(--primary);
            color: white;
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 8px;
        }

        .password-print-options {
            display: flex;
            gap: 8px;
            margin-top: 12px;
        }

        .print-option-btn {
            padding: 6px 10px;
            border-radius: 4px;
            border: none;
            background: #2196F3;
            color: white;
            cursor: pointer;
            font-size: 8px;
            font-weight: 600;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .print-option-btn:hover {
            transform: translateY(-2px);
        }

        .print-option-btn.txt {
            background: #4CAF50;
        }

        .print-option-btn.pdf {
            background: #f44336;
        }

        /* Password generation modal */
        .password-generation-modal {
            max-width: 500px;
        }

        .password-name-input {
            margin-bottom: 10px;
        }

        .password-preview {
            background: rgba(0, 0, 0, 0.2);
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            font-family: monospace;
            text-align: center;
        }

        .password-preview-item {
            padding: 6px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .password-range-input {
            display: flex;
            gap: 8px;
            align-items: center;
            margin-bottom: 10px;
        }

        .range-value {
            font-weight: 600;
            color: var(--primary);
        }

        /* NEW: MONTHLY PASSWORD STYLES ===== */
        .monthly-password-section {
            background: var(--card-bg);
            border-radius: var(--border-radius);
            padding: 12px;
            margin-bottom: 15px;
            border: 1px solid var(--card-border);
        }

        .monthly-password-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .duration-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .duration-item {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 6px;
            padding: 10px;
            border-left: 3px solid var(--primary);
        }

        .duration-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            font-weight: 600;
        }

        .duration-passwords {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 6px;
        }

        .duration-password {
            background: rgba(0, 0, 0, 0.2);
            padding: 6px;
            border-radius: 4px;
            font-family: monospace;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .duration-actions {
            display: flex;
            gap: 4px;
        }

        /* NEW: DEVICE INFO STYLES ===== */
        .device-info-section {
            background: var(--card-bg);
            border-radius: var(--border-radius);
            padding: 12px;
            margin-top: 20px;
            border: 1px solid var(--card-border);
        }

        .device-info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 8px;
        }

        .device-stat-card {
            background: rgba(255, 255, 255, 0.05);
            padding: 10px;
            border-radius: 6px;
        }

        .device-stat-number {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--primary);
        }

        .device-stat-label {
            font-size: 8px;
            opacity: 0.8;
        }

        .device-list-container {
            margin-top: 12px;
        }

        .device-list-item {
            background: rgba(0, 0, 0, 0.1);
            margin-bottom: 6px;
            padding: 8px;
            border-radius: 4px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .device-info-text {
            font-size: 8px;
        }

        .device-status-badge {
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 7px;
            font-weight: 600;
        }

        .device-online {
            background: var(--success);
            color: white;
        }

        .device-offline {
            background: var(--danger);
            color: white;
        }

        /* ===== NEW STYLES FOR VIDEO MANAGEMENT ===== */
        /* Downloadable badge */
        .downloadable-badge {
            display: inline-block;
            background: var(--success);
            color: white;
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 7px;
            margin-left: 6px;
            font-weight: 600;
        }

        /* Video sorting controls */
        .video-sorting-controls {
            margin-bottom: 15px;
        }

        .sort-btn {
            padding: 6px 10px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 8px;
            cursor: pointer;
            transition: var(--transition);
        }

        .sort-btn:hover {
            background: var(--secondary);
            transform: translateY(-2px);
        }

        /* Video library sorting */
        .video-library-sorting {
            margin-bottom: 15px;
        }

        .lib-sort-btn {
            padding: 6px 10px;
            background: rgba(255, 255, 255, 0.1);
            color: var(--light);
            border: 1px solid var(--card-border);
            border-radius: 4px;
            font-size: 8px;
            cursor: pointer;
            transition: var(--transition);
        }

        .lib-sort-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .lib-sort-btn.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        /* Story headers in video library */
        .story-header {
            background: var(--primary);
            color: white;
            padding: 8px;
            margin: 10px 0 5px 0;
            border-radius: 4px;
            font-weight: 600;
            font-size: 9px;
        }

        /* Downloadable video items */
        .video-item.downloadable {
            border-left-color: var(--success);
            background: rgba(0, 255, 204, 0.05);
        }

        .video-item.downloadable:hover {
            background: rgba(0, 255, 204, 0.1);
        }

        .video-item.downloaded {
            border-left-color: var(--accent);
            background: rgba(255, 204, 0, 0.05);
        }

        .video-item.downloaded:hover {
            background: rgba(255, 204, 0, 0.1);
        }

        /* Downloaded videos section */
        .downloaded-videos-section {
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid var(--card-border);
        }

        /* Download toggle container */
        .download-toggle-container {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .download-toggle {
            width: 16px;
            height: 16px;
            cursor: pointer;
        }

        /* Storage quota warning */
        .storage-warning {
            background: rgba(255, 153, 0, 0.1);
            border: 1px solid var(--warning);
            border-radius: 6px;
            padding: 10px;
            margin: 10px 0;
            font-size: 8px;
        }

        .storage-warning i {
            color: var(--warning);
            margin-right: 6px;
        }

        /* Offline indicator */
        .offline-indicator {
            position: fixed;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--warning);
            color: white;
            padding: 6px 12px;
            border-radius: 15px;
            font-size: 8px;
            z-index: 1001;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        /* Enhanced video item styles */
        .video-item .download-video-btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 4px;
            transition: var(--transition);
            min-height: 24px;
        }

        .video-item .download-video-btn:hover {
            transform: translateY(-2px);
        }

        .video-item .download-video-btn.downloaded {
            background: var(--success);
        }

        .video-item .download-video-btn i {
            font-size: 8px;
        }

        /* Download progress indicator */
        .download-progress {
            width: 100%;
            height: 4px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 2px;
            margin-top: 4px;
            overflow: hidden;
        }

        .download-progress-bar {
            height: 100%;
            background: var(--primary);
            transition: width 0.3s ease;
        }

        /* NEW: Downloaded video edit/delete buttons styles */
        .downloaded-video-actions {
            display: flex;
            gap: 4px;
            margin-top: 6px;
        }

        .downloaded-edit-btn, .downloaded-delete-btn {
            padding: 4px 8px;
            border-radius: 4px;
            border: none;
            font-size: 7px;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 3px;
            min-height: 22px;
        }

        .downloaded-edit-btn {
            background: var(--primary);
            color: white;
        }

        .downloaded-delete-btn {
            background: var(--danger);
            color: white;
        }

        .downloaded-edit-btn:hover, .downloaded-delete-btn:hover {
            transform: translateY(-2px);
        }

        /* Downloaded video edit modal */
        .edit-downloaded-modal {
            max-width: 400px;
        }

        .edit-downloaded-form {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        /* ===== NEW: CUSTOM IMAGE UPLOAD SECTION ===== */
        .custom-image-upload-section {
            background: var(--card-bg);
            backdrop-filter: blur(10px);
            border-radius: var(--border-radius);
            padding: 12px;
            margin-bottom: 15px;
            border: 1px solid var(--card-border);
            margin-top: 15px;
        }
        
        .custom-image-input-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-bottom: 10px;
        }
        
        .current-image-display {
            width: 100%;
            max-width: 300px;
            margin: 0 auto;
            text-align: center;
        }
        
        .current-image-display img {
            width: 100%;
            height: auto;
            border-radius: var(--border-radius);
            margin-bottom: 8px;
            border: 2px solid var(--card-border);
        }
        
        .image-url-display {
            font-size: 8px;
            word-break: break-all;
            background: rgba(0, 0, 0, 0.1);
            padding: 6px;
            border-radius: 4px;
            margin-top: 8px;
        }
    </style>
</head>
<body class="digital-mode">
    <!-- Digital background elements - only show in digital mode -->
    <div class="digital-bg"></div>
    <div class="digital-grid"></div>
    <div class="digital-particles" id="particles"></div>
    
    <!-- Password Timer Display -->
    <div id="passwordTimerDisplay" class="password-timer-display" style="display: none;">
        <i class="fas fa-clock"></i> <span id="timerText">Password expires in: --:--:--</span>
    </div>
    
    <!-- Footer -->
    <div class="app-footer">Created by // M-Sinwa</div>
    
    <!-- Connection Status Indicator -->
    <div id="connectionStatus" class="connection-status online-status-badge" style="display: none;">
        <i class="fas fa-wifi"></i> Online
    </div>

    <!-- Style Selector -->
    <div class="style-selector">
        <button class="style-btn normal-mode-btn" id="normalModeBtn">Normal</button>
        <button class="style-btn digital-mode-btn active" id="digitalModeBtn">Digital</button>
        <button class="style-btn dark-mode-btn" id="darkModeBtn">Dark</button>
    </div>

    <!-- No Internet Connection Modal -->
    <div id="noInternetModal" class="modal">
        <div class="no-internet-modal">
            <div class="no-internet-icon"><i class="fas fa-wifi-slash"></i></div>
            <h2 class="modal-title">No Internet Connection</h2>
            <p>You are currently offline. Some features may be limited.</p>
            <div class="btn-group" style="margin-top: 15px;">
                <button id="continueOfflineBtn" class="nav-btn"><i class="fas fa-play-circle"></i> Continue Offline</button>
            </div>
        </div>
    </div>

    <!-- Login Modal -->
    <div id="loginModal" class="modal">
        <div class="modal-content">
            <span class="close-modal" id="closeModal"><i class="fas fa-times"></i></span>
            <h2 class="modal-title">Admin Login</h2>
            <div class="form-group">
                <label class="form-label">User Name</label>
                <input type="text" id="adminUsername" class="form-input" placeholder="Enter username">
            </div>
            <div class="form-group">
                <label class="form-label">Password</label>
                <input type="password" id="adminPassword" class="form-input" placeholder="Enter password">
            </div>
            <button id="loginBtn" class="submit-btn"><i class="fas fa-sign-in-alt"></i> Login</button>
            <p id="loginMessage" style="text-align: center; margin-top: 15px;"></p>
        </div>
    </div>

    <!-- Password Generation Modal -->
    <div id="passwordGenerationModal" class="modal">
        <div class="modal-content password-generation-modal">
            <span class="close-modal" id="closePasswordModal"><i class="fas fa-times"></i></span>
            <h2 class="modal-title">Generate Passwords</h2>
            <div class="form-group">
                <label class="form-label">Story Name</label>
                <select id="modalStoryName" class="form-input">
                    <option value="">Select Story</option>
                </select>
            </div>
            <div class="form-group">
                <label class="form-label">Name Prefix</label>
                <input type="text" id="passwordNamePrefix" class="form-input" placeholder="Enter name (optional)">
            </div>
            <div class="form-group">
                <label class="form-label">Number of Passwords (1-100)</label>
                <div class="password-range-input">
                    <input type="range" id="passwordRange" class="form-input" min="1" max="100" value="10" style="flex: 1;">
                    <span id="rangeValue" class="range-value">10</span>
                </div>
                <input type="number" id="modalPasswordCount" class="form-input" min="1" max="100" value="10">
            </div>
            <div id="passwordPreview" class="password-preview">
                <h4>Password Preview</h4>
                <div id="previewList"></div>
            </div>
            <button id="generateModalPasswordsBtn" class="submit-btn"><i class="fas fa-key"></i> Generate Passwords</button>
        </div>
    </div>

    <!-- NEW: Monthly Password Generation Modal -->
    <div id="monthlyPasswordModal" class="modal">
        <div class="modal-content password-generation-modal">
            <span class="close-modal" id="closeMonthlyPasswordModal"><i class="fas fa-times"></i></span>
            <h2 class="modal-title">Generate Monthly Passwords</h2>
            <div class="form-group">
                <label class="form-label">Select Story (Optional)</label>
                <select id="monthlyStoryName" class="form-input">
                    <option value="">All Stories (Global Access)</option>
                </select>
            </div>
            <div class="form-group">
                <label class="form-label">Duration</label>
                <select id="monthlyDuration" class="form-input">
                    <option value="1">1 Month</option>
                    <option value="2">2 Months</option>
                    <option value="3">3 Months</option>
                    <option value="4">4 Months</option>
                    <option value="5">5 Months</option>
                    <option value="6">6 Months</option>
                    <option value="7">7 Months</option>
                    <option value="8">8 Months</option>
                    <option value="9">9 Months</option>
                    <option value="10">10 Months</option>
                    <option value="11">11 Months</option>
                    <option value="12">12 Months</option>
                </select>
            </div>
            <div class="form-group">
                <label class="form-label">Number of Passwords per Duration (1-20)</label>
                <input type="number" id="monthlyPasswordCount" class="form-input" value="5" min="1" max="20">
            </div>
            <div id="monthlyPasswordPreview" class="password-preview">
                <h4>Password Preview</h4>
                <div id="monthlyPreviewList"></div>
            </div>
            <button id="generateMonthlyPasswordsBtn" class="submit-btn"><i class="fas fa-calendar-alt"></i> Generate Monthly Passwords</button>
        </div>
    </div>

    <!-- NEW: Edit Downloaded Video Modal -->
    <div id="editDownloadedModal" class="modal">
        <div class="modal-content edit-downloaded-modal">
            <span class="close-modal" id="closeEditDownloadedModal"><i class="fas fa-times"></i></span>
            <h2 class="modal-title">Edit Downloaded Video</h2>
            <div class="edit-downloaded-form">
                <div class="form-group">
                    <label class="form-label">Video Name</label>
                    <input type="text" id="editDownloadedName" class="form-input" placeholder="Enter new video name">
                </div>
                <div class="form-group">
                    <label class="form-label">Story Name</label>
                    <input type="text" id="editDownloadedStory" class="form-input" placeholder="Enter story name (optional)">
                </div>
                <div class="form-group">
                    <label class="form-label">Video Type</label>
                    <select id="editDownloadedType" class="form-input">
                        <option value="cloudinary">Cloudinary</option>
                        <option value="youtube">YouTube</option>
                        <option value="telegram">Telegram</option>
                        <option value="hls">HLS Stream</option>
                        <option value="mp4">MP4 Video</option>
                        <option value="other">Other</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Notes (Optional)</label>
                    <textarea id="editDownloadedNotes" class="form-textarea" placeholder="Add any notes about this video" rows="3"></textarea>
                </div>
                <button id="saveDownloadedEditBtn" class="submit-btn"><i class="fas fa-save"></i> Save Changes</button>
            </div>
        </div>
    </div>

    <!-- Screen 1: Main Video Screen -->
    <div id="screen1" class="screen active">
        <div class="container">
            <div class="back-btn-container">
                <button class="back-btn" style="display: none;"><i class="fas fa-arrow-left"></i> Back</button>
            </div>
            
            <!-- Top Bar with Logo and Password Sections -->
            <div class="top-bar">
                <!-- Left side: Logo and Global Video Access -->
                <div class="top-bar-left">
                    <!-- 3D Kachin Visions Empire Logo - Top Left -->
                    <div class="logo-container">
                        <div class="kachin-visions-logo">
                            <span class="kachin">Kachin</span>
                            <span class="visions"> Visions Empire</span>
                        </div>
                    </div>

                    <!-- Global Video Access Section -->
                    <div class="compact-password-section" id="compactPasswordSection">
                        <h2 class="form-title"><i class="fas fa-lock"></i> Global Video Access</h2>
                        <div class="form-group">
                            <input type="password" id="password" class="form-input" placeholder="Enter your password">
                        </div>
                        <button id="unlockVideosBtn" class="submit-btn"><i class="fas fa-unlock"></i> Unlock All Video</button>
                        <p id="loginStatus" class="login-status">Please enter your password to unlock all videos</p>
                    </div>
                </div>

                <!-- NEW: Story and Password Row -->
                <div class="story-password-row">
                    <!-- Story Collection Menu -->
                    <div class="story-collection-menu">
                        <div class="story-menu-toggle" id="storyMenuToggle">
                            <i class="fas fa-film"></i> Story
                        </div>
                        <div id="storyMenu" class="story-menu">
                            <h3 class="story-menu-title">Story</h3>
                            <div id="storyList" class="story-list">
                                <!-- Story items will be dynamically added here -->
                            </div>
                        </div>
                    </div>

                    <!-- Story Password Section -->
                    <div id="storyPasswordSection" class="story-password-section">
                        <h3 class="form-title" id="currentStoryTitle">Enter Password for <span id="selectedStoryName"></span></h3>
                        <div class="form-group">
                            <input type="password" id="storyPassword" class="form-input" placeholder="Enter story password">
                        </div>
                        <button id="unlockStoryBtn" class="submit-btn"><i class="fas fa-unlock"></i> Unlock Story</button>
                        <p id="storyPasswordStatus" class="login-status"></p>
                    </div>
                </div>
            </div>

            <div class="video-section">
                <div class="main-video-container">
                    <div id="mainVideoPlayer" class="video-player">
                        <div class="video-player-wrapper">
                            <div id="topBlackBar" class="black-bars top-bar" style="height: 0px;"></div>
                            <div class="video-content">
                                <!-- Video player will be dynamically set here -->
                                <video id="mainVideoElement" controls autoplay muted loop controlsList="nodownload noremoteplayback" style="width: 100%; height: 100%; object-fit: contain;" oncontextmenu="return false;">
                                    Your browser does not support the video tag.
                                </video>
                            </div>
                            <div id="bottomBlackBar" class="black-bars bottom-bar" style="height: 0px;"></div>
                        </div>
                    </div>
                    <select id="qualitySelector" class="quality-selector" style="display: none;">
                        <option value="auto">Auto Quality</option>
                        <option value="high">High Quality</option>
                        <option value="medium">Medium Quality</option>
                        <option value="low">Low Quality</option>
                    </select>
                </div>
                <div class="video-list-container">
                    <h3 class="video-list-title"><i class="fas fa-film"></i> Video Library</h3>
                    
                    <div id="videoList" class="video-list">
                        <!-- Video items will be dynamically added here -->
                    </div>
                    
                    <!-- Admin Message Section -->
                    <div class="admin-message-container">
                        <h2 class="admin-message-title"><i class="fas fa-bullhorn"></i> Admin Announcements</h2>
                        <div id="adminMessageContent" class="admin-message-content">
                            <!-- Admin message will be displayed here -->
                        </div>
                    </div>

                    <!-- Downloaded Videos Section -->
                    <div class="downloaded-videos-section" id="downloadedVideosSection" style="display: none;">
                        <h3 class="video-list-title"><i class="fas fa-download"></i> Downloaded Videos (Offline)</h3>
                        <div id="downloadedVideosList" class="video-list">
                            <!-- Downloaded videos will appear here -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Old Movie Stories Button (Changed from Contact Links) -->
            <div class="btn-group">
                <button id="showContactLinksScreen" class="nav-btn"><i class="fas fa-film"></i> Old Movie Stories</button>
            </div>

            <div class="btn-group">
                <button id="adminLoginBtn" class="admin-login-btn"><i class="fas fa-user-shield"></i> Admin Login</button>
            </div>
        </div>
    </div>

    <!-- Screen 2: Admin Video Management -->
    <div id="screen2" class="screen">
        <div class="container">
            <div class="back-btn-container">
                <button id="backToScreen1" class="back-btn"><i class="fas fa-arrow-left"></i> Back</button>
            </div>
            
            <!-- Top Bar with Logo -->
            <div class="top-bar">
                <!-- Left side: Logo -->
                <div class="top-bar-left">
                    <!-- 3D Kachin Visions Empire Logo - Top Left -->
                    <div class="logo-container">
                        <div class="kachin-visions-logo">
                            <span class="kachin">Kachin</span>
                            <span class="visions"> Visions Empire</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Admin Message Management -->
            <div class="admin-section">
                <h2 class="admin-title"><i class="fas fa-comment-alt"></i> Admin Message Management</h2>
                
                <!-- Rich Text Editor -->
                <div class="rich-text-editor">
                    <div class="toolbar">
                        <div class="toolbar-group">
                            <button class="toolbar-btn" data-command="bold" title="Bold"><i class="fas fa-bold"></i></button>
                            <button class="toolbar-btn" data-command="italic" title="Italic"><i class="fas fa-italic"></i></button>
                            <button class="toolbar-btn" data-command="underline" title="Underline"><i class="fas fa-underline"></i></button>
                        </div>
                        
                        <div class="toolbar-group">
                            <select class="toolbar-select" id="fontFamily">
                                <option value="">Font Family</option>
                                <option value="Arial, sans-serif">Arial</option>
                                <option value="'Times New Roman', serif">Times New Roman</option>
                                <option value="'Courier New', monospace">Courier New</option>
                                <option value="Georgia, serif">Georgia</option>
                                <option value="Verdana, sans-serif">Verdana</option>
                                <option value="'Trebuchet MS', sans-serif">Trebuchet MS</option>
                            </select>
                            
                            <select class="toolbar-select" id="fontSize">
                                <option value="">Size</option>
                                <option value="8px">Small</option>
                                <option value="9px">Normal</option>
                                <option value="10px">Medium</option>
                                <option value="12px">Large</option>
                            </select>
                        </div>
                        
                        <div class="toolbar-group">
                            <button class="toolbar-btn" data-command="justifyLeft" title="Align Left"><i class="fas fa-align-left"></i></button>
                            <button class="toolbar-btn" data-command="justifyCenter" title="Align Center"><i class="fas fa-align-center"></i></button>
                            <button class="toolbar-btn" data-command="justifyRight" title="Align Right"><i class="fas fa-align-right"></i></button>
                            <button class="toolbar-btn" data-command="justifyFull" title="Justify"><i class="fas fa-align-justify"></i></button>
                        </div>
                        
                        <div class="toolbar-group">
                            <button class="toolbar-btn" data-command="insertUnorderedList" title="Bullet List"><i class="fas fa-list-ul"></i></button>
                            <button class="toolbar-btn" data-command="insertOrderedList" title="Numbered List"><i class="fas fa-list-ol"></i></button>
                        </div>
                        
                        <div class="toolbar-group">
                            <input type="color" class="toolbar-color" id="textColor" title="Text Color" value="#000000">
                            <input type="color" class="toolbar-color" id="backgroundColor" title="Background Color" value="#ffffff">
                        </div>
                    </div>
                    
                    <div id="adminMessageEditor" class="editor-content" contenteditable="true">
                        <!-- Rich text editor content -->
                    </div>
                </div>
                
                <button id="saveAdminMessage" class="submit-btn"><i class="fas fa-save"></i> Save Admin Message</button>
            </div>

            <div class="admin-section">
                <h2 class="admin-title"><i class="fas fa-plus-circle"></i> Add Video Sources</h2>
                
                <div class="video-source-form">
                    <input type="text" id="storyName" class="source-input" placeholder="Story Name">
                    <input type="text" id="videoName" class="source-input" placeholder="Video Display Name">
                    <input type="text" id="cloudinaryUrl" class="source-input" placeholder="Cloudinary URL">
                    <select id="cloudinaryPasswordType" class="source-input">
                        <option value="free">Free Video (No Password)</option>
                        <option value="password">Password Protected</option>
                    </select>
                    <button id="addCloudinaryBtn" class="add-btn"><i class="fas fa-cloud-upload-alt"></i> Add Cloudinary Video</button>
                </div>

                <div class="video-source-form">
                    <input type="text" id="youtubeUrl" class="source-input" placeholder="YouTube Video URL">
                    <select id="youtubePasswordType" class="source-input">
                        <option value="free">Free Video (No Password)</option>
                        <option value="password">Password Protected</option>
                    </select>
                    <button id="addYoutubeBtn" class="add-btn"><i class="fab fa-youtube"></i> Add YouTube Video</button>
                </div>

                <div class="video-source-form">
                    <input type="text" id="telegramUrl" class="source-input" placeholder="Telegram Video URL">
                    <select id="telegramPasswordType" class="source-input">
                        <option value="free">Free Video (No Password)</option>
                        <option value="password">Password Protected</option>
                    </select>
                    <button id="addTelegramBtn" class="add-btn"><i class="fab fa-telegram"></i> Add Telegram Video</button>
                </div>

                <div class="video-source-form">
                    <input type="text" id="hlsUrl" class="source-input" placeholder="HLS Stream URL (.m3u8)">
                    <select id="hlsPasswordType" class="source-input">
                        <option value="free">Free Video (No Password)</option>
                        <option value="password">Password Protected</option>
                    </select>
                    <button id="addHlsBtn" class="add-btn"><i class="fas fa-stream"></i> Add HLS Stream</button>
                </div>
            </div>

            <!-- Contact Links Management Section -->
            <div class="admin-section">
                <h2 class="admin-title"><i class="fas fa-address-book"></i> Manage Contact Links</h2>
                
                <div class="video-source-form">
                    <input type="text" id="contactLinkUrl" class="source-input" placeholder="Contact Link URL">
                    <input type="text" id="contactLinkName" class="source-input" placeholder="Display Name">
                    <select id="contactLinkStory" class="source-input">
                        <option value="">Select Story (Optional)</option>
                        <!-- Story options will be populated dynamically -->
                    </select>
                    <select id="contactLinkType" class="source-input">
                        <option value="facebook">Facebook</option>
                        <option value="telegram">Telegram</option>
                        <option value="viber">Viber</option>
                        <option value="other">Other</option>
                    </select>
                    <select id="contactLinkAccess" class="source-input">
                        <option value="free">Free Access (No Password)</option>
                        <option value="password">Password Protected</option>
                    </select>
                    <button id="addContactLinkBtn" class="add-btn"><i class="fas fa-plus"></i> Add Contact Link</button>
                </div>
                
                <div id="contactLinksAdminList" class="video-admin-list">
                    <!-- Contact link items will be dynamically added here -->
                </div>
            </div>

            <div class="admin-section">
                <h2 class="admin-title"><i class="fas fa-film"></i> Manage Existing Videos</h2>
                <div class="admin-controls">
                    <button id="saveVideoOrderBtn" class="add-btn" style="margin-bottom: 12px;"><i class="fas fa-save"></i> Save Video Order</button>
                </div>
                <div id="videoAdminList" class="video-admin-list">
                    <!-- Admin video items will be dynamically added here -->
                </div>
            </div>

            <div class="btn-group">
                <button id="nextToScreen3" class="nav-btn"><i class="fas fa-arrow-right"></i> Next Screen</button>
            </div>
        </div>
    </div>

    <!-- Screen 3: User Management -->
    <div id="screen3" class="screen">
        <div class="container">
            <div class="back-btn-container">
                <button id="backToScreen2" class="back-btn"><i class="fas fa-arrow-left"></i> Back</button>
            </div>
            
            <!-- Top Bar with Logo -->
            <div class="top-bar">
                <!-- Left side: Logo -->
                <div class="top-bar-left">
                    <!-- 3D Kachin Visions Empire Logo - Top Left -->
                    <div class="logo-container">
                        <div class="kachin-visions-logo">
                            <span class="kachin">Kachin</span>
                            <span class="visions"> Visions Empire</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- NEW: Monthly Password Generation Section -->
            <div class="monthly-password-section">
                <div class="monthly-password-header">
                    <h2 class="admin-title"><i class="fas fa-calendar-alt"></i> Monthly/Yearly Password Generator</h2>
                    <button id="openMonthlyPasswordModal" class="nav-btn" style="padding: 8px 12px;"><i class="fas fa-plus"></i> Generate</button>
                </div>
                
                <div class="duration-list" id="monthlyPasswordList">
                    <!-- Monthly passwords will be displayed here -->
                </div>
            </div>

            <!-- Enhanced Password Management Section -->
            <div class="password-management-section">
                <h2 class="admin-title"><i class="fas fa-key"></i> Enhanced Password Management</h2>
                
                <!-- Password Generation -->
                <div class="password-generation-container">
                    <div class="form-container" style="flex: 1;">
                        <h3 class="form-title">Generate Story Passwords</h3>
                        <div class="form-group">
                            <label class="form-label">Select Story</label>
                            <select id="passwordStory" class="form-input">
                                <option value="">Select Story</option>
                                <!-- Story options will be populated dynamically -->
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Number of Passwords to Generate (1-100)</label>
                            <input type="number" id="passwordCount" class="form-input" value="10" min="1" max="100">
                        </div>
                        <button id="generatePasswordBtn" class="submit-btn"><i class="fas fa-key"></i> Generate Passwords</button>
                        <button id="openAdvancedGenerationBtn" class="submit-btn" style="margin-top: 8px; background: var(--primary);"><i class="fas fa-cog"></i> Advanced Generation</button>
                    </div>
                    
                    <div class="generated-passwords" id="generatedPasswords">
                        <h4 style="margin-bottom: 10px; text-align: center;">Recently Generated Passwords</h4>
                        <!-- Generated passwords will appear here -->
                    </div>
                </div>

                <!-- Password Statistics -->
                <div class="password-stats">
                    <div class="password-stat-item">
                        <div class="password-stat-number" id="totalPasswords">0</div>
                        <div class="password-stat-label">Total Passwords</div>
                    </div>
                    <div class="password-stat-item">
                        <div class="password-stat-number" id="usedPasswords">0</div>
                        <div class="password-stat-label">Used Passwords</div>
                    </div>
                    <div class="password-stat-item">
                        <div class="password-stat-number" id="unusedPasswords">0</div>
                        <div class="password-stat-label">Unused Passwords</div>
                    </div>
                    <div class="password-stat-item">
                        <div class="password-stat-number" id="storyCount">0</div>
                        <div class="password-stat-label">Stories</div>
                    </div>
                </div>

                <!-- Password Filter Buttons -->
                <div class="password-filter-buttons">
                    <button class="password-filter-btn active" data-filter="all">All Passwords</button>
                    <button class="password-filter-btn" data-filter="used">Used Only</button>
                    <button class="password-filter-btn" data-filter="unused">Unused Only</button>
                    <button class="password-filter-btn" data-filter="online">Online</button>
                    <button class="password-filter-btn" data-filter="offline">Offline</button>
                </div>

                <!-- Password Actions -->
                <div class="password-actions">
                    <button id="deleteUsedPasswordsBtn" class="password-action-btn delete-used"><i class="fas fa-trash"></i> Delete Used Passwords</button>
                    <button id="deleteUnusedPasswordsBtn" class="password-action-btn delete-unused"><i class="fas fa-trash"></i> Delete Unused Passwords</button>
                    <button id="deleteAllPasswordsBtn" class="password-action-btn delete-all"><i class="fas fa-trash"></i> Delete All Passwords</button>
                </div>

                <!-- Search Bar -->
                <div class="search-container">
                    <input type="text" id="passwordSearch" class="search-input" placeholder="Search passwords by story name or password...">
                </div>

                <!-- Story-wise Password Lists -->
                <div id="storyPasswordsContainer">
                    <!-- Story password sections will be dynamically added here -->
                </div>
            </div>

            <!-- Export Section -->
            <div class="admin-section">
                <h2 class="admin-title"><i class="fas fa-file-export"></i> Export Passwords</h2>
                <div class="password-print-options">
                    <button id="exportStoryPasswordsTxtBtn" class="print-option-btn txt"><i class="fas fa-file-alt"></i> Export as TXT</button>
                    <button id="exportStoryPasswordsPdfBtn" class="print-option-btn pdf"><i class="fas fa-file-pdf"></i> Export as PDF</button>
                    <button id="exportAllPasswordsBtn" class="print-option-btn"><i class="fas fa-file-export"></i> Export All</button>
                </div>
            </div>

            <!-- NEW: Custom Image Upload Section -->
            <div class="custom-image-upload-section">
                <h2 class="admin-title"><i class="fas fa-image"></i> Custom Application Image</h2>
                <div class="custom-image-input-group">
                    <input type="text" id="customImageUrl" class="form-input" placeholder="Enter Cloudinary URL for application image" value="https://res.cloudinary.com/zaumaran/image/upload/v1764932924/Kachin_Vision_Empire_For_Logo_zpkdbg.png">
                    <button id="saveCustomImageBtn" class="submit-btn"><i class="fas fa-save"></i> Save Application Image</button>
                </div>
                <div class="current-image-display">
                    <img id="currentCustomImage" src="https://res.cloudinary.com/zaumaran/image/upload/v1764932924/Kachin_Vision_Empire_For_Logo_zpkdbg.png" alt="Current Application Image">
                    <div class="image-url-display" id="currentImageUrl">https://res.cloudinary.com/zaumaran/image/upload/v1764932924/Kachin_Vision_Empire_For_Logo_zpkdbg.png</div>
                </div>
            </div>

            <!-- NEW: Device Information Section -->
            <div class="device-info-section">
                <h2 class="admin-title"><i class="fas fa-mobile-alt"></i> Device Information & Statistics</h2>
                
                <div class="device-info-grid">
                    <div class="device-stat-card">
                        <div class="device-stat-number" id="totalDevices">0</div>
                        <div class="device-stat-label">Total Devices</div>
                    </div>
                    <div class="device-stat-card">
                        <div class="device-stat-number" id="onlineDevices">0</div>
                        <div class="device-stat-label">Online Devices</div>
                    </div>
                    <div class="device-stat-card">
                        <div class="device-stat-number" id="offlineDevices">0</div>
                        <div class="device-stat-label">Offline Devices</div>
                    </div>
                    <div class="device-stat-card">
                        <div class="device-stat-number" id="activePasswords">0</div>
                        <div class="device-stat-label">Active Passwords</div>
                    </div>
                </div>
                
                <div class="device-list-container" id="deviceListContainer">
                    <!-- Device list will be displayed here -->
                </div>
            </div>

            <div class="btn-group">
                <button id="nextToScreen4" class="nav-btn"><i class="fas fa-arrow-right"></i> Next Screen</button>
            </div>
        </div>
    </div>

    <!-- Screen 4: Contact Links Screen -->
    <div id="screen4" class="screen">
        <div class="container">
            <div class="back-btn-container">
                <button id="backToScreen1FromContacts" class="back-btn"><i class="fas fa-arrow-left"></i> Back</button>
            </div>
            
            <!-- Top Bar with Logo -->
            <div class="top-bar">
                <!-- Left side: Logo -->
                <div class="top-bar-left">
                    <!-- 3D Kachin Visions Empire Logo - Top Left -->
                    <div class="logo-container">
                        <div class="kachin-visions-logo">
                            <span class="kachin">Kachin</span>
                            <span class="visions"> Visions Empire</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="contact-links-screen">
                <h2 class="admin-title"><i class="fas fa-address-book"></i> Contact Links</h2>
                <div id="contactLinksScreenList">
                    <!-- Contact links will be displayed here in list format -->
                </div>
            </div>
        </div>
    </div>

    <script>
        // ============================================
        // FIREBASE CONFIGURATION
        // ============================================
        const firebaseConfig = {
            apiKey: "AIzaSyCJGR8dXeawpg6RNpF1iUC7TD65RWm-oxE",
            authDomain: "sun-day-video-production-298c8.firebaseapp.com",
            projectId: "sun-day-video-production-298c8",
            storageBucket: "sun-day-video-production-298c8.firebasestorage.app",
            messagingSenderId: "927333523323",
            appId: "1:927333523323:web:16375e95732c5acb4767de",
            measurementId: "G-ZY2Y2Y749H"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const rtdb = firebase.database();
        const storage = firebase.storage();

        // ============================================
        // DOM ELEMENTS
        // ============================================
        const screens = document.querySelectorAll('.screen');
        const screen1 = document.getElementById('screen1');
        const screen2 = document.getElementById('screen2');
        const screen3 = document.getElementById('screen3');
        const screen4 = document.getElementById('screen4');
        const adminLoginBtn = document.getElementById('adminLoginBtn');
        const loginModal = document.getElementById('loginModal');
        const closeModal = document.getElementById('closeModal');
        const loginBtn = document.getElementById('loginBtn');
        const loginMessage = document.getElementById('loginMessage');
        const backToScreen1 = document.getElementById('backToScreen1');
        const nextToScreen3 = document.getElementById('nextToScreen3');
        const nextToScreen4 = document.getElementById('nextToScreen4');
        const backToScreen2 = document.getElementById('backToScreen2');
        const backToScreen1FromContacts = document.getElementById('backToScreen1FromContacts');
        const unlockVideosBtn = document.getElementById('unlockVideosBtn');
        const videoList = document.getElementById('videoList');
        const mainVideoPlayer = document.getElementById('mainVideoPlayer');
        const mainVideoElement = document.getElementById('mainVideoElement');
        const generatePasswordBtn = document.getElementById('generatePasswordBtn');
        const passwordCount = document.getElementById('passwordCount');
        const generatedPasswords = document.getElementById('generatedPasswords');
        const loginStatus = document.getElementById('loginStatus');
        const videoAdminList = document.getElementById('videoAdminList');
        const exportStoryPasswordsTxtBtn = document.getElementById('exportStoryPasswordsTxtBtn');
        const exportStoryPasswordsPdfBtn = document.getElementById('exportStoryPasswordsPdfBtn');
        const contactLinksScreenList = document.getElementById('contactLinksScreenList');
        const passwordSearch = document.getElementById('passwordSearch');
        const connectionStatus = document.getElementById('connectionStatus');
        const saveAdminMessage = document.getElementById('saveAdminMessage');
        const adminMessageContent = document.getElementById('adminMessageContent');
        const saveVideoOrderBtn = document.getElementById('saveVideoOrderBtn');
        const noInternetModal = document.getElementById('noInternetModal');
        const continueOfflineBtn = document.getElementById('continueOfflineBtn');
        const showContactLinksScreen = document.getElementById('showContactLinksScreen');
        const qualitySelector = document.getElementById('qualitySelector');
        const downloadedVideosSection = document.getElementById('downloadedVideosSection');
        const downloadedVideosList = document.getElementById('downloadedVideosList');

        // Story Management Elements
        const storyMenuToggle = document.getElementById('storyMenuToggle');
        const storyMenu = document.getElementById('storyMenu');
        const storyList = document.getElementById('storyList');
        const storyPasswordSection = document.getElementById('storyPasswordSection');
        const storyPassword = document.getElementById('storyPassword');
        const unlockStoryBtn = document.getElementById('unlockStoryBtn');
        const storyPasswordStatus = document.getElementById('storyPasswordStatus');
        const selectedStoryName = document.getElementById('selectedStoryName');

        // Video management elements
        const addCloudinaryBtn = document.getElementById('addCloudinaryBtn');
        const addYoutubeBtn = document.getElementById('addYoutubeBtn');
        const addTelegramBtn = document.getElementById('addTelegramBtn');
        const addHlsBtn = document.getElementById('addHlsBtn');
        const storyNameInput = document.getElementById('storyName');
        const videoNameInput = document.getElementById('videoName');
        const cloudinaryUrl = document.getElementById('cloudinaryUrl');
        const youtubeUrl = document.getElementById('youtubeUrl');
        const telegramUrl = document.getElementById('telegramUrl');
        const hlsUrl = document.getElementById('hlsUrl');

        // Password type selectors
        const cloudinaryPasswordType = document.getElementById('cloudinaryPasswordType');
        const youtubePasswordType = document.getElementById('youtubePasswordType');
        const telegramPasswordType = document.getElementById('telegramPasswordType');
        const hlsPasswordType = document.getElementById('hlsPasswordType');

        // Contact link management elements
        const addContactLinkBtn = document.getElementById('addContactLinkBtn');
        const contactLinkUrl = document.getElementById('contactLinkUrl');
        const contactLinkName = document.getElementById('contactLinkName');
        const contactLinkStory = document.getElementById('contactLinkStory');
        const contactLinkType = document.getElementById('contactLinkType');
        const contactLinkAccess = document.getElementById('contactLinkAccess');
        const contactLinksAdminList = document.getElementById('contactLinksAdminList');

        // Password generation elements
        const passwordStory = document.getElementById('passwordStory');
        const storyPasswordsContainer = document.getElementById('storyPasswordsContainer');
        
        // Password filter elements
        const passwordFilterButtons = document.querySelectorAll('.password-filter-btn');
        const deleteUsedPasswordsBtn = document.getElementById('deleteUsedPasswordsBtn');
        const deleteUnusedPasswordsBtn = document.getElementById('deleteUnusedPasswordsBtn');
        const deleteAllPasswordsBtn = document.getElementById('deleteAllPasswordsBtn');
        const exportAllPasswordsBtn = document.getElementById('exportAllPasswordsBtn');
        
        // Password statistics elements
        const totalPasswordsElement = document.getElementById('totalPasswords');
        const usedPasswordsElement = document.getElementById('usedPasswords');
        const unusedPasswordsElement = document.getElementById('unusedPasswords');
        const storyCountElement = document.getElementById('storyCount');
        
        // Password generation modal elements
        const passwordGenerationModal = document.getElementById('passwordGenerationModal');
        const closePasswordModal = document.getElementById('closePasswordModal');
        const modalStoryName = document.getElementById('modalStoryName');
        const passwordNamePrefix = document.getElementById('passwordNamePrefix');
        const passwordRange = document.getElementById('passwordRange');
        const rangeValue = document.getElementById('rangeValue');
        const modalPasswordCount = document.getElementById('modalPasswordCount');
        const passwordPreview = document.getElementById('passwordPreview');
        const previewList = document.getElementById('previewList');
        const generateModalPasswordsBtn = document.getElementById('generateModalPasswordsBtn');
        const openAdvancedGenerationBtn = document.getElementById('openAdvancedGenerationBtn');

        // Monthly password generation elements
        const monthlyPasswordModal = document.getElementById('monthlyPasswordModal');
        const closeMonthlyPasswordModal = document.getElementById('closeMonthlyPasswordModal');
        const monthlyStoryName = document.getElementById('monthlyStoryName');
        const monthlyDuration = document.getElementById('monthlyDuration');
        const monthlyPasswordCount = document.getElementById('monthlyPasswordCount');
        const monthlyPasswordPreview = document.getElementById('monthlyPasswordPreview');
        const monthlyPreviewList = document.getElementById('monthlyPreviewList');
        const generateMonthlyPasswordsBtn = document.getElementById('generateMonthlyPasswordsBtn');
        const openMonthlyPasswordModal = document.getElementById('openMonthlyPasswordModal');
        const monthlyPasswordList = document.getElementById('monthlyPasswordList');

        // Time-based password generation elements
        const passwordTimerDisplay = document.getElementById('passwordTimerDisplay');
        const timerText = document.getElementById('timerText');

        // Device information elements
        const totalDevicesElement = document.getElementById('totalDevices');
        const onlineDevicesElement = document.getElementById('onlineDevices');
        const offlineDevicesElement = document.getElementById('offlineDevices');
        const activePasswordsElement = document.getElementById('activePasswords');
        const deviceListContainer = document.getElementById('deviceListContainer');

        // Rich Text Editor Elements
        const adminMessageEditor = document.getElementById('adminMessageEditor');
        const toolbarBtns = document.querySelectorAll('.toolbar-btn');
        const fontFamilySelect = document.getElementById('fontFamily');
        const fontSizeSelect = document.getElementById('fontSize');
        const textColorInput = document.getElementById('textColor');
        const backgroundColorInput = document.getElementById('backgroundColor');

        // Style selector elements
        const normalModeBtn = document.getElementById('normalModeBtn');
        const digitalModeBtn = document.getElementById('digitalModeBtn');
        const darkModeBtn = document.getElementById('darkModeBtn');

        // Compact password section element
        const compactPasswordSection = document.getElementById('compactPasswordSection');

        // Downloaded video edit modal elements
        const editDownloadedModal = document.getElementById('editDownloadedModal');
        const closeEditDownloadedModal = document.getElementById('closeEditDownloadedModal');
        const editDownloadedName = document.getElementById('editDownloadedName');
        const editDownloadedStory = document.getElementById('editDownloadedStory');
        const editDownloadedType = document.getElementById('editDownloadedType');
        const editDownloadedNotes = document.getElementById('editDownloadedNotes');
        const saveDownloadedEditBtn = document.getElementById('saveDownloadedEditBtn');

        // NEW: Custom Image Upload Elements
        const customImageUrl = document.getElementById('customImageUrl');
        const saveCustomImageBtn = document.getElementById('saveCustomImageBtn');
        const currentCustomImage = document.getElementById('currentCustomImage');
        const currentImageUrl = document.getElementById('currentImageUrl');

        // ============================================
        // STATE VARIABLES
        // ============================================
        let currentUser = null;
        let isAdmin = false;
        let videos = [];
        let passwords = [];
        let monthlyPasswords = [];
        let stories = [];
        let currentDeviceId = '';
        let userSessionRef = null;
        let hls = null;
        
        let contactLinksData = [];
        let currentVideoElement = null;
        let blackBarSettings = {
            top: 0,
            bottom: 0
        };
        let isUserLoggedIn = false;
        let videoOrder = [];
        let isOfflineMode = false;
        let currentSelectedStory = null;
        let unlockedStories = [];

        // Time-based password variables
        let timeBasedPasswords = {};
        let activeTimePassword = null;
        let passwordExpirationTimer = null;

        // Device tracking variables
        let devices = [];
        let devicePasswords = {};

        // Password filter state
        let currentPasswordFilter = 'all';
        let editingPasswordId = null;

        // Password box size management variables
        let passwordBoxSizeTimer = null;
        let isPasswordBoxSmall = true;

        // Download management variables
        let downloadingVideos = new Set();
        let downloadProgress = {};

        // Downloaded video edit state
        let currentlyEditingDownloadedVideoId = null;

        // Admin message data structure
        let adminMessageData = {
            content: '',
            styles: {
                fontFamily: '',
                fontSize: '',
                textColor: '',
                backgroundColor: '',
                alignment: '',
                bold: false,
                italic: false,
                underline: false
            },
            timestamp: null
        };

        // Custom image URL
        let customApplicationImageUrl = "https://res.cloudinary.com/zaumaran/image/upload/v1764932924/Kachin_Vision_Empire_For_Logo_zpkdbg.png";

        // ============================================
        // SECURE DOWNLOAD SYSTEM VARIABLES
        // ============================================
        const APP_FOLDER_NAME = 'Kachin Visions Empire';
        const VIDEO_FOLDER_NAME = 'videos';
        let appStorage = null;

        // ============================================
        // MAIN APPLICATION INITIALIZATION
        // ============================================
        async function initApp() {
            currentDeviceId = generateDeviceId();
            
            // Set digital mode as default
            setStyleMode('digital');
            
            // Load custom image from localStorage
            loadCustomImage();
            
            // Initialize secure download system
            await initSecureDownloadSystem();
            
            // Check if user is already logged in
            auth.onAuthStateChanged(user => {
                if (user && user.email === 'sunday@video.com') {
                    currentUser = user;
                    isAdmin = true;
                } else {
                    currentUser = null;
                    isAdmin = false;
                }
            });

            // Load videos, passwords, and contact links from Firebase
            await loadVideos();
            await loadPasswords();
            await loadMonthlyPasswords();
            await loadTimePasswords();
            await loadContactLinks();
            await loadDevices();
            
            // Set default image as video on startup
            setDefaultImageAsVideo();
            
            // Cache videos for offline browsing
            cacheVideosForOffline();
            
            // Check for offline videos
            checkOfflineVideos();
            
            // Check for active passwords
            checkActiveTimePassword();
            checkActiveMonthlyPassword();
            
            // Initialize new systems
            initPasswordBoxSizeManagement();
            initAutoRememberSystem();
            initDownloadedVideoEditModal();
            
            // Initialize rich text editor
            initRichTextEditor();
            
            // Initialize style selector
            initStyleSelector();
            
            // Initialize password generation modal
            initPasswordGenerationModal();
            
            // Initialize monthly password generation modal
            initMonthlyPasswordGenerationModal();
            
            // Set up password filter listeners
            initPasswordFilters();
            
            // Render downloaded videos section
            renderDownloadedVideosSection();
            
            // Set up periodic online status updates
            setInterval(updatePasswordOnlineStatus, 60000); // Update every minute
            
            // Set up periodic device updates
            setInterval(loadDevices, 30000); // Update every 30 seconds
            
            // Set up periodic cache updates
            setInterval(cacheVideosForOffline, 300000); // Update cache every 5 minutes
            
            // Initialize connection monitoring
            window.addEventListener('online', updateConnectionStatus);
            window.addEventListener('offline', updateConnectionStatus);
            updateConnectionStatus();
            
            // Initialize enhanced digital mode effects
            initDigitalEffects();
            
            // Initialize custom image upload
            initCustomImageUpload();
        }

        // ============================================
        // DEFAULT IMAGE AS VIDEO FUNCTION
        // ============================================
        function setDefaultImageAsVideo() {
            // Clear the main video player
            mainVideoPlayer.innerHTML = '';
            
            // Create video player wrapper
            const videoPlayerWrapper = document.createElement('div');
            videoPlayerWrapper.className = 'video-player-wrapper';
            
            // Create black bars
            const topBar = document.createElement('div');
            topBar.id = 'topBlackBar';
            topBar.className = 'black-bars top-bar';
            topBar.style.height = '0px';
            
            const bottomBar = document.createElement('div');
            bottomBar.id = 'bottomBlackBar';
            bottomBar.className = 'black-bars bottom-bar';
            bottomBar.style.height = '0px';
            
            // Create video content area
            const videoContent = document.createElement('div');
            videoContent.className = 'video-content';
            videoContent.style.height = '100%';
            
            // Create img element for the custom image
            const imgElement = document.createElement('img');
            imgElement.id = 'defaultImageElement';
            imgElement.src = customApplicationImageUrl;
            imgElement.alt = 'Kachin Visions Empire';
            imgElement.style.width = '100%';
            imgElement.style.height = '100%';
            imgElement.style.objectFit = 'contain';
            imgElement.style.objectPosition = 'center';
            
            videoContent.appendChild(imgElement);
            
            // Assemble the video player
            videoPlayerWrapper.appendChild(topBar);
            videoPlayerWrapper.appendChild(videoContent);
            videoPlayerWrapper.appendChild(bottomBar);
            mainVideoPlayer.appendChild(videoPlayerWrapper);
            
            currentVideoElement = imgElement;
            
            console.log('Default image set as video:', customApplicationImageUrl);
        }

        // ============================================
        // CUSTOM IMAGE UPLOAD FUNCTIONS
        // ============================================
        function initCustomImageUpload() {
            saveCustomImageBtn.addEventListener('click', saveCustomImage);
            
            // Load existing custom image URL
            const savedImageUrl = localStorage.getItem('customApplicationImageUrl');
            if (savedImageUrl) {
                customApplicationImageUrl = savedImageUrl;
                customImageUrl.value = savedImageUrl;
                currentCustomImage.src = savedImageUrl;
                currentImageUrl.textContent = savedImageUrl;
            }
        }

        function saveCustomImage() {
            const imageUrl = customImageUrl.value.trim();
            
            if (!imageUrl) {
                alert('Please enter a valid Cloudinary URL');
                return;
            }
            
            // Validate URL format
            if (!imageUrl.startsWith('https://res.cloudinary.com/')) {
                alert('Please enter a valid Cloudinary URL starting with https://res.cloudinary.com/');
                return;
            }
            
            // Save to localStorage
            localStorage.setItem('customApplicationImageUrl', imageUrl);
            
            // Update global variable
            customApplicationImageUrl = imageUrl;
            
            // Update display
            currentCustomImage.src = imageUrl;
            currentImageUrl.textContent = imageUrl;
            
            // Update the video player with new image
            if (currentVideoElement && currentVideoElement.tagName === 'IMG') {
                currentVideoElement.src = imageUrl;
            } else {
                setDefaultImageAsVideo();
            }
            
            alert('Application image saved successfully! It will be used on startup.');
        }

        function loadCustomImage() {
            const savedImageUrl = localStorage.getItem('customApplicationImageUrl');
            if (savedImageUrl) {
                customApplicationImageUrl = savedImageUrl;
            }
        }

        // ============================================
        // ENHANCED DIGITAL EFFECTS
        // ============================================
        function initDigitalEffects() {
            // Create enhanced particles for digital mode
            createEnhancedParticles();
            
            // Listen for style changes to update effects
            digitalModeBtn.addEventListener('click', () => {
                setTimeout(createEnhancedParticles, 100);
            });
        }

        function createEnhancedParticles() {
            if (!document.body.classList.contains('digital-mode')) {
                return;
            }
            
            const particlesContainer = document.querySelector('.digital-particles');
            if (!particlesContainer) return;
            
            particlesContainer.innerHTML = '';
            
            // Create sun particles (gold/orange)
            for (let i = 0; i < 5; i++) {
                const sunParticle = document.createElement('div');
                sunParticle.className = 'particle sun';
                sunParticle.style.width = `${Math.random() * 40 + 20}px`;
                sunParticle.style.height = sunParticle.style.width;
                sunParticle.style.left = `${Math.random() * 100}%`;
                sunParticle.style.top = `${Math.random() * 100}%`;
                sunParticle.style.animationDuration = `${Math.random() * 20 + 10}s`;
                sunParticle.style.animationDelay = `${Math.random() * 5}s`;
                particlesContainer.appendChild(sunParticle);
            }
            
            // Create regular particles (orange/yellow)
            for (let i = 0; i < 20; i++) {
                const particle = document.createElement('div');
                particle.className = 'particle';
                particle.style.width = `${Math.random() * 10 + 2}px`;
                particle.style.height = particle.style.width;
                particle.style.left = `${Math.random() * 100}%`;
                particle.style.top = `${Math.random() * 100}%`;
                particle.style.animationDuration = `${Math.random() * 15 + 5}s`;
                particle.style.animationDelay = `${Math.random() * 3}s`;
                particlesContainer.appendChild(particle);
            }
        }

        // ============================================
        // SECURE DOWNLOAD SYSTEM IMPLEMENTATION
        // ============================================
        async function initSecureDownloadSystem() {
            try {
                // Check if we have access to the File System Access API
                if ('showDirectoryPicker' in window) {
                    // Try to get access to the Kachin Visions Empire folder
                    try {
                        const handle = await window.showDirectoryPicker({
                            id: 'kachin-visions-empire-video-storage',
                            mode: 'readwrite',
                            startIn: 'documents'
                        });
                        
                        // Check if we have the correct folder
                        if (handle.name !== APP_FOLDER_NAME) {
                            // Create or get the Kachin Visions Empire folder
                            appStorage = await handle.getDirectoryHandle(APP_FOLDER_NAME, { create: true });
                        } else {
                            appStorage = handle;
                        }
                        
                        // Create videos subfolder
                        const videoStorage = await appStorage.getDirectoryHandle(VIDEO_FOLDER_NAME, { create: true });
                        
                        console.log('Secure download system initialized');
                    } catch (error) {
                        console.warn('File System Access API not available or permission denied:', error);
                        // Fall back to localStorage for basic functionality
                        appStorage = null;
                    }
                } else {
                    console.warn('File System Access API not supported in this browser');
                    appStorage = null;
                }
            } catch (error) {
                console.error('Error initializing secure download system:', error);
                appStorage = null;
            }
        }

        // ============================================
        // DEVICE MANAGEMENT FUNCTIONS
        // ============================================
        function generateDeviceId() {
            let deviceId = localStorage.getItem('deviceId');
            if (!deviceId) {
                deviceId = 'device_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                localStorage.setItem('deviceId', deviceId);
                
                // Register this installation
                registerInstallation(deviceId);
            }
            return deviceId;
        }

        function registerInstallation(deviceId) {
            if (navigator.onLine && !isOfflineMode) {
                const userAgent = navigator.userAgent;
                let deviceType = 'Unknown';
                
                // Simple device detection
                if (/Android/.test(userAgent)) {
                    deviceType = 'Android';
                } else if (/iPhone|iPad|iPod/.test(userAgent)) {
                    deviceType = 'iOS';
                } else if (/Windows/.test(userAgent)) {
                    deviceType = 'Windows';
                } else if (/Mac/.test(userAgent)) {
                    deviceType = 'Mac';
                } else if (/Linux/.test(userAgent)) {
                    deviceType = 'Linux';
                }
                
                db.collection('installations').doc(deviceId).set({
                    deviceType: deviceType,
                    userAgent: userAgent,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    online: true,
                    lastSeen: new Date().toISOString()
                }).catch(error => {
                    console.error('Error registering installation:', error);
                });
            }
        }

        // ============================================
        // PASSWORD BOX SIZE MANAGEMENT
        // ============================================
        function setPasswordBoxSmall() {
            if (!compactPasswordSection) return;
            
            compactPasswordSection.classList.add('small-state');
            isPasswordBoxSmall = true;
            
            // Clear any existing timer
            if (passwordBoxSizeTimer) {
                clearTimeout(passwordBoxSizeTimer);
                passwordBoxSizeTimer = null;
            }
        }

        function setPasswordBoxNormal() {
            if (!compactPasswordSection) return;
            
            compactPasswordSection.classList.remove('small-state');
            isPasswordBoxSmall = false;
            
            // Set timer to revert to small size after 10 seconds
            passwordBoxSizeTimer = setTimeout(() => {
                setPasswordBoxSmall();
            }, 10000); // 10 seconds
        }

        function initPasswordBoxSizeManagement() {
            // Start with small size
            setPasswordBoxSmall();
            
            // Add event listeners to expand when interacted with
            const passwordInput = document.getElementById('password');
            const unlockVideosBtn = document.getElementById('unlockVideosBtn');
            
            if (passwordInput) {
                passwordInput.addEventListener('focus', () => {
                    setPasswordBoxNormal();
                });
                
                passwordInput.addEventListener('click', () => {
                    setPasswordBoxNormal();
                });
                
                passwordInput.addEventListener('input', () => {
                    setPasswordBoxNormal();
                });
            }
            
            if (unlockVideosBtn) {
                unlockVideosBtn.addEventListener('click', () => {
                    setPasswordBoxNormal();
                });
                
                unlockVideosBtn.addEventListener('mouseenter', () => {
                    setPasswordBoxNormal();
                });
            }
            
            // Also expand when hovering over the entire section
            if (compactPasswordSection) {
                compactPasswordSection.addEventListener('mouseenter', () => {
                    setPasswordBoxNormal();
                });
            }
        }

        // ============================================
        // STORY PASSWORD AUTO-HIDE FUNCTIONALITY
        // ============================================
        function showStoryPasswordSectionWithTimer(story) {
            currentSelectedStory = story;
            selectedStoryName.textContent = story;
            storyPasswordSection.classList.add('active');
            
            // Auto-hide after 10 seconds
            setTimeout(() => {
                if (storyPasswordSection.classList.contains('active')) {
                    storyPasswordSection.classList.remove('active');
                }
            }, 10000); // 10 seconds
        }

        // ============================================
        // PASSWORD AUTO-REMEMBER SYSTEM
        // ============================================
        function rememberPassword(passwordType, password, additionalData = {}) {
            let rememberedPasswords = JSON.parse(localStorage.getItem('rememberedPasswords') || '{}');
            
            const passwordData = {
                password: password,
                timestamp: new Date().toISOString(),
                expiry: new Date(Date.now() + 30 * 24 * 60 * 60 * 1000).toISOString(), // 30 days expiry
                ...additionalData,
                // Store password ID for tracking deletions
                passwordId: additionalData.passwordId || null
            };
            
            rememberedPasswords[passwordType] = rememberedPasswords[passwordType] || {};
            
            if (passwordType === 'story' && additionalData.storyName) {
                rememberedPasswords.story[additionalData.storyName] = passwordData;
            } else {
                rememberedPasswords[passwordType] = passwordData;
            }
            
            localStorage.setItem('rememberedPasswords', JSON.stringify(rememberedPasswords));
            
            // Schedule cleanup for when password expires
            schedulePasswordCleanup(passwordType, additionalData.storyName, passwordData.expiry);
        }

        function schedulePasswordCleanup(passwordType, storyName, expiry) {
            const expiryTime = new Date(expiry).getTime() - Date.now();
            
            if (expiryTime > 0) {
                setTimeout(() => {
                    clearExpiredRememberedPasswords();
                    
                    // If this password was active, lock the content
                    if (passwordType === 'story' && storyName) {
                        lockStoryVideos(storyName);
                    } else if (passwordType === 'global' || passwordType === 'monthly' || passwordType === 'time') {
                        lockTimeBasedContent();
                    }
                }, expiryTime);
            }
        }

        function checkAndAutoFillPasswords() {
            const rememberedPasswords = JSON.parse(localStorage.getItem('rememberedPasswords') || '{}');
            const now = new Date();
            
            // Check global password
            if (rememberedPasswords.global && new Date(rememberedPasswords.global.expiry) > now) {
                document.getElementById('password').value = rememberedPasswords.global.password;
            }
            
            // Check story passwords
            if (rememberedPasswords.story && currentSelectedStory) {
                const storyPasswordData = rememberedPasswords.story[currentSelectedStory];
                if (storyPasswordData && new Date(storyPasswordData.expiry) > now) {
                    document.getElementById('storyPassword').value = storyPasswordData.password;
                }
            }
            
            // Check monthly passwords
            if (rememberedPasswords.monthly && new Date(rememberedPasswords.monthly.expiry) > now) {
                document.getElementById('password').value = rememberedPasswords.monthly.password;
            }
        }

        function clearExpiredRememberedPasswords() {
            const rememberedPasswords = JSON.parse(localStorage.getItem('rememberedPasswords') || '{}');
            const now = new Date();
            let hasChanges = false;
            
            // Check global password
            if (rememberedPasswords.global && new Date(rememberedPasswords.global.expiry) <= now) {
                delete rememberedPasswords.global;
                hasChanges = true;
            }
            
            // Check story passwords
            if (rememberedPasswords.story) {
                Object.keys(rememberedPasswords.story).forEach(storyName => {
                    if (new Date(rememberedPasswords.story[storyName].expiry) <= now) {
                        delete rememberedPasswords.story[storyName];
                        hasChanges = true;
                    }
                });
                
                // Remove empty story object
                if (Object.keys(rememberedPasswords.story).length === 0) {
                    delete rememberedPasswords.story;
                    hasChanges = true;
                }
            }
            
            // Check monthly passwords
            if (rememberedPasswords.monthly && new Date(rememberedPasswords.monthly.expiry) <= now) {
                delete rememberedPasswords.monthly;
                hasChanges = true;
            }
            
            if (hasChanges) {
                localStorage.setItem('rememberedPasswords', JSON.stringify(rememberedPasswords));
            }
        }

        function setupAdminPasswordDeletionListener() {
            if (navigator.onLine && !isOfflineMode) {
                // Listen for password deletions in Firestore
                db.collection('passwords').onSnapshot((snapshot) => {
                    snapshot.docChanges().forEach((change) => {
                        if (change.type === 'removed') {
                            const deletedPasswordId = change.doc.id;
                            
                            // Check if this password was remembered
                            const rememberedPasswords = JSON.parse(localStorage.getItem('rememberedPasswords') || '{}');
                            let passwordToRemove = null;
                            
                            // Check global password
                            if (rememberedPasswords.global && rememberedPasswords.global.password === deletedPasswordId) {
                                passwordToRemove = 'global';
                            }
                            
                            // Check story passwords
                            if (rememberedPasswords.story) {
                                Object.keys(rememberedPasswords.story).forEach(storyName => {
                                    if (rememberedPasswords.story[storyName].password === deletedPasswordId) {
                                        passwordToRemove = `story.${storyName}`;
                                    }
                                });
                            }
                            
                            // If found, remove from remembered passwords
                            if (passwordToRemove) {
                                if (passwordToRemove === 'global') {
                                    delete rememberedPasswords.global;
                                } else if (passwordToRemove.startsWith('story.')) {
                                    const storyName = passwordToRemove.split('.')[1];
                                    delete rememberedPasswords.story[storyName];
                                }
                                
                                localStorage.setItem('rememberedPasswords', JSON.stringify(rememberedPasswords));
                                
                                // Immediately lock videos from that story
                                if (passwordToRemove.startsWith('story.')) {
                                    const storyName = passwordToRemove.split('.')[1];
                                    lockStoryVideos(storyName);
                                }
                            }
                        }
                    });
                });
                
                // Also listen for monthly password deletions
                db.collection('monthlyPasswords').onSnapshot((snapshot) => {
                    snapshot.docChanges().forEach((change) => {
                        if (change.type === 'removed') {
                            const deletedPasswordId = change.doc.id;
                            
                            // Check if this monthly password was remembered
                            const rememberedPasswords = JSON.parse(localStorage.getItem('rememberedPasswords') || '{}');
                            
                            if (rememberedPasswords.monthly && rememberedPasswords.monthly.password === deletedPasswordId) {
                                delete rememberedPasswords.monthly;
                                localStorage.setItem('rememberedPasswords', JSON.stringify(rememberedPasswords));
                                
                                // Lock all content
                                lockTimeBasedContent();
                            }
                        }
                    });
                });
            }
        }

        function initAutoRememberSystem() {
            // Clear expired passwords on startup
            clearExpiredRememberedPasswords();
            
            // Auto-fill passwords when story is selected
            document.getElementById('storyList').addEventListener('click', function(e) {
                if (e.target.classList.contains('story-item')) {
                    setTimeout(checkAndAutoFillPasswords, 100);
                }
            });
            
            // Auto-fill on page load
            window.addEventListener('load', function() {
                setTimeout(checkAndAutoFillPasswords, 500);
            });
            
            // Listen for admin password deletion
            setupAdminPasswordDeletionListener();
        }

        // ============================================
        // DOWNLOADED VIDEOS EDIT/DELETE FUNCTIONALITY
        // ============================================
        function renderDownloadedVideosSection() {
            const downloadedVideos = JSON.parse(localStorage.getItem('downloadedVideos') || '{}');
            
            if (Object.keys(downloadedVideos).length === 0) {
                downloadedVideosSection.style.display = 'none';
                return;
            }
            
            downloadedVideosSection.style.display = 'block';
            downloadedVideosList.innerHTML = '';
            
            Object.entries(downloadedVideos).forEach(([videoId, videoData]) => {
                const videoItem = document.createElement('div');
                videoItem.className = 'video-item downloaded';
                
                // Calculate expiration info
                const expiresDate = new Date(videoData.expires);
                const daysLeft = Math.ceil((expiresDate - new Date()) / (1000 * 60 * 60 * 24));
                
                // Get custom metadata if exists
                const customName = videoData.customName || videoData.name;
                const customStory = videoData.customStory || videoData.storyName;
                const customType = videoData.customType || videoData.type;
                const notes = videoData.notes || '';
                
                videoItem.innerHTML = `
                    <div style="flex: 1;">
                        <h4 style="font-size: 9px;">${customName}</h4>
                        <p style="font-size: 8px;">${customType} ${customStory ? ` ${customStory}` : ''}</p>
                        <p style="font-size: 8px; color: var(--accent);">
                            <i class="fas fa-clock"></i> Expires in ${daysLeft} day${daysLeft !== 1 ? 's' : ''}
                        </p>
                        ${notes ? `<p style="font-size: 7px; color: var(--gray); margin-top: 2px;"><i class="fas fa-sticky-note"></i> ${notes}</p>` : ''}
                        <div class="downloaded-video-actions">
                            <button class="downloaded-edit-btn" data-id="${videoId}">
                                <i class="fas fa-edit"></i> Edit
                            </button>
                            <button class="downloaded-delete-btn" data-id="${videoId}">
                                <i class="fas fa-trash"></i> Delete
                            </button>
                        </div>
                    </div>
                    <button class="play-offline-btn" data-id="${videoId}" style="
                        background: var(--success);
                        color: white;
                        border: none;
                        padding: 4px 8px;
                        border-radius: 4px;
                        font-size: 8px;
                        cursor: pointer;
                        display: flex;
                        align-items: center;
                        gap: 4px;
                    ">
                        <i class="fas fa-play"></i> Play
                    </button>
                `;
                
                videoItem.addEventListener('click', async (e) => {
                    if (e.target.closest('.play-offline-btn') || 
                        e.target.closest('.downloaded-edit-btn') || 
                        e.target.closest('.downloaded-delete-btn')) return;
                    await playOfflineVideo(videoId);
                });
                
                const playBtn = videoItem.querySelector('.play-offline-btn');
                playBtn.addEventListener('click', async (e) => {
                    e.stopPropagation();
                    await playOfflineVideo(videoId);
                });
                
                const editBtn = videoItem.querySelector('.downloaded-edit-btn');
                editBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    openEditDownloadedModal(videoId, videoData);
                });
                
                const deleteBtn = videoItem.querySelector('.downloaded-delete-btn');
                deleteBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    deleteDownloadedVideo(videoId);
                });
                
                downloadedVideosList.appendChild(videoItem);
            });
        }

        function openEditDownloadedModal(videoId, videoData) {
            currentlyEditingDownloadedVideoId = videoId;
            
            // Fill form with current data
            editDownloadedName.value = videoData.customName || videoData.name || '';
            editDownloadedStory.value = videoData.customStory || videoData.storyName || '';
            editDownloadedType.value = videoData.customType || videoData.type || 'mp4';
            editDownloadedNotes.value = videoData.notes || '';
            
            // Show modal
            editDownloadedModal.style.display = 'flex';
        }

        function saveDownloadedVideoEdit() {
            const videoId = currentlyEditingDownloadedVideoId;
            if (!videoId) return;
            
            const downloadedVideos = JSON.parse(localStorage.getItem('downloadedVideos') || '{}');
            const videoData = downloadedVideos[videoId];
            
            if (!videoData) {
                alert('Video not found!');
                return;
            }
            
            // Get form values
            const newName = editDownloadedName.value.trim();
            const newStory = editDownloadedStory.value.trim();
            const newType = editDownloadedType.value;
            const newNotes = editDownloadedNotes.value.trim();
            
            if (!newName) {
                alert('Video name is required!');
                return;
            }
            
            // Update video data
            videoData.customName = newName;
            if (newStory) videoData.customStory = newStory;
            if (newType) videoData.customType = newType;
            if (newNotes) videoData.notes = newNotes;
            videoData.lastEdited = new Date().toISOString();
            
            // Save back to localStorage
            downloadedVideos[videoId] = videoData;
            localStorage.setItem('downloadedVideos', JSON.stringify(downloadedVideos));
            
            // Close modal
            editDownloadedModal.style.display = 'none';
            currentlyEditingDownloadedVideoId = null;
            
            // Refresh UI
            renderDownloadedVideosSection();
            renderVideoLibraryWithDownloads();
            
            alert('Video information updated successfully!');
        }

        function deleteDownloadedVideo(videoId) {
            if (!confirm('Are you sure you want to delete this downloaded video? This action cannot be undone.')) {
                return;
            }
            
            const downloadedVideos = JSON.parse(localStorage.getItem('downloadedVideos') || '{}');
            
            if (!downloadedVideos[videoId]) {
                alert('Video not found!');
                return;
            }
            
            // Delete from storage
            delete downloadedVideos[videoId];
            localStorage.setItem('downloadedVideos', JSON.stringify(downloadedVideos));
            
            // Also remove from cache if exists
            const cachedVideos = JSON.parse(localStorage.getItem('cachedVideos') || '[]');
            const updatedCachedVideos = cachedVideos.filter(v => v.id !== videoId);
            localStorage.setItem('cachedVideos', JSON.stringify(updatedCachedVideos));
            
            // Refresh UI
            renderDownloadedVideosSection();
            renderVideoLibraryWithDownloads();
            
            alert('Video deleted successfully! Storage space has been freed up.');
        }

        function initDownloadedVideoEditModal() {
            closeEditDownloadedModal.addEventListener('click', () => {
                editDownloadedModal.style.display = 'none';
                currentlyEditingDownloadedVideoId = null;
            });
            
            saveDownloadedEditBtn.addEventListener('click', saveDownloadedVideoEdit);
            
            // Close modal when clicking outside
            editDownloadedModal.addEventListener('click', (e) => {
                if (e.target === editDownloadedModal) {
                    editDownloadedModal.style.display = 'none';
                    currentlyEditingDownloadedVideoId = null;
                }
            });
        }

        // ============================================
        // ENHANCED VIDEO MANAGEMENT FUNCTIONS
        // ============================================
        async function loadVideos() {
            try {
                if (navigator.onLine && !isOfflineMode) {
                    const snapshot = await db.collection('videos').get();
                    videos = [];
                    snapshot.forEach(doc => {
                        videos.push({ id: doc.id, ...doc.data() });
                    });
                    
                    // Sort videos by story name, then by video name
                    videos.sort((a, b) => {
                        // Sort by story name first
                        if (a.storyName && b.storyName) {
                            if (a.storyName.toLowerCase() < b.storyName.toLowerCase()) return -1;
                            if (a.storyName.toLowerCase() > b.storyName.toLowerCase()) return 1;
                        }
                        
                        // Then sort by video name
                        if (a.name.toLowerCase() < b.name.toLowerCase()) return -1;
                        if (a.name.toLowerCase() > b.name.toLowerCase()) return 1;
                        return 0;
                    });
                    
                    await renderVideoList();
                    renderAdminVideoList();
                    loadStories();
                    updateDownloadableVideos();
                    cacheVideosForOffline();
                } else {
                    // Load from cache/offline storage
                    await loadCachedVideos();
                    await renderVideoList();
                }
            } catch (error) {
                console.error('Error loading videos:', error);
                await renderVideoList();
            }
        }

        function renderAdminVideoList() {
            videoAdminList.innerHTML = '';
            
            // Create sorting controls
            const sortingControls = document.createElement('div');
            sortingControls.className = 'video-sorting-controls';
            sortingControls.innerHTML = `
                <div style="display: flex; gap: 8px; margin-bottom: 12px; flex-wrap: wrap;">
                    <button class="sort-btn" data-sort="story-az">Sort by Story (A-Z)</button>
                    <button class="sort-btn" data-sort="story-za">Sort by Story (Z-A)</button>
                    <button class="sort-btn" data-sort="name-az">Sort by Name (A-Z)</button>
                    <button class="sort-btn" data-sort="name-za">Sort by Name (Z-A)</button>
                    <button class="sort-btn" data-sort="date-new">Sort by Date (Newest)</button>
                    <button class="sort-btn" data-sort="date-old">Sort by Date (Oldest)</button>
                </div>
            `;
            
            videoAdminList.appendChild(sortingControls);
            
            // Sort videos based on current sort setting
            let sortedVideos = [...videos];
            const sortSetting = localStorage.getItem('videoSortSetting') || 'story-az';
            
            sortedVideos.sort((a, b) => {
                switch(sortSetting) {
                    case 'story-az':
                        if (a.storyName && b.storyName) {
                            return a.storyName.localeCompare(b.storyName);
                        }
                        return 0;
                    case 'story-za':
                        if (a.storyName && b.storyName) {
                            return b.storyName.localeCompare(a.storyName);
                        }
                        return 0;
                    case 'name-az':
                        return a.name.localeCompare(b.name);
                    case 'name-za':
                        return b.name.localeCompare(a.name);
                    case 'date-new':
                        return new Date(b.added?.toDate?.() || b.added || 0) - 
                               new Date(a.added?.toDate?.() || a.added || 0);
                    case 'date-old':
                        return new Date(a.added?.toDate?.() || a.added || 0) - 
                               new Date(b.added?.toDate?.() || b.added || 0);
                    default:
                        return 0;
                }
            });
            
            sortedVideos.forEach((video, index) => {
                const videoItem = document.createElement('div');
                videoItem.className = 'video-admin-item';
                videoItem.setAttribute('data-id', video.id);
                videoItem.setAttribute('data-index', index);
                
                // Check if video is marked as downloadable
                const isDownloadable = video.downloadable === true;
                
                videoItem.innerHTML = `
                    <div class="video-admin-info">
                        <h4 style="font-size: 9px;">${video.name} 
                            ${isDownloadable ? '<span class="downloadable-badge">Downloadable</span>' : ''}
                        </h4>
                        <p style="font-size: 8px;">Type: ${video.type}</p>
                        <p style="font-size: 8px; font-weight: 600;">Story: ${video.storyName || 'No Story'}</p>
                        <p style="font-size: 8px;">Access: ${video.passwordType === 'free' ? 'Free' : 'Password Protected'}</p>
                        <p style="font-size: 8px;">URL: ${video.url}</p>
                        <p style="font-size: 8px;">Added: ${video.added ? new Date(video.added.toDate?.() || video.added).toLocaleDateString() : 'Unknown'}</p>
                    </div>
                    <div class="video-admin-actions">
                        <div class="download-toggle-container" style="margin-bottom: 8px;">
                            <label style="font-size: 8px; display: flex; align-items: center; gap: 4px;">
                                <input type="checkbox" class="download-toggle" ${isDownloadable ? 'checked' : ''} data-id="${video.id}">
                                Enable Download
                            </label>
                        </div>
                        <div style="display: flex; gap: 6px;">
                            <button class="edit-btn" data-id="${video.id}"><i class="fas fa-edit"></i> Edit</button>
                            <button class="delete-btn" data-id="${video.id}"><i class="fas fa-trash"></i> Delete</button>
                        </div>
                    </div>
                `;
                
                videoAdminList.appendChild(videoItem);
            });
            
            // Add event listeners for sort buttons
            document.querySelectorAll('.sort-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const sortType = this.getAttribute('data-sort');
                    localStorage.setItem('videoSortSetting', sortType);
                    renderAdminVideoList();
                });
            });
            
            // Add event listeners for download toggles
            document.querySelectorAll('.download-toggle').forEach(toggle => {
                toggle.addEventListener('change', function() {
                    const videoId = this.getAttribute('data-id');
                    const isDownloadable = this.checked;
                    toggleVideoDownload(videoId, isDownloadable);
                });
            });
            
            // Add event listeners for edit and delete buttons
            document.querySelectorAll('.video-admin-actions .edit-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const videoId = e.target.getAttribute('data-id');
                    editVideo(videoId);
                });
            });
            
            document.querySelectorAll('.video-admin-actions .delete-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const videoId = e.target.getAttribute('data-id');
                    deleteVideo(videoId);
                });
            });
        }

        function toggleVideoDownload(videoId, isDownloadable) {
            if (navigator.onLine && !isOfflineMode) {
                db.collection('videos').doc(videoId).update({
                    downloadable: isDownloadable,
                    downloadUpdated: firebase.firestore.FieldValue.serverTimestamp()
                }).then(() => {
                    // Update local video data
                    const videoIndex = videos.findIndex(v => v.id === videoId);
                    if (videoIndex !== -1) {
                        videos[videoIndex].downloadable = isDownloadable;
                        videos[videoIndex].downloadUpdated = new Date().toISOString();
                    }
                    
                    // Update downloadable videos list
                    updateDownloadableVideos();
                    
                    alert(`Download setting ${isDownloadable ? 'enabled' : 'disabled'} for this video.`);
                }).catch(error => {
                    console.error('Error updating download setting:', error);
                    alert('Error updating download setting. Please try again.');
                });
            } else {
                alert('Cannot update download settings while offline. Please connect to the internet.');
            }
        }

        function updateDownloadableVideos() {
            const downloadableVideos = videos.filter(v => v.downloadable === true);
            localStorage.setItem('downloadableVideos', JSON.stringify(downloadableVideos));
            renderVideoLibraryWithDownloads();
        }

        // ============================================
        // SECURE VIDEO DOWNLOAD AND OFFLINE PLAYBACK SYSTEM
        // ============================================
        function renderVideoLibraryWithDownloads() {
            videoList.innerHTML = '';
            
            // Create sorting controls for screen 1
            const sortingControls = document.createElement('div');
            sortingControls.className = 'video-library-sorting';
            sortingControls.innerHTML = `
                <div style="display: flex; gap: 6px; margin-bottom: 10px; flex-wrap: wrap;">
                    <button class="lib-sort-btn active" data-sort="all">All Videos</button>
                    <button class="lib-sort-btn" data-sort="story">By Story (A-Z)</button>
                    <button class="lib-sort-btn" data-sort="date">By Date</button>
                    <button class="lib-sort-btn" data-sort="downloaded">Downloaded</button>
                </div>
            `;
            
            videoList.appendChild(sortingControls);
            
            // Get current sort setting
            const sortSetting = localStorage.getItem('librarySortSetting') || 'all';
            
            // Get downloaded videos from cache
            const downloadedVideos = JSON.parse(localStorage.getItem('downloadedVideos') || '{}');
            
            // Filter videos based on current view
            let videosToDisplay = [...videos];
            
            // Apply filters based on sort setting
            if (sortSetting === 'downloaded') {
                videosToDisplay = videosToDisplay.filter(v => downloadedVideos[v.id]);
            }
            
            // Sort videos based on sort setting
            videosToDisplay.sort((a, b) => {
                switch(sortSetting) {
                    case 'story':
                        if (a.storyName && b.storyName) {
                            return a.storyName.localeCompare(b.storyName);
                        }
                        return 0;
                    case 'date':
                        return new Date(b.added?.toDate?.() || b.added || 0) - 
                               new Date(a.added?.toDate?.() || a.added || 0);
                    default:
                        // Default sort: downloadable first, then by name
                        if (a.downloadable && !b.downloadable) return -1;
                        if (!a.downloadable && b.downloadable) return 1;
                        return a.name.localeCompare(b.name);
                }
            });
            
            // Group by story if needed
            if (sortSetting === 'story') {
                const groupedVideos = {};
                videosToDisplay.forEach(video => {
                    const story = video.storyName || 'No Story';
                    if (!groupedVideos[story]) {
                        groupedVideos[story] = [];
                    }
                    groupedVideos[story].push(video);
                });
                
                // Sort story names alphabetically
                const sortedStories = Object.keys(groupedVideos).sort();
                
                sortedStories.forEach(story => {
                    // Add story header
                    const storyHeader = document.createElement('div');
                    storyHeader.className = 'story-header';
                    storyHeader.textContent = story;
                    videoList.appendChild(storyHeader);
                    
                    // Add videos for this story
                    groupedVideos[story].forEach(video => {
                        renderVideoItem(video, downloadedVideos);
                    });
                });
            } else {
                // Regular display
                videosToDisplay.forEach(video => {
                    renderVideoItem(video, downloadedVideos);
                });
            }
            
            // Add event listeners for sort buttons
            document.querySelectorAll('.lib-sort-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    // Update active state
                    document.querySelectorAll('.lib-sort-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    
                    // Update sort setting
                    const sortType = this.getAttribute('data-sort');
                    localStorage.setItem('librarySortSetting', sortType);
                    
                    // Re-render video list
                    renderVideoLibraryWithDownloads();
                });
            });
        }

        function renderVideoItem(video, downloadedVideos) {
            const videoItem = document.createElement('div');
            
            // Check if video is free or requires password
            const isFree = video.passwordType === 'free';
            const isUnlocked = isUserLoggedIn || 
                (video.storyName && unlockedStories.includes(video.storyName)) ||
                activeTimePassword;
            
            const isDownloadable = video.downloadable === true;
            const isDownloaded = downloadedVideos[video.id];
            
            if ((isFree || isUnlocked) && isDownloadable) {
                videoItem.className = 'video-item downloadable';
            } else if (isFree) {
                videoItem.className = 'video-item free';
            } else if (!isUnlocked) {
                videoItem.className = 'video-item locked';
            } else {
                videoItem.className = 'video-item';
            }
            
            videoItem.innerHTML = `
                <div style="flex: 1;">
                    <h4 style="font-size: 9px;">${video.name}</h4>
                    <p style="font-size: 8px;">${video.type} ${video.storyName ? ` ${video.storyName}` : ''}</p>
                    ${isDownloadable ? '<p style="font-size: 8px; color: var(--success);"><i class="fas fa-download"></i> Download Available</p>' : ''}
                    ${isDownloaded ? '<p style="font-size: 8px; color: var(--accent);"><i class="fas fa-check-circle"></i> Downloaded</p>' : ''}
                </div>
                ${isFree ? '<span class="free-badge">Free</span>' : ''}
                ${isDownloadable && (isFree || isUnlocked) ? 
                    `<button class="download-video-btn" data-id="${video.id}" style="
                        background: ${isDownloaded ? 'var(--success)' : 'var(--primary)'};
                        color: white;
                        border: none;
                        padding: 4px 8px;
                        border-radius: 4px;
                        font-size: 8px;
                        cursor: pointer;
                        display: flex;
                        align-items: center;
                        gap: 4px;
                    ">
                        <i class="fas ${isDownloaded ? 'fa-check' : 'fa-download'}"></i>
                        ${isDownloaded ? 'Downloaded' : 'Save'}
                    </button>` : ''
                }
            `;
            
            videoItem.addEventListener('click', async (e) => {
                // Don't trigger if clicking download button
                if (e.target.closest('.download-video-btn')) return;
                
                if (!videoItem.classList.contains('locked')) {
                    await playVideo(video);
                } else if (isFree) {
                    await playVideo(video);
                } else {
                    alert('This video requires a password. Please enter the password for this story or use the global password.');
                }
            });
            
            // Add download button event listener
            if (isDownloadable && (isFree || isUnlocked)) {
                const downloadBtn = videoItem.querySelector('.download-video-btn');
                downloadBtn.addEventListener('click', async (e) => {
                    e.stopPropagation();
                    await downloadVideoForOffline(video);
                });
            }
            
            videoList.appendChild(videoItem);
        }

        async function downloadVideoForOffline(video) {
            if (!video.downloadable) {
                alert('This video is not available for download.');
                return;
            }
            
            // Check if already downloading
            if (downloadingVideos.has(video.id)) {
                alert('This video is already being downloaded.');
                return;
            }
            
            // Check storage quota
            if (!await checkStorageQuota()) {
                alert('Insufficient storage space. Please free up some space and try again.');
                return;
            }
            
            // Show downloading indicator
            const downloadBtn = document.querySelector(`.download-video-btn[data-id="${video.id}"]`);
            const originalText = downloadBtn.innerHTML;
            downloadBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Downloading...';
            downloadBtn.disabled = true;
            downloadingVideos.add(video.id);
            
            try {
                // For security, we'll encrypt the video data before storing
                const encryptedVideoData = await encryptVideoData(video);
                
                // Store in secure storage if available
                let storagePath = null;
                if (appStorage) {
                    try {
                        storagePath = await saveToSecureStorage(video.id, encryptedVideoData);
                    } catch (error) {
                        console.warn('Failed to save to secure storage:', error);
                    }
                }
                
                // Store reference in localStorage
                const downloadedVideos = JSON.parse(localStorage.getItem('downloadedVideos') || '{}');
                downloadedVideos[video.id] = {
                    ...video,
                    encryptedData: encryptedVideoData,
                    storagePath: storagePath,
                    downloadDate: new Date().toISOString(),
                    expires: new Date(Date.now() + 30 * 24 * 60 * 60 * 1000).toISOString() // 30 days
                };
                
                localStorage.setItem('downloadedVideos', JSON.stringify(downloadedVideos));
                
                // Update UI
                downloadBtn.innerHTML = '<i class="fas fa-check"></i> Downloaded';
                downloadBtn.style.background = 'var(--success)';
                
                alert('Video downloaded securely! You can now watch it offline.');
                
                // Update video library display
                renderVideoLibraryWithDownloads();
                renderDownloadedVideosSection();
                
                // Save download record to Firebase if online
                if (navigator.onLine && !isOfflineMode) {
                    await db.collection('videoDownloads').add({
                        videoId: video.id,
                        videoName: video.name,
                        storyName: video.storyName,
                        deviceId: currentDeviceId,
                        downloadDate: firebase.firestore.FieldValue.serverTimestamp(),
                        expires: new Date(Date.now() + 30 * 24 * 60 * 60 * 1000)
                    });
                }
                
            } catch (error) {
                console.error('Error downloading video:', error);
                downloadBtn.innerHTML = originalText;
                downloadBtn.disabled = false;
                alert('Error downloading video. Please try again.');
            } finally {
                downloadingVideos.delete(video.id);
            }
        }

        async function saveToSecureStorage(videoId, encryptedData) {
            if (!appStorage) return null;
            
            try {
                // Create videos folder if it doesn't exist
                const videosFolder = await appStorage.getDirectoryHandle(VIDEO_FOLDER_NAME, { create: true });
                
                // Create a unique filename with device ID
                const filename = `video_${videoId}_${currentDeviceId}.enc`;
                const fileHandle = await videosFolder.getFileHandle(filename, { create: true });
                const writable = await fileHandle.createWritable();
                
                // Write encrypted data
                await writable.write(encryptedData);
                await writable.close();
                
                return filename;
            } catch (error) {
                console.error('Error saving to secure storage:', error);
                throw error;
            }
        }

        async function loadFromSecureStorage(filename) {
            if (!appStorage) return null;
            
            try {
                const videosFolder = await appStorage.getDirectoryHandle(VIDEO_FOLDER_NAME, { create: false });
                const fileHandle = await videosFolder.getFileHandle(filename, { create: false });
                const file = await fileHandle.getFile();
                return await file.text();
            } catch (error) {
                console.error('Error loading from secure storage:', error);
                return null;
            }
        }

        async function deleteFromSecureStorage(filename) {
            if (!appStorage) return;
            
            try {
                const videosFolder = await appStorage.getDirectoryHandle(VIDEO_FOLDER_NAME, { create: false });
                await videosFolder.removeEntry(filename);
            } catch (error) {
                console.error('Error deleting from secure storage:', error);
            }
        }

        async function encryptVideoData(video) {
            // Generate a unique key for this video using device ID and video ID
            const secretKey = CryptoJS.SHA256(`${currentDeviceId}_${video.id}_kachin_visions_empire_secret`).toString();
            
            // Encrypt the video data
            const encrypted = CryptoJS.AES.encrypt(
                JSON.stringify({
                    ...video,
                    _encrypted: true,
                    _deviceId: currentDeviceId,
                    _timestamp: new Date().toISOString(),
                    _app: 'Kachin Visions Empire'
                }),
                secretKey
            ).toString();
            
            return encrypted;
        }

        async function decryptVideoData(encryptedData) {
            try {
                // Get video ID from encrypted data reference
                const downloadedVideos = JSON.parse(localStorage.getItem('downloadedVideos') || '{}');
                let videoId = null;
                
                // Find which video this encrypted data belongs to
                for (const [id, data] of Object.entries(downloadedVideos)) {
                    if (data.encryptedData === encryptedData || data.storagePath) {
                        videoId = id;
                        break;
                    }
                }
                
                if (!videoId) {
                    throw new Error('Video not found in downloaded videos');
                }
                
                // Generate the same secret key
                const secretKey = CryptoJS.SHA256(`${currentDeviceId}_${videoId}_kachin_visions_empire_secret`).toString();
                
                // Decrypt the data
                const decryptedBytes = CryptoJS.AES.decrypt(encryptedData, secretKey);
                const decryptedText = decryptedBytes.toString(CryptoJS.enc.Utf8);
                
                if (!decryptedText) {
                    throw new Error('Decryption failed - invalid key or data');
                }
                
                const decrypted = JSON.parse(decryptedText);
                
                // Verify this was encrypted for this device
                if (decrypted._deviceId !== currentDeviceId) {
                    throw new Error('Video not authorized for this device');
                }
                
                // Verify this is for the Kachin Visions Empire app
                if (decrypted._app !== 'Kachin Visions Empire') {
                    throw new Error('Invalid video format');
                }
                
                // Remove encryption metadata
                delete decrypted._encrypted;
                delete decrypted._deviceId;
                delete decrypted._timestamp;
                delete decrypted._app;
                
                return decrypted;
            } catch (error) {
                console.error('Error decrypting video:', error);
                throw new Error('Failed to decrypt video data. It may be corrupted or not authorized for this device.');
            }
        }

        async function checkStorageQuota() {
            if ('storage' in navigator && 'estimate' in navigator.storage) {
                try {
                    const { usage, quota } = await navigator.storage.estimate();
                    const availableSpace = quota - usage;
                    const minRequired = 50 * 1024 * 1024; // 50MB minimum
                    
                    return availableSpace > minRequired;
                } catch (error) {
                    console.error('Error checking storage quota:', error);
                    return true; // Assume enough space if we can't check
                }
            }
            return true; // Assume enough space if API not available
        }

        async function playOfflineVideo(videoId) {
            const downloadedVideos = JSON.parse(localStorage.getItem('downloadedVideos') || '{}');
            const videoData = downloadedVideos[videoId];
            
            if (!videoData) {
                alert('Video not found in offline storage.');
                return;
            }
            
            // Check if video has expired
            if (videoData.expires && new Date(videoData.expires) < new Date()) {
                // Remove expired video
                delete downloadedVideos[videoId];
                localStorage.setItem('downloadedVideos', JSON.stringify(downloadedVideos));
                
                // Also delete from secure storage if exists
                if (videoData.storagePath) {
                    await deleteFromSecureStorage(videoData.storagePath);
                }
                
                alert('This downloaded video has expired. Please download it again.');
                renderVideoLibraryWithDownloads();
                renderDownloadedVideosSection();
                return;
            }
            
            try {
                // Load encrypted data from secure storage if available
                let encryptedData = videoData.encryptedData;
                if (videoData.storagePath && !encryptedData) {
                    encryptedData = await loadFromSecureStorage(videoData.storagePath);
                    if (!encryptedData) {
                        throw new Error('Could not load video from secure storage');
                    }
                }
                
                // Decrypt the video data
                const decryptedVideo = await decryptVideoData(encryptedData);
                
                // Play the video
                await playVideo(decryptedVideo);
                
            } catch (error) {
                console.error('Error playing offline video:', error);
                alert('Error playing offline video. It may be corrupted or not authorized for this device.');
            }
        }

        async function loadCachedVideos() {
            try {
                const cachedVideos = JSON.parse(localStorage.getItem('cachedVideos') || '[]');
                videos = cachedVideos;
            } catch (error) {
                console.error('Error loading cached videos:', error);
                videos = [];
            }
        }

        function cacheVideosForOffline() {
            if (navigator.onLine && !isOfflineMode) {
                // Store basic video info for offline browsing
                const videoCache = videos.map(v => ({
                    id: v.id,
                    name: v.name,
                    storyName: v.storyName,
                    type: v.type,
                    passwordType: v.passwordType,
                    downloadable: v.downloadable || false,
                    added: v.added
                }));
                
                localStorage.setItem('cachedVideos', JSON.stringify(videoCache));
            }
        }

        // ============================================
        // SECURE PASSWORD GENERATION (Single Device Access)
        // ============================================
        function generateStoryPasswords(story, namePrefix, count) {
            const batch = db.batch();
            const newPasswords = [];
            
            // Clear previous generated passwords display
            generatedPasswords.innerHTML = '<h4 style="margin-bottom: 10px; text-align: center;">Recently Generated Passwords</h4>';
            
            for (let i = 0; i < count; i++) {
                // Generate password with single device access restriction
                const randomDigits = Math.floor(100000 + Math.random() * 900000);
                let password;
                
                if (namePrefix) {
                    password = `${namePrefix}.${story}.${randomDigits}`;
                } else {
                    password = `${story}.${randomDigits}`;
                }
                
                // Add to batch with single device restriction
                const passwordRef = db.collection('passwords').doc();
                batch.set(passwordRef, {
                    password: password,
                    storyName: story,
                    created: firebase.firestore.FieldValue.serverTimestamp(),
                    deviceId: null, // Initially no device - will be set on first use
                    online: false,
                    singleDevice: true, // Mark as single device password
                    maxDevices: 1, // Only 1 device can use this password
                    currentDevices: [] // Track which devices have used this
                });
                
                newPasswords.push(password);
                
                // Add to display
                const passwordItem = document.createElement('div');
                passwordItem.className = 'password-item';
                passwordItem.innerHTML = `
                    <span>${password} <small style="color: var(--accent);">(Single Device)</small></span>
                    <button class="copy-btn" data-password="${password}"><i class="fas fa-copy"></i> Copy</button>
                `;
                generatedPasswords.appendChild(passwordItem);
            }
            
            // Execute batch write if online
            if (navigator.onLine && !isOfflineMode) {
                batch.commit().then(() => {
                    alert(`Successfully generated ${count} single-device passwords for "${story}"!`);
                    loadPasswords();
                    
                    // Add copy functionality to the new buttons
                    document.querySelectorAll('.copy-btn').forEach(btn => {
                        btn.addEventListener('click', (e) => {
                            const password = e.target.getAttribute('data-password');
                            navigator.clipboard.writeText(password).then(() => {
                                alert(`Password ${password} copied to clipboard!`);
                            }).catch(err => {
                                console.error('Failed to copy password: ', err);
                            });
                        });
                    });
                }).catch(error => {
                    console.error('Error generating passwords:', error);
                    alert('Error generating passwords. Please try again.');
                });
            } else {
                alert('Cannot generate passwords while offline. Please connect to the internet.');
            }
        }

        // ============================================
        // AUTO-CLEANUP ON UNINSTALL
        // ============================================
        function setupAutoCleanup() {
            // Create a cleanup marker
            localStorage.setItem('kachin_visions_empire_cleanup_marker', 'true');
            
            // Listen for beforeunload event (when app is being closed)
            window.addEventListener('beforeunload', function() {
                // We can't directly detect uninstall, but we can check on next load
                // if the cleanup marker exists but app data doesn't
            });
            
            // Check on app load if we need to clean up
            window.addEventListener('load', function() {
                const cleanupMarker = localStorage.getItem('kachin_visions_empire_cleanup_marker');
                const hasAppData = localStorage.getItem('downloadedVideos') || 
                                  localStorage.getItem('cachedVideos') ||
                                  localStorage.getItem('rememberedPasswords');
                
                // If marker exists but no app data, it might be a fresh install after uninstall
                // We can't reliably detect uninstall in web apps, but we can clean up on fresh installs
                if (cleanupMarker && !hasAppData) {
                    // This might be a fresh install, ensure clean state
                    cleanupAppData();
                }
            });
        }

        async function cleanupAppData() {
            try {
                // Clean up secure storage if available
                if (appStorage) {
                    try {
                        // Try to delete the entire Kachin Visions Empire folder
                        const rootHandle = await window.showDirectoryPicker();
                        if (rootHandle.name === APP_FOLDER_NAME) {
                            await rootHandle.remove({ recursive: true });
                        } else {
                            const appHandle = await rootHandle.getDirectoryHandle(APP_FOLDER_NAME, { create: false });
                            await appHandle.remove({ recursive: true });
                        }
                    } catch (error) {
                        console.warn('Could not delete secure storage:', error);
                    }
                }
                
                // Clean up localStorage
                const itemsToKeep = ['deviceId', 'preferredStyleMode', 'videoSortSetting', 'librarySortSetting', 'customApplicationImageUrl'];
                const allKeys = Object.keys(localStorage);
                
                allKeys.forEach(key => {
                    if (!itemsToKeep.includes(key)) {
                        localStorage.removeItem(key);
                    }
                });
                
                console.log('App data cleanup completed');
            } catch (error) {
                console.error('Error during app data cleanup:', error);
            }
        }

        // ============================================
        // OFFLINE MODE ENHANCEMENTS
        // ============================================
        function checkOfflineVideos() {
            const downloadedVideos = JSON.parse(localStorage.getItem('downloadedVideos') || '{}');
            
            // Check for expired videos
            const now = new Date();
            let hasExpired = false;
            
            Object.keys(downloadedVideos).forEach(videoId => {
                if (downloadedVideos[videoId].expires && new Date(downloadedVideos[videoId].expires) < now) {
                    // Delete from secure storage if exists
                    if (downloadedVideos[videoId].storagePath) {
                        deleteFromSecureStorage(downloadedVideos[videoId].storagePath);
                    }
                    delete downloadedVideos[videoId];
                    hasExpired = true;
                }
            });
            
            if (hasExpired) {
                localStorage.setItem('downloadedVideos', JSON.stringify(downloadedVideos));
            }
            
            // Show downloaded videos section if there are any
            if (Object.keys(downloadedVideos).length > 0) {
                downloadedVideosSection.style.display = 'block';
                renderDownloadedVideosSection();
            }
            
            return Object.keys(downloadedVideos).length > 0;
        }

        // ============================================
        // STORY MANAGEMENT FUNCTIONS
        // ============================================
        function loadStories() {
            stories = [];
            const storyMap = {};
            
            videos.forEach(video => {
                if (video.storyName && !storyMap[video.storyName]) {
                    storyMap[video.storyName] = true;
                    stories.push(video.storyName);
                }
            });
            
            renderStoryMenu();
            updateStoryDropdowns();
            updatePasswordStatistics();
            updateDeviceStatistics();
        }

        function renderStoryMenu() {
            storyList.innerHTML = '';
            
            stories.forEach(story => {
                const storyItem = document.createElement('div');
                storyItem.className = 'story-item';
                storyItem.textContent = story;
                storyItem.addEventListener('click', () => {
                    selectStory(story);
                    // Close the menu after selection
                    storyMenu.classList.remove('active');
                });
                
                storyList.appendChild(storyItem);
            });
        }

        function updateStoryDropdowns() {
            // Clear existing options
            contactLinkStory.innerHTML = '<option value="">Select Story (Optional)</option>';
            passwordStory.innerHTML = '<option value="">Select Story</option>';
            modalStoryName.innerHTML = '<option value="">Select Story</option>';
            monthlyStoryName.innerHTML = '<option value="">All Stories (Global Access)</option>';
            
            // Add story options
            stories.forEach(story => {
                const option1 = document.createElement('option');
                option1.value = story;
                option1.textContent = story;
                contactLinkStory.appendChild(option1);
                
                const option2 = document.createElement('option');
                option2.value = story;
                option2.textContent = story;
                passwordStory.appendChild(option2);
                
                const option3 = document.createElement('option');
                option3.value = story;
                option3.textContent = story;
                modalStoryName.appendChild(option3);
                
                const option4 = document.createElement('option');
                option4.value = story;
                option4.textContent = story;
                monthlyStoryName.appendChild(option4);
            });
        }

        function selectStory(story) {
            currentSelectedStory = story;
            selectedStoryName.textContent = story;
            
            // Highlight selected story
            document.querySelectorAll('.story-item').forEach(item => {
                item.classList.remove('active');
                if (item.textContent === story) {
                    item.classList.add('active');
                }
            });
            
            // Check for remembered password for this story
            checkAndAutoFillPasswords();
            
            // Show password section if story has password-protected videos
            const hasPasswordProtectedVideos = videos.some(video => 
                video.storyName === story && video.passwordType === 'password'
            );
            
            if (hasPasswordProtectedVideos && !unlockedStories.includes(story)) {
                showStoryPasswordSectionWithTimer(story);
                storyPasswordStatus.textContent = 'Enter password to unlock this story';
                storyPasswordStatus.style.color = 'var(--accent)';
            } else {
                storyPasswordSection.classList.remove('active');
                filterVideosByStory(story);
            }
        }

        function unlockStory() {
            const password = storyPassword.value;
            const story = currentSelectedStory;
            
            if (!password) {
                storyPasswordStatus.textContent = 'Please enter a password';
                storyPasswordStatus.style.color = 'var(--danger)';
                return;
            }
            
            // Check if password matches any password for this story
            const validPassword = passwords.find(p => 
                p.password === password && p.storyName === story
            );
            
            if (validPassword) {
                // Check if this is a single device password already in use
                if (validPassword.singleDevice && validPassword.deviceId && validPassword.deviceId !== currentDeviceId) {
                    storyPasswordStatus.textContent = 'This password is already registered to another device.';
                    storyPasswordStatus.style.color = 'var(--danger)';
                    return;
                }
                
                unlockedStories.push(story);
                storyPasswordSection.classList.remove('active');
                storyPasswordStatus.textContent = '';
                filterVideosByStory(story);
                
                // Auto-remember the password
                rememberPassword('story', password, { storyName: story });
                
                alert(`Story "${story}" unlocked successfully!`);
            } else {
                storyPasswordStatus.textContent = 'Invalid password for this story';
                storyPasswordStatus.style.color = 'var(--danger)';
            }
        }

        function filterVideosByStory(story) {
            const filteredVideos = videos.filter(video => video.storyName === story);
            renderVideoLibraryWithDownloads();
        }

        function lockStoryVideos(storyName) {
            // Remove from unlocked stories
            const index = unlockedStories.indexOf(storyName);
            if (index !== -1) {
                unlockedStories.splice(index, 1);
            }
            
            // Lock all videos from this story
            document.querySelectorAll('.video-item').forEach(item => {
                const itemText = item.querySelector('p')?.textContent || '';
                if (itemText.includes(` ${storyName}`) || itemText.includes(storyName)) {
                    if (!item.classList.contains('free')) {
                        item.classList.add('locked');
                    }
                }
            });
            
            // Also lock contact links from this story
            renderContactLinksScreen();
            
            // Show notification
            if (isUserLoggedIn) {
                alert(`Access to story "${storyName}" has been revoked. Videos from this story are now locked.`);
            }
            
            // Update login status
            if (unlockedStories.length === 0) {
                isUserLoggedIn = false;
                loginStatus.textContent = 'Please enter your password to unlock videos';
                loginStatus.style.color = 'var(--accent)';
            }
        }

        // ============================================
        // PASSWORD MANAGEMENT FUNCTIONS
        // ============================================
        function loadPasswords() {
            if (navigator.onLine && !isOfflineMode) {
                db.collection('passwords').get().then(snapshot => {
                    passwords = [];
                    snapshot.forEach(doc => {
                        passwords.push({ id: doc.id, ...doc.data() });
                    });
                    
                    renderPasswordList();
                    updatePasswordStatistics();
                }).catch(error => {
                    console.error('Error loading passwords:', error);
                    renderPasswordList();
                });
            } else {
                renderPasswordList();
            }
        }

        function loadMonthlyPasswords() {
            if (navigator.onLine && !isOfflineMode) {
                db.collection('monthlyPasswords').get().then(snapshot => {
                    monthlyPasswords = [];
                    snapshot.forEach(doc => {
                        monthlyPasswords.push({ id: doc.id, ...doc.data() });
                    });
                    
                    renderMonthlyPasswordList();
                }).catch(error => {
                    console.error('Error loading monthly passwords:', error);
                    renderMonthlyPasswordList();
                });
            } else {
                renderMonthlyPasswordList();
            }
        }

        function loadTimePasswords() {
            if (navigator.onLine && !isOfflineMode) {
                db.collection('timePasswords').get().then(snapshot => {
                    timeBasedPasswords = {};
                    snapshot.forEach(doc => {
                        timeBasedPasswords[doc.id] = doc.data();
                    });
                    
                    checkActiveTimePassword();
                }).catch(error => {
                    console.error('Error loading time passwords:', error);
                    checkActiveTimePassword();
                });
            } else {
                checkActiveTimePassword();
            }
        }

        function loadDevices() {
            if (navigator.onLine && !isOfflineMode) {
                db.collection('installations').get().then(snapshot => {
                    devices = [];
                    snapshot.forEach(doc => {
                        devices.push({ id: doc.id, ...doc.data() });
                    });
                    
                    updateDeviceStatistics();
                    renderDeviceList();
                }).catch(error => {
                    console.error('Error loading devices:', error);
                });
            }
        }

        function loadContactLinks() {
            if (navigator.onLine && !isOfflineMode) {
                db.collection('contactLinks').get().then(snapshot => {
                    contactLinksData = [];
                    snapshot.forEach(doc => {
                        contactLinksData.push({ id: doc.id, ...doc.data() });
                    });
                    
                    renderContactLinksScreen();
                    renderAdminContactLinksList();
                }).catch(error => {
                    console.error('Error loading contact links:', error);
                    renderContactLinksScreen();
                });
            } else {
                renderContactLinksScreen();
            }
        }

        async function renderVideoList() {
            renderVideoLibraryWithDownloads();
        }

        async function playVideo(video) {
            // Destroy any existing HLS instance
            if (hls) {
                hls.destroy();
                hls = null;
            }
            
            let videoUrl = video.url;
            
            // Check if we're offline and video is downloaded
            const downloadedVideos = JSON.parse(localStorage.getItem('downloadedVideos') || '{}');
            const isDownloaded = downloadedVideos[video.id];
            
            if (!navigator.onLine && !isDownloaded) {
                alert('Video not available offline. Please download it first or connect to the internet.');
                return;
            }
            
            // If offline and downloaded, use offline version
            if (!navigator.onLine && isDownloaded) {
                try {
                    const decryptedVideo = await decryptVideoData(downloadedVideos[video.id].encryptedData);
                    videoUrl = decryptedVideo.url;
                } catch (error) {
                    alert('Error playing offline video. Please try downloading it again.');
                    return;
                }
            }
            
            // Clear the main video player
            mainVideoPlayer.innerHTML = '';
            
            // Create video player wrapper
            const videoPlayerWrapper = document.createElement('div');
            videoPlayerWrapper.className = 'video-player-wrapper';
            
            // Create black bars
            const topBar = document.createElement('div');
            topBar.id = 'topBlackBar';
            topBar.className = 'black-bars top-bar';
            topBar.style.height = blackBarSettings.top + 'px';
            
            const bottomBar = document.createElement('div');
            bottomBar.id = 'bottomBlackBar';
            bottomBar.className = 'black-bars bottom-bar';
            bottomBar.style.height = blackBarSettings.bottom + 'px';
            
            // Create video content area
            const videoContent = document.createElement('div');
            videoContent.className = 'video-content';
            const totalBarHeight = blackBarSettings.top + blackBarSettings.bottom;
            videoContent.style.height = `calc(100% - ${totalBarHeight}px)`;
            
            // Check if it's a YouTube video
            if (video.type === 'youtube') {
                // Create iframe for YouTube video with proper configuration
                const iframe = document.createElement('iframe');
                iframe.className = 'youtube-iframe';
                
                // Extract video ID and create proper embed URL
                const videoId = extractYouTubeId(video.url);
                if (!videoId) {
                    alert('Invalid YouTube URL format');
                    return;
                }
                
                // Create proper YouTube embed URL with minimal parameters
                const embedUrl = `https://www.youtube.com/embed/${videoId}`;
                
                iframe.src = embedUrl;
                iframe.allowFullscreen = true;
                iframe.allow = 'accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture';
                iframe.referrerPolicy = 'strict-origin-when-cross-origin';
                iframe.frameBorder = '0';
                iframe.title = video.name;
                
                videoContent.appendChild(iframe);
                currentVideoElement = iframe;
            } 
            // Check if it's an HLS stream
            else if (video.type === 'hls' && video.url && video.url.endsWith('.m3u8')) {
                if (Hls.isSupported()) {
                    // Create video element for HLS
                    const videoElement = document.createElement('video');
                    videoElement.id = 'mainVideoElement';
                    videoElement.controls = true;
                    videoElement.autoplay = true;
                    videoElement.muted = false;
                    videoElement.loop = false;
                    videoElement.controlsList = 'nodownload noremoteplayback';
                    videoElement.style.width = '100%';
                    videoElement.style.height = '100%';
                    videoElement.oncontextmenu = () => false;
                    
                    videoContent.appendChild(videoElement);
                    currentVideoElement = videoElement;
                    
                    hls = new Hls({
                        enableWorker: false, // Disable worker for better mobile compatibility
                        lowLatencyMode: true,
                        backBufferLength: 90
                    });
                    
                    hls.loadSource(videoUrl);
                    hls.attachMedia(videoElement);
                    
                    hls.on(Hls.Events.MANIFEST_PARSED, function() {
                        console.log('HLS manifest parsed successfully');
                    });
                    
                    // Show quality selector for HLS
                    qualitySelector.style.display = 'block';
                } else if (mainVideoElement && mainVideoElement.canPlayType('application/vnd.apple.mpegurl')) {
                    // Safari native HLS support
                    mainVideoElement.src = videoUrl;
                    currentVideoElement = mainVideoElement;
                } else {
                    console.error('HLS is not supported in this browser');
                    alert('HLS video is not supported in your browser. Please try a different browser.');
                    return;
                }
            } else {
                // Regular video (MP4, WebM, etc.)
                // Create video element for regular videos
                const videoElement = document.createElement('video');
                videoElement.id = 'mainVideoElement';
                videoElement.controls = true;
                videoElement.autoplay = true;
                videoElement.muted = false;
                videoElement.loop = false;
                videoElement.controlsList = 'nodownload noremoteplayback';
                videoElement.style.width = '100%';
                videoElement.style.height = '100%';
                videoElement.oncontextmenu = () => false;
                
                const source = document.createElement('source');
                source.src = videoUrl;
                
                // Set appropriate MIME type based on file extension
                if (videoUrl.toLowerCase().endsWith('.webm')) {
                    source.type = 'video/webm';
                } else if (videoUrl.toLowerCase().endsWith('.ogg') || videoUrl.toLowerCase().endsWith('.ogv')) {
                    source.type = 'video/ogg';
                } else {
                    source.type = 'video/mp4'; // Default to MP4
                }
                
                videoElement.appendChild(source);
                videoElement.innerHTML += 'Your browser does not support the video tag.';
                
                videoContent.appendChild(videoElement);
                currentVideoElement = videoElement;
            }
            
            // Assemble the video player
            videoPlayerWrapper.appendChild(topBar);
            videoPlayerWrapper.appendChild(videoContent);
            videoPlayerWrapper.appendChild(bottomBar);
            mainVideoPlayer.appendChild(videoPlayerWrapper);
            
            // Highlight the playing video in the list
            document.querySelectorAll('.video-item').forEach(item => {
                item.classList.remove('playing');
            });
            
            const videoItems = document.querySelectorAll('.video-item');
            for (let i = 0; i < videoItems.length; i++) {
                const itemText = videoItems[i].querySelector('h4').textContent;
                if (itemText === video.name) {
                    videoItems[i].classList.add('playing');
                    break;
                }
            }

            // Disable right-click context menu
            if (currentVideoElement) {
                currentVideoElement.addEventListener('contextmenu', function(e) {
                    e.preventDefault();
                    return false;
                });
            }
        }

        function extractYouTubeId(url) {
            // Handle various YouTube URL formats
            const patterns = [
                /(?:youtube\.com\/watch\?v=|youtu\.be\/|youtube\.com\/embed\/)([^&?#]+)/,
                /youtube\.com\/watch\?.*v=([^&?#]+)/,
                /youtu\.be\/([^&?#]+)/,
                /youtube\.com\/embed\/([^&?#]+)/
            ];
            
            for (const pattern of patterns) {
                const match = url.match(pattern);
                if (match && match[1]) {
                    return match[1];
                }
            }
            
            return null;
        }

        function addCloudinaryVideo() {
            const storyName = storyNameInput.value;
            const name = videoNameInput.value;
            const url = cloudinaryUrl.value;
            const passwordType = cloudinaryPasswordType.value;
            
            if (!storyName || !name || !url) {
                alert('Please enter story name, video name, and URL');
                return;
            }
            
            if (navigator.onLine && !isOfflineMode) {
                db.collection('videos').add({
                    storyName: storyName,
                    name: name,
                    url: url,
                    type: 'cloudinary',
                    passwordType: passwordType,
                    downloadable: false, // Default to not downloadable
                    added: firebase.firestore.FieldValue.serverTimestamp()
                }).then(() => {
                    alert('Cloudinary video added successfully!');
                    storyNameInput.value = '';
                    videoNameInput.value = '';
                    cloudinaryUrl.value = '';
                    loadVideos();
                }).catch(error => {
                    console.error('Error adding video:', error);
                    alert('Error adding video. Please try again.');
                });
            } else {
                alert('Cannot add videos while offline. Please connect to the internet.');
            }
        }

        function addYouTubeVideo() {
            const storyName = storyNameInput.value;
            const name = videoNameInput.value;
            const url = youtubeUrl.value;
            const passwordType = youtubePasswordType.value;
            
            if (!storyName || !name || !url) {
                alert('Please enter story name, video name, and URL');
                return;
            }
            
            // Extract video ID from YouTube URL
            const videoId = extractYouTubeId(url);
            if (!videoId) {
                alert('Invalid YouTube URL. Please use a valid YouTube URL format.');
                return;
            }
            
            // Create proper YouTube embed URL
            const embedUrl = `https://www.youtube.com/embed/${videoId}`;
            
            if (navigator.onLine && !isOfflineMode) {
                db.collection('videos').add({
                    storyName: storyName,
                    name: name,
                    url: embedUrl,
                    type: 'youtube',
                    passwordType: passwordType,
                    downloadable: false, // Default to not downloadable
                    added: firebase.firestore.FieldValue.serverTimestamp()
                }).then(() => {
                    alert('YouTube video added successfully!');
                    storyNameInput.value = '';
                    videoNameInput.value = '';
                    youtubeUrl.value = '';
                    loadVideos();
                }).catch(error => {
                    console.error('Error adding video:', error);
                    alert('Error adding video. Please try again.');
                });
            } else {
                alert('Cannot add videos while offline. Please connect to the internet.');
            }
        }

        function addTelegramVideo() {
            const storyName = storyNameInput.value;
            const name = videoNameInput.value;
            const url = telegramUrl.value;
            const passwordType = telegramPasswordType.value;
            
            if (!storyName || !name || !url) {
                alert('Please enter story name, video name, and URL');
                return;
            }
            
            if (navigator.onLine && !isOfflineMode) {
                db.collection('videos').add({
                    storyName: storyName,
                    name: name,
                    url: url,
                    type: 'telegram',
                    passwordType: passwordType,
                    downloadable: false, // Default to not downloadable
                    added: firebase.firestore.FieldValue.serverTimestamp()
                }).then(() => {
                    alert('Telegram video added successfully!');
                    storyNameInput.value = '';
                    videoNameInput.value = '';
                    telegramUrl.value = '';
                    loadVideos();
                }).catch(error => {
                    console.error('Error adding video:', error);
                    alert('Error adding video. Please try again.');
                });
            } else {
                alert('Cannot add videos while offline. Please connect to the internet.');
            }
        }

        function addHlsVideo() {
            const storyName = storyNameInput.value;
            const name = videoNameInput.value;
            const url = hlsUrl.value;
            const passwordType = hlsPasswordType.value;
            
            if (!storyName || !name || !url) {
                alert('Please enter story name, video name, and URL');
                return;
            }
            
            if (navigator.onLine && !isOfflineMode) {
                db.collection('videos').add({
                    storyName: storyName,
                    name: name,
                    url: url,
                    type: 'hls',
                    passwordType: passwordType,
                    downloadable: false, // Default to not downloadable
                    added: firebase.firestore.FieldValue.serverTimestamp()
                }).then(() => {
                    alert('HLS stream added successfully!');
                    storyNameInput.value = '';
                    videoNameInput.value = '';
                    hlsUrl.value = '';
                    loadVideos();
                }).catch(error => {
                    console.error('Error adding HLS stream:', error);
                    alert('Error adding HLS stream. Please try again.');
                });
            } else {
                alert('Cannot add videos while offline. Please connect to the internet.');
            }
        }

        function addContactLink() {
            const url = contactLinkUrl.value;
            const name = contactLinkName.value;
            const storyName = contactLinkStory.value;
            const type = contactLinkType.value;
            const accessType = contactLinkAccess.value;
            
            if (!url || !name) {
                alert('Please enter both URL and display name');
                return;
            }
            
            if (navigator.onLine && !isOfflineMode) {
                db.collection('contactLinks').add({
                    url: url,
                    name: name,
                    storyName: storyName,
                    type: type,
                    accessType: accessType,
                    added: firebase.firestore.FieldValue.serverTimestamp()
                }).then((docRef) => {
                    alert('Contact link added successfully!');
                    
                    // Clear input fields
                    contactLinkUrl.value = '';
                    contactLinkName.value = '';
                    
                    // Reload contact links
                    loadContactLinks();
                }).catch(error => {
                    console.error('Error adding contact link:', error);
                    alert('Error adding contact link. Please try again.');
                });
            } else {
                alert('Cannot add contact links while offline. Please connect to the internet.');
            }
        }

        function editVideo(videoId) {
            const video = videos.find(v => v.id === videoId);
            if (video) {
                const newStoryName = prompt('Enter new story name:', video.storyName || '');
                const newName = prompt('Enter new video name:', video.name);
                const newUrl = prompt('Enter new video URL:', video.url);
                const newType = prompt('Enter new video type:', video.type);
                const newPasswordType = prompt('Enter password type (free or password):', video.passwordType || 'password');
                const newDownloadable = confirm('Make this video downloadable?') ? true : false;
                
                if (newName && newUrl && newType && newPasswordType) {
                    if (navigator.onLine && !isOfflineMode) {
                        db.collection('videos').doc(videoId).update({
                            storyName: newStoryName,
                            name: newName,
                            url: newUrl,
                            type: newType,
                            passwordType: newPasswordType,
                            downloadable: newDownloadable
                        }).then(() => {
                            loadVideos();
                            alert('Video updated successfully!');
                        }).catch(error => {
                            console.error('Error updating video:', error);
                            alert('Error updating video. Please try again.');
                        });
                    } else {
                        alert('Cannot edit videos while offline. Please connect to the internet.');
                    }
                }
            }
        }

        function deleteVideo(videoId) {
            if (confirm('Are you sure you want to delete this video?')) {
                if (navigator.onLine && !isOfflineMode) {
                    db.collection('videos').doc(videoId).delete().then(() => {
                        loadVideos();
                        alert('Video deleted successfully!');
                    }).catch(error => {
                        console.error('Error deleting video:', error);
                        alert('Error deleting video. Please try again.');
                    });
                } else {
                    alert('Cannot delete videos while offline. Please connect to the internet.');
                }
            }
        }

        function editContactLink(linkId) {
            const link = contactLinksData.find(l => l.id === linkId);
            if (link) {
                const newUrl = prompt('Enter new URL:', link.url);
                const newName = prompt('Enter new display name:', link.name);
                const newStoryName = prompt('Enter new story name (leave empty for no story):', link.storyName || '');
                const newType = prompt('Enter new type (facebook, telegram, viber, other):', link.type);
                const newAccessType = prompt('Enter access type (free or password):', link.accessType);
                
                if (newUrl && newName && newType && newAccessType) {
                    if (navigator.onLine && !isOfflineMode) {
                        db.collection('contactLinks').doc(linkId).update({
                            url: newUrl,
                            name: newName,
                            storyName: newStoryName,
                            type: newType,
                            accessType: newAccessType
                        }).then(() => {
                            loadContactLinks();
                            alert('Contact link updated successfully!');
                        }).catch(error => {
                            console.error('Error updating contact link:', error);
                            alert('Error updating contact link. Please try again.');
                        });
                    } else {
                        alert('Cannot edit contact links while offline. Please connect to the internet.');
                    }
                }
            }
        }

        function deleteContactLink(linkId) {
            if (confirm('Are you sure you want to delete this contact link?')) {
                if (navigator.onLine && !isOfflineMode) {
                    db.collection('contactLinks').doc(linkId).delete().then(() => {
                        loadContactLinks();
                        alert('Contact link deleted successfully!');
                    }).catch(error => {
                        console.error('Error deleting contact link:', error);
                        alert('Error deleting contact link. Please try again.');
                    });
                } else {
                    alert('Cannot delete contact links while offline. Please connect to the internet.');
                }
            }
        }

        function generatePasswords() {
            const story = passwordStory.value;
            const count = parseInt(passwordCount.value) || 10;
            
            if (!story) {
                alert('Please select a story');
                return;
            }
            
            if (count < 1 || count > 100) {
                alert('Please enter a number between 1 and 100');
                return;
            }
            
            // Generate passwords in format: storyname.XXXXXX (6 digits)
            generateStoryPasswords(story, '', count);
        }

        function generateAdvancedPasswords() {
            const story = modalStoryName.value;
            const namePrefix = passwordNamePrefix.value;
            const count = parseInt(modalPasswordCount.value) || 10;
            
            if (!story) {
                alert('Please select a story');
                return;
            }
            
            if (count < 1 || count > 100) {
                alert('Please enter a number between 1 and 100');
                return;
            }
            
            generateStoryPasswords(story, namePrefix, count);
            passwordGenerationModal.style.display = 'none';
        }

        function generateMonthlyPasswords() {
            const story = monthlyStoryName.value;
            const duration = parseInt(monthlyDuration.value) || 1;
            const count = parseInt(monthlyPasswordCount.value) || 5;
            
            if (count < 1 || count > 20) {
                alert('Please enter a number between 1 and 20');
                return;
            }
            
            // Generate passwords in format: SD.XXXXXXX (7 digits)
            const batch = db.batch();
            const newPasswords = [];
            
            for (let i = 0; i < count; i++) {
                // Generate password in format: SD.XXXXXXX (7 random digits)
                const randomDigits = Math.floor(1000000 + Math.random() * 9000000);
                const password = `SD.${randomDigits}`;
                
                // Calculate expiration date
                const expirationDate = new Date();
                expirationDate.setMonth(expirationDate.getMonth() + duration);
                
                // Add to batch
                const passwordRef = db.collection('monthlyPasswords').doc();
                batch.set(passwordRef, {
                    password: password,
                    storyName: story || '',
                    duration: duration,
                    created: firebase.firestore.FieldValue.serverTimestamp(),
                    expirationDate: firebase.firestore.Timestamp.fromDate(expirationDate),
                    deviceId: null,
                    online: false,
                    startTime: null,
                    endTime: expirationDate.toISOString(),
                    used: false,
                    singleDevice: true, // Monthly passwords are also single device
                    maxDevices: 1
                });
                
                newPasswords.push(password);
            }
            
            // Execute batch write if online
            if (navigator.onLine && !isOfflineMode) {
                batch.commit().then(() => {
                    alert(`Successfully generated ${count} ${duration}-month password(s)!`);
                    loadMonthlyPasswords();
                    monthlyPasswordModal.style.display = 'none';
                }).catch(error => {
                    console.error('Error generating monthly passwords:', error);
                    alert('Error generating monthly passwords. Please try again.');
                });
            } else {
                alert('Cannot generate passwords while offline. Please connect to the internet.');
            }
        }

        function renderPasswordList() {
            storyPasswordsContainer.innerHTML = '';
            
            const searchTerm = passwordSearch.value.toLowerCase();
            
            // Group passwords by story
            const passwordsByStory = {};
            let filteredPasswords = passwords;
            
            // Apply search filter
            if (searchTerm) {
                filteredPasswords = passwords.filter(p => 
                    p.password.toLowerCase().includes(searchTerm) ||
                    (p.storyName && p.storyName.toLowerCase().includes(searchTerm))
                );
            }
            
            // Group by story
            filteredPasswords.forEach(password => {
                const story = password.storyName || 'No Story';
                if (!passwordsByStory[story]) {
                    passwordsByStory[story] = [];
                }
                passwordsByStory[story].push(password);
            });
            
            // Apply additional filters
            Object.keys(passwordsByStory).forEach(story => {
                let storyPasswords = passwordsByStory[story];
                
                if (currentPasswordFilter === 'used') {
                    storyPasswords = storyPasswords.filter(p => p.deviceId);
                } else if (currentPasswordFilter === 'unused') {
                    storyPasswords = storyPasswords.filter(p => !p.deviceId);
                } else if (currentPasswordFilter === 'online') {
                    storyPasswords = storyPasswords.filter(p => p.online === true);
                } else if (currentPasswordFilter === 'offline') {
                    storyPasswords = storyPasswords.filter(p => p.online === false || p.online === undefined);
                }
                
                if (storyPasswords.length > 0) {
                    renderStoryPasswordSection(story, storyPasswords);
                }
            });
            
            // Update statistics
            updatePasswordStatistics();
        }

        function renderMonthlyPasswordList() {
            monthlyPasswordList.innerHTML = '';
            
            if (monthlyPasswords.length === 0) {
                monthlyPasswordList.innerHTML = '<div style="text-align: center; padding: 20px; color: var(--gray);">No monthly passwords generated yet.</div>';
                return;
            }
            
            // Group by duration
            const passwordsByDuration = {};
            
            monthlyPasswords.forEach(password => {
                const duration = password.duration || 'Unknown';
                if (!passwordsByDuration[duration]) {
                    passwordsByDuration[duration] = [];
                }
                passwordsByDuration[duration].push(password);
            });
            
            // Render each duration group
            Object.keys(passwordsByDuration).sort((a, b) => parseInt(a) - parseInt(b)).forEach(duration => {
                const durationPasswords = passwordsByDuration[duration];
                const durationItem = document.createElement('div');
                durationItem.className = 'duration-item';
                
                // Calculate used/unused
                const usedCount = durationPasswords.filter(p => p.deviceId).length;
                const unusedCount = durationPasswords.length - usedCount;
                
                durationItem.innerHTML = `
                    <div class="duration-header">
                        <span>${duration} Month${duration > 1 ? 's' : ''}</span>
                        <span style="font-size: 8px; color: var(--accent);">${durationPasswords.length} passwords (${usedCount} used, ${unusedCount} unused)</span>
                    </div>
                    <div class="duration-passwords">
                `;
                
                // Add passwords for this duration
                durationPasswords.forEach(password => {
                    const isUsed = !!password.deviceId;
                    const passwordDiv = document.createElement('div');
                    passwordDiv.className = 'duration-password';
                    passwordDiv.innerHTML = `
                        <span>${password.password} <small style="color: var(--accent);">(Single Device)</small></span>
                        <div class="duration-actions">
                            <span class="password-status-badge ${isUsed ? 'password-status-used' : 'password-status-unused'}">
                                ${isUsed ? 'Used' : 'Unused'}
                            </span>
                            <button class="password-action-icon delete" data-id="${password.id}" data-type="monthly">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    `;
                    durationItem.querySelector('.duration-passwords').appendChild(passwordDiv);
                });
                
                durationItem.innerHTML += '</div>';
                monthlyPasswordList.appendChild(durationItem);
            });
            
            // Add event listeners for delete buttons
            monthlyPasswordList.querySelectorAll('.password-action-icon.delete[data-type="monthly"]').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const passwordId = e.target.closest('.password-action-icon').getAttribute('data-id');
                    deleteMonthlyPassword(passwordId);
                });
            });
        }

        function renderStoryPasswordSection(story, storyPasswords) {
            const section = document.createElement('div');
            section.className = 'story-passwords-section';
            
            const usedCount = storyPasswords.filter(p => p.deviceId).length;
            const unusedCount = storyPasswords.length - usedCount;
            
            section.innerHTML = `
                <div class="story-passwords-title">
                    <span>${story}</span>
                    <span class="story-passwords-count">${storyPasswords.length} passwords (${usedCount} used, ${unusedCount} unused)</span>
                </div>
                <div class="password-list-header">
                    <div class="password-header-item">Password</div>
                    <div class="password-header-item">Status</div>
                    <div class="password-header-item">Device</div>
                    <div class="password-header-item">Online</div>
                    <div class="password-header-item">Actions</div>
                </div>
            `;
            
            storyPasswords.forEach(password => {
                const isUsed = !!password.deviceId;
                const isOnline = password.online === true;
                const deviceInfo = password.deviceId ? 
                    (password.deviceId.substring(0, 8) + '...') : 'Not used';
                const isSingleDevice = password.singleDevice === true;
                
                const passwordItem = document.createElement('div');
                passwordItem.className = 'password-list-item';
                passwordItem.setAttribute('data-id', password.id);
                
                if (editingPasswordId === password.id) {
                    passwordItem.innerHTML = `
                        <div class="password-list-cell">
                            <input type="text" class="password-edit-input" value="${password.password}" id="editPassword_${password.id}">
                            ${isSingleDevice ? '<br><small style="color: var(--accent);">Single Device</small>' : ''}
                        </div>
                        <div class="password-list-cell">
                            <span class="password-status-badge ${isUsed ? 'password-status-used' : 'password-status-unused'}">
                                ${isUsed ? 'Used' : 'Unused'}
                            </span>
                        </div>
                        <div class="password-list-cell">${deviceInfo}</div>
                        <div class="password-list-cell">
                            <span class="password-status-badge ${isOnline ? 'password-status-online' : 'password-status-offline'}">
                                ${isOnline ? 'Online' : 'Offline'}
                            </span>
                        </div>
                        <div class="password-list-cell">
                            <div class="password-list-actions">
                                <button class="password-action-icon save" data-id="${password.id}"><i class="fas fa-save"></i></button>
                                <button class="password-action-icon cancel" data-id="${password.id}"><i class="fas fa-times"></i></button>
                            </div>
                        </div>
                    `;
                } else {
                    passwordItem.innerHTML = `
                        <div class="password-list-cell">
                            ${password.password}
                            ${isSingleDevice ? '<br><small style="color: var(--accent);">Single Device</small>' : ''}
                        </div>
                        <div class="password-list-cell">
                            <span class="password-status-badge ${isUsed ? 'password-status-used' : 'password-status-unused'}">
                                ${isUsed ? 'Used' : 'Unused'}
                            </span>
                        </div>
                        <div class="password-list-cell">${deviceInfo}</div>
                        <div class="password-list-cell">
                            <span class="password-status-badge ${isOnline ? 'password-status-online' : 'password-status-offline'}">
                                ${isOnline ? 'Online' : 'Offline'}
                            </span>
                        </div>
                        <div class="password-list-cell">
                            <div class="password-list-actions">
                                <button class="password-action-icon edit" data-id="${password.id}"><i class="fas fa-edit"></i></button>
                                <button class="password-action-icon delete" data-id="${password.id}"><i class="fas fa-trash"></i></button>
                            </div>
                        </div>
                    `;
                }
                
                section.appendChild(passwordItem);
            });
            
            // Add action buttons for this story
            const actionButtons = document.createElement('div');
            actionButtons.className = 'password-print-options';
            actionButtons.innerHTML = `
                <button class="print-option-btn txt" data-story="${story}"><i class="fas fa-file-alt"></i> Export ${story}</button>
                <button class="print-option-btn pdf" data-story="${story}"><i class="fas fa-file-pdf"></i> PDF ${story}</button>
                <button class="print-option-btn" data-story="${story}" style="background: var(--danger);"><i class="fas fa-trash"></i> Delete All in ${story}</button>
            `;
            section.appendChild(actionButtons);
            
            storyPasswordsContainer.appendChild(section);
            
            // Add event listeners
            section.querySelectorAll('.password-action-icon.edit').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const passwordId = e.target.closest('.password-action-icon').getAttribute('data-id');
                    startPasswordEdit(passwordId);
                });
            });
            
            section.querySelectorAll('.password-action-icon.delete').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const passwordId = e.target.closest('.password-action-icon').getAttribute('data-id');
                    deletePassword(passwordId);
                });
            });
            
            section.querySelectorAll('.password-action-icon.save').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const passwordId = e.target.closest('.password-action-icon').getAttribute('data-id');
                    savePasswordEdit(passwordId);
                });
            });
            
            section.querySelectorAll('.password-action-icon.cancel').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const passwordId = e.target.closest('.password-action-icon').getAttribute('data-id');
                    cancelPasswordEdit(passwordId);
                });
            });
            
            // Story-specific action buttons
            section.querySelectorAll('.print-option-btn[data-story]').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const story = e.target.closest('.print-option-btn').getAttribute('data-story');
                    const action = e.target.closest('.print-option-btn').textContent;
                    
                    if (action.includes('Export')) {
                        exportStoryPasswordsToTxt(story);
                    } else if (action.includes('PDF')) {
                        exportStoryPasswordsToPdf(story);
                    } else if (action.includes('Delete')) {
                        deleteAllStoryPasswords(story);
                    }
                });
            });
        }

        function startPasswordEdit(passwordId) {
            editingPasswordId = passwordId;
            renderPasswordList();
        }

        function savePasswordEdit(passwordId) {
            const newPassword = document.getElementById(`editPassword_${passwordId}`).value;
            
            if (!newPassword) {
                alert('Password cannot be empty');
                return;
            }
            
            // Check if password already exists
            const existingPassword = passwords.find(p => p.password === newPassword && p.id !== passwordId);
            if (existingPassword) {
                alert('This password already exists');
                return;
            }
            
            if (navigator.onLine && !isOfflineMode) {
                db.collection('passwords').doc(passwordId).update({
                    password: newPassword
                }).then(() => {
                    editingPasswordId = null;
                    loadPasswords();
                    alert('Password updated successfully!');
                }).catch(error => {
                    console.error('Error updating password:', error);
                    alert('Error updating password. Please try again.');
                });
            } else {
                alert('Cannot update password while offline. Please connect to the internet.');
            }
        }

        function cancelPasswordEdit(passwordId) {
            editingPasswordId = null;
            renderPasswordList();
        }

        function deletePassword(passwordId) {
            if (confirm('Are you sure you want to delete this password?')) {
                if (navigator.onLine && !isOfflineMode) {
                    db.collection('passwords').doc(passwordId).delete().then(() => {
                        loadPasswords();
                        alert('Password deleted successfully!');
                    }).catch(error => {
                        console.error('Error deleting password:', error);
                        alert('Error deleting password. Please try again.');
                    });
                } else {
                    alert('Cannot delete passwords while offline. Please connect to the internet.');
                }
            }
        }

        function deleteMonthlyPassword(passwordId) {
            if (confirm('Are you sure you want to delete this monthly password?')) {
                if (navigator.onLine && !isOfflineMode) {
                    db.collection('monthlyPasswords').doc(passwordId).delete().then(() => {
                        loadMonthlyPasswords();
                        alert('Monthly password deleted successfully!');
                    }).catch(error => {
                        console.error('Error deleting monthly password:', error);
                        alert('Error deleting monthly password. Please try again.');
                    });
                } else {
                    alert('Cannot delete passwords while offline. Please connect to the internet.');
                }
            }
        }

        function deleteUsedPasswords() {
            const usedPasswords = passwords.filter(p => p.deviceId);
            
            if (usedPasswords.length === 0) {
                alert('No used passwords to delete.');
                return;
            }
            
            if (confirm(`Are you sure you want to delete ${usedPasswords.length} used passwords? This action cannot be undone.`)) {
                if (navigator.onLine && !isOfflineMode) {
                    const batch = db.batch();
                    
                    usedPasswords.forEach(password => {
                        const passwordRef = db.collection('passwords').doc(password.id);
                        batch.delete(passwordRef);
                    });
                    
                    batch.commit().then(() => {
                        alert(`Successfully deleted ${usedPasswords.length} used passwords!`);
                        loadPasswords();
                    }).catch(error => {
                        console.error('Error deleting used passwords:', error);
                        alert('Error deleting used passwords. Please try again.');
                    });
                } else {
                    alert('Cannot delete passwords while offline. Please connect to the internet.');
                }
            }
        }

        function deleteUnusedPasswords() {
            const unusedPasswords = passwords.filter(p => !p.deviceId);
            
            if (unusedPasswords.length === 0) {
                alert('No unused passwords to delete.');
                return;
            }
            
            if (confirm(`Are you sure you want to delete ${unusedPasswords.length} unused passwords? This action cannot be undone.`)) {
                if (navigator.onLine && !isOfflineMode) {
                    const batch = db.batch();
                    
                    unusedPasswords.forEach(password => {
                        const passwordRef = db.collection('passwords').doc(password.id);
                        batch.delete(passwordRef);
                    });
                    
                    batch.commit().then(() => {
                        alert(`Successfully deleted ${unusedPasswords.length} unused passwords!`);
                        loadPasswords();
                    }).catch(error => {
                        console.error('Error deleting unused passwords:', error);
                        alert('Error deleting unused passwords. Please try again.');
                    });
                } else {
                    alert('Cannot delete passwords while offline. Please connect to the internet.');
                }
            }
        }

        function deleteAllPasswords() {
            if (passwords.length === 0) {
                alert('No passwords to delete.');
                return;
            }
            
            if (confirm(`Are you sure you want to delete ALL ${passwords.length} passwords? This action cannot be undone.`)) {
                if (navigator.onLine && !isOfflineMode) {
                    const batch = db.batch();
                    
                    passwords.forEach(password => {
                        const passwordRef = db.collection('passwords').doc(password.id);
                        batch.delete(passwordRef);
                    });
                    
                    batch.commit().then(() => {
                        alert(`Successfully deleted all ${passwords.length} passwords!`);
                        loadPasswords();
                    }).catch(error => {
                        console.error('Error deleting all passwords:', error);
                        alert('Error deleting all passwords. Please try again.');
                    });
                } else {
                    alert('Cannot delete passwords while offline. Please connect to the internet.');
                }
            }
        }

        function deleteAllStoryPasswords(story) {
            const storyPasswords = passwords.filter(p => p.storyName === story);
            
            if (storyPasswords.length === 0) {
                alert(`No passwords found for story "${story}"!`);
                return;
            }
            
            if (confirm(`Are you sure you want to delete all ${storyPasswords.length} passwords for "${story}"? This action cannot be undone.`)) {
                if (navigator.onLine && !isOfflineMode) {
                    const batch = db.batch();
                    
                    storyPasswords.forEach(password => {
                        const passwordRef = db.collection('passwords').doc(password.id);
                        batch.delete(passwordRef);
                    });
                    
                    batch.commit().then(() => {
                        alert(`Successfully deleted ${storyPasswords.length} passwords for "${story}"!`);
                        loadPasswords();
                    }).catch(error => {
                        console.error('Error deleting story passwords:', error);
                        alert('Error deleting story passwords. Please try again.');
                    });
                } else {
                    alert('Cannot delete passwords while offline. Please connect to the internet.');
                }
            }
        }

        function updatePasswordStatistics() {
            const total = passwords.length;
            const used = passwords.filter(p => p.deviceId).length;
            const unused = total - used;
            const storyCount = new Set(passwords.map(p => p.storyName)).size;
            
            totalPasswordsElement.textContent = total;
            usedPasswordsElement.textContent = used;
            unusedPasswordsElement.textContent = unused;
            storyCountElement.textContent = storyCount;
        }

        function updateDeviceStatistics() {
            const total = devices.length;
            const online = devices.filter(d => d.online === true).length;
            const offline = total - online;
            
            // Count active passwords (passwords with deviceId)
            const activePasswords = passwords.filter(p => p.deviceId).length + 
                                   monthlyPasswords.filter(p => p.deviceId).length;
            
            totalDevicesElement.textContent = total;
            onlineDevicesElement.textContent = online;
            offlineDevicesElement.textContent = offline;
            activePasswordsElement.textContent = activePasswords;
        }

        function renderDeviceList() {
            deviceListContainer.innerHTML = '';
            
            if (devices.length === 0) {
                deviceListContainer.innerHTML = '<div style="text-align: center; padding: 10px; color: var(--gray);">No devices registered yet.</div>';
                return;
            }
            
            // Sort devices by last seen (newest first)
            const sortedDevices = [...devices].sort((a, b) => {
                const timeA = a.lastSeen ? new Date(a.lastSeen).getTime() : 0;
                const timeB = b.lastSeen ? new Date(b.lastSeen).getTime() : 0;
                return timeB - timeA;
            });
            
            sortedDevices.forEach(device => {
                const deviceItem = document.createElement('div');
                deviceItem.className = 'device-list-item';
                
                const lastSeen = device.lastSeen ? 
                    new Date(device.lastSeen).toLocaleString() : 
                    'Never';
                
                deviceItem.innerHTML = `
                    <div class="device-info-text">
                        <div style="font-weight: 600; font-size: 9px;">${device.deviceType}</div>
                        <div style="font-size: 7px; color: var(--gray);">ID: ${device.id.substring(0, 15)}...</div>
                        <div style="font-size: 7px; color: var(--gray);">Last seen: ${lastSeen}</div>
                    </div>
                    <span class="device-status-badge ${device.online ? 'device-online' : 'device-offline'}">
                        ${device.online ? 'Online' : 'Offline'}
                    </span>
                `;
                
                deviceListContainer.appendChild(deviceItem);
            });
        }

        function renderContactLinksScreen() {
            contactLinksScreenList.innerHTML = '';
            
            contactLinksData.forEach(link => {
                // Check if link is free or requires password
                const isFree = link.accessType === 'free';
                const isUnlocked = isUserLoggedIn || 
                    (!link.storyName) || 
                    (link.storyName && unlockedStories.includes(link.storyName)) ||
                    activeTimePassword;
                
                if (isFree || isUnlocked) {
                    const linkItem = document.createElement('div');
                    linkItem.className = 'contact-link-screen-item';
                    
                    // Set appropriate icon based on link type
                    let icon = '';
                    let btnClass = 'contact-link-screen-btn ';
                    switch(link.type) {
                        case 'facebook':
                            icon = '<i class="fab fa-facebook-f"></i>';
                            btnClass += 'facebook-screen-btn';
                            break;
                        case 'telegram':
                            icon = '<i class="fab fa-telegram"></i>';
                            btnClass += 'telegram-screen-btn';
                            break;
                        case 'viber':
                            icon = '<i class="fab fa-viber"></i>';
                            btnClass += 'viber-screen-btn';
                            break;
                        default:
                            icon = '<i class="fas fa-link"></i>';
                            btnClass += 'other-screen-btn';
                    }
                    
                    linkItem.innerHTML = `
                        <div class="contact-link-screen-icon">${icon}</div>
                        <div class="contact-link-screen-info">
                            <div class="contact-link-screen-name">${link.name}</div>
                            <div class="contact-link-screen-type">${link.type.charAt(0).toUpperCase() + link.type.slice(1)} ${link.storyName ? ` ${link.storyName}` : ''}</div>
                        </div>
                        <a href="${link.url}" target="_blank" class="${btnClass}"><i class="fas fa-external-link-alt"></i> Open</a>
                    `;
                    
                    contactLinksScreenList.appendChild(linkItem);
                }
            });
        }

        function renderAdminContactLinksList() {
            contactLinksAdminList.innerHTML = '';
            
            contactLinksData.forEach(link => {
                const linkItem = document.createElement('div');
                linkItem.className = `contact-link-item ${link.accessType === 'free' ? 'free' : 'password-protected'}`;
                
                linkItem.innerHTML = `
                    <div class="contact-link-info">
                        <h4 style="font-size: 9px;">${link.name} 
                            <span class="contact-link-badge ${link.accessType === 'password' ? 'password' : ''}">
                                ${link.accessType === 'free' ? 'Free' : 'Password Protected'}
                            </span>
                        </h4>
                        <p style="font-size: 8px;">Type: ${link.type}</p>
                        <p style="font-size: 8px;">Story: ${link.storyName || 'No Story'}</p>
                        <p style="font-size: 8px;">URL: ${link.url}</p>
                    </div>
                    <div class="contact-link-actions">
                        <button class="edit-btn" data-id="${link.id}"><i class="fas fa-edit"></i> Edit</button>
                        <button class="delete-btn" data-id="${link.id}"><i class="fas fa-trash"></i> Delete</button>
                    </div>
                `;
                
                contactLinksAdminList.appendChild(linkItem);
            });
            
            // Add event listeners for edit and delete buttons
            document.querySelectorAll('.contact-link-actions .edit-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const linkId = e.target.getAttribute('data-id');
                    editContactLink(linkId);
                });
            });
            
            document.querySelectorAll('.contact-link-actions .delete-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const linkId = e.target.getAttribute('data-id');
                    deleteContactLink(linkId);
                });
            });
        }

        function exportStoryPasswordsToTxt(story = null) {
            let storyPasswords;
            let filename;
            
            if (story) {
                storyPasswords = passwords.filter(p => p.storyName === story);
                filename = `${story}-passwords-${new Date().toISOString().split('T')[0]}.txt`;
            } else {
                storyPasswords = passwords;
                filename = `all-passwords-${new Date().toISOString().split('T')[0]}.txt`;
            }
            
            if (storyPasswords.length === 0) {
                alert(`No passwords found!`);
                return;
            }
            
            let content = `Kachin Visions Empire - Password List\n`;
            content += 'Generated on: ' + new Date().toLocaleString() + '\n\n';
            
            if (story) {
                content += `Story: ${story}\n`;
            }
            
            content += '='.repeat(50) + '\n\n';
            
            // Group by story if exporting all
            if (!story) {
                const passwordsByStory = {};
                storyPasswords.forEach(password => {
                    const storyName = password.storyName || 'No Story';
                    if (!passwordsByStory[storyName]) {
                        passwordsByStory[storyName] = [];
                    }
                    passwordsByStory[storyName].push(password);
                });
                
                Object.keys(passwordsByStory).forEach(storyName => {
                    content += `\n${storyName}:\n`;
                    content += '-'.repeat(storyName.length) + '\n';
                    
                    passwordsByStory[storyName].forEach((password, index) => {
                        content += `${index + 1}. ${password.password}`;
                        if (password.singleDevice) {
                            content += ` [Single Device]`;
                        }
                        if (password.deviceId) {
                            content += ` (Used by device: ${password.deviceId.substring(0, 10)}...)`;
                        }
                        if (password.online === true) {
                            content += ` [Online]`;
                        } else if (password.online === false) {
                            content += ` [Offline]`;
                        }
                        content += '\n';
                    });
                });
            } else {
                storyPasswords.forEach((password, index) => {
                    content += `${index + 1}. ${password.password}`;
                    if (password.singleDevice) {
                        content += ` [Single Device]`;
                    }
                    if (password.deviceId) {
                        content += ` (Used by device: ${password.deviceId.substring(0, 10)}...)`;
                    }
                    if (password.online === true) {
                        content += ` [Online]`;
                    } else if (password.online === false) {
                        content += ` [Offline]`;
                    }
                    content += '\n';
                });
            }
            
            const blob = new Blob([content], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            alert(`Exported ${storyPasswords.length} passwords to TXT file!`);
        }

        function exportStoryPasswordsToPdf(story = null) {
            let storyPasswords;
            let filename;
            
            if (story) {
                storyPasswords = passwords.filter(p => p.storyName === story);
                filename = `${story}-passwords-${new Date().toISOString().split('T')[0]}.pdf`;
            } else {
                storyPasswords = passwords;
                filename = `all-passwords-${new Date().toISOString().split('T')[0]}.pdf`;
            }
            
            if (storyPasswords.length === 0) {
                alert(`No passwords found!`);
                return;
            }
            
            // Use jsPDF library
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // Add title
            doc.setFontSize(14);
            doc.setTextColor(40);
            doc.text('Kachin Visions Empire - Password List', 20, 15);
            doc.setFontSize(10);
            doc.text('Generated on: ' + new Date().toLocaleString(), 20, 25);
            
            if (story) {
                doc.text(`Story: ${story}`, 20, 35);
            }
            
            let yPosition = story ? 45 : 35;
            doc.setFontSize(9);
            
            // Group by story if exporting all
            if (!story) {
                const passwordsByStory = {};
                storyPasswords.forEach(password => {
                    const storyName = password.storyName || 'No Story';
                    if (!passwordsByStory[storyName]) {
                        passwordsByStory[storyName] = [];
                    }
                    passwordsByStory[storyName].push(password);
                });
                
                Object.keys(passwordsByStory).forEach(storyName => {
                    if (yPosition > 270) {
                        doc.addPage();
                        yPosition = 15;
                    }
                    
                    doc.setFontSize(10);
                    doc.setTextColor(0, 0, 255);
                    doc.text(storyName, 20, yPosition);
                    yPosition += 8;
                    
                    doc.setFontSize(9);
                    doc.setTextColor(0);
                    
                    passwordsByStory[storyName].forEach((password, index) => {
                        if (yPosition > 270) {
                            doc.addPage();
                            yPosition = 15;
                        }
                        
                        let passwordText = `${index + 1}. ${password.password}`;
                        if (password.singleDevice) {
                            passwordText += ` [SD]`;
                        }
                        if (password.deviceId) {
                            passwordText += ` (Used)`;
                        }
                        if (password.online === true) {
                            passwordText += ` [Online]`;
                        } else if (password.online === false) {
                            passwordText += ` [Offline]`;
                        }
                        
                        doc.text(passwordText, 25, yPosition);
                        yPosition += 8;
                    });
                    
                    yPosition += 5; // Add spacing between stories
                });
            } else {
                storyPasswords.forEach((password, index) => {
                    if (yPosition > 270) {
                        doc.addPage();
                        yPosition = 15;
                    }
                    
                    let passwordText = `${index + 1}. ${password.password}`;
                    if (password.singleDevice) {
                        passwordText += ` [SD]`;
                    }
                    if (password.deviceId) {
                        passwordText += ` (Used)`;
                    }
                    if (password.online === true) {
                        passwordText += ` [Online]`;
                    } else if (password.online === false) {
                        passwordText += ` [Offline]`;
                    }
                    
                    doc.text(passwordText, 20, yPosition);
                    yPosition += 8;
                });
            }
            
            // Save the PDF
            doc.save(filename);
            
            alert(`Exported ${storyPasswords.length} passwords to PDF file!`);
        }

        function exportAllPasswords() {
            exportStoryPasswordsToTxt();
        }

        // ============================================
        // PASSWORD UNLOCK FUNCTIONALITY (Single Device Check)
        // ============================================
        function unlockVideos() {
            const password = document.getElementById('password').value;
            
            if (!password) {
                loginStatus.textContent = 'Please enter a password';
                loginStatus.style.color = 'var(--danger)';
                return;
            }
            
            // Check if password matches any password in the database
            const validPassword = passwords.find(p => p.password === password);
            const validMonthlyPassword = monthlyPasswords.find(p => p.password === password);
            
            // Check if password matches any story-based password
            let validStoryPassword = null;
            if (!validPassword && !validMonthlyPassword) {
                // Look for story password format: storyname.XXXXXX or prefix.storyname.XXXXXX
                const passwordParts = password.split('.');
                if (passwordParts.length >= 2) {
                    // Check if last part is 6 digits (story password format)
                    const lastPart = passwordParts[passwordParts.length - 1];
                    if (/^\d{6}$/.test(lastPart)) {
                        // This could be a story password
                        // Find matching story in passwords collection
                        validStoryPassword = passwords.find(p => p.password === password);
                    }
                }
            }
            
            if (validPassword || validStoryPassword) {
                // Handle story password unlock
                const passwordToUse = validPassword || validStoryPassword;
                const storyName = passwordToUse.storyName;
                
                // Check single device restriction
                if (passwordToUse.singleDevice && passwordToUse.deviceId && passwordToUse.deviceId !== currentDeviceId) {
                    loginStatus.textContent = 'This password is already registered to another device. Single device access only.';
                    loginStatus.style.color = 'var(--danger)';
                    return;
                }
                
                // Update password's device information in Firestore if online
                if (navigator.onLine && !isOfflineMode) {
                    const passwordRef = db.collection('passwords').doc(passwordToUse.id);
                    
                    passwordRef.update({
                        deviceId: currentDeviceId,
                        loginTime: new Date().toISOString(),
                        online: true,
                        startTime: new Date().toISOString(),
                        used: true
                    }).then(() => {
                        // Update local passwords array
                        passwordToUse.deviceId = currentDeviceId;
                        passwordToUse.loginTime = new Date().toISOString();
                        passwordToUse.online = true;
                        passwordToUse.startTime = new Date().toISOString();
                        passwordToUse.used = true;
                        
                        completeStoryPasswordUnlockProcess(password, storyName);
                    }).catch(error => {
                        console.error('Error updating password device info:', error);
                        alert('Error unlocking videos. Please try again.');
                    });
                } else {
                    // Offline mode - update local data only
                    passwordToUse.deviceId = currentDeviceId;
                    passwordToUse.loginTime = new Date().toISOString();
                    passwordToUse.online = false;
                    passwordToUse.startTime = new Date().toISOString();
                    passwordToUse.used = true;
                    
                    completeStoryPasswordUnlockProcess(password, storyName);
                }
            } else if (validMonthlyPassword) {
                // Check single device restriction for monthly passwords
                if (validMonthlyPassword.singleDevice && validMonthlyPassword.deviceId && validMonthlyPassword.deviceId !== currentDeviceId) {
                    loginStatus.textContent = 'This password is already registered to another device. Single device access only.';
                    loginStatus.style.color = 'var(--danger)';
                    return;
                }
                
                // Check if password is expired
                if (validMonthlyPassword.expirationDate) {
                    const expirationDate = validMonthlyPassword.expirationDate.toDate
                        ? validMonthlyPassword.expirationDate.toDate()
                        : new Date(validMonthlyPassword.expirationDate);
                    
                    if (new Date() > expirationDate) {
                        loginStatus.textContent = 'This password has expired.';
                        loginStatus.style.color = 'var(--danger)';
                        return;
                    }
                }
                
                // Update monthly password's device information in Firestore if online
                if (navigator.onLine && !isOfflineMode) {
                    const passwordRef = db.collection('monthlyPasswords').doc(validMonthlyPassword.id);
                    
                    const updateData = {
                        deviceId: currentDeviceId,
                        loginTime: new Date().toISOString(),
                        online: true,
                        startTime: new Date().toISOString(),
                        used: true
                    };
                    
                    // If this is the first time using, set the start time
                    if (!validMonthlyPassword.startTime) {
                        updateData.startTime = new Date().toISOString();
                        // Calculate end time based on duration
                        if (validMonthlyPassword.duration) {
                            const endTime = new Date();
                            endTime.setMonth(endTime.getMonth() + validMonthlyPassword.duration);
                            updateData.endTime = endTime.toISOString();
                        }
                    }
                    
                    passwordRef.update(updateData).then(() => {
                        // Update local monthly passwords array
                        validMonthlyPassword.deviceId = currentDeviceId;
                        validMonthlyPassword.loginTime = new Date().toISOString();
                        validMonthlyPassword.online = true;
                        validMonthlyPassword.startTime = updateData.startTime;
                        validMonthlyPassword.endTime = updateData.endTime || validMonthlyPassword.endTime;
                        validMonthlyPassword.used = true;
                        
                        completeMonthlyUnlockProcess(password, validMonthlyPassword);
                    }).catch(error => {
                        console.error('Error updating monthly password device info:', error);
                        alert('Error unlocking videos. Please try again.');
                    });
                } else {
                    // Offline mode - update local data only
                    validMonthlyPassword.deviceId = currentDeviceId;
                    validMonthlyPassword.loginTime = new Date().toISOString();
                    validMonthlyPassword.online = false;
                    if (!validMonthlyPassword.startTime) {
                        validMonthlyPassword.startTime = new Date().toISOString();
                        if (validMonthlyPassword.duration) {
                            const endTime = new Date();
                            endTime.setMonth(endTime.getMonth() + validMonthlyPassword.duration);
                            validMonthlyPassword.endTime = endTime.toISOString();
                        }
                    }
                    validMonthlyPassword.used = true;
                    
                    completeMonthlyUnlockProcess(password, validMonthlyPassword);
                }
            } else {
                // Check if it's a time-based password
                const timePassword = timeBasedPasswords[password];
                if (timePassword) {
                    // Check single device restriction for time passwords
                    if (timePassword.singleDevice && timePassword.deviceId && timePassword.deviceId !== currentDeviceId) {
                        loginStatus.textContent = 'This password is already registered to another device. Single device access only.';
                        loginStatus.style.color = 'var(--danger)';
                        return;
                    }
                    
                    // Check if password is expired
                    const expirationDate = timePassword.expirationDate.toDate();
                    if (new Date() > expirationDate) {
                        loginStatus.textContent = 'This password has expired.';
                        loginStatus.style.color = 'var(--danger)';
                        return;
                    }
                    
                    // Update time password's device information in Firestore if online
                    if (navigator.onLine && !isOfflineMode) {
                        const passwordRef = db.collection('timePasswords').doc(password);
                        
                        passwordRef.update({
                            deviceId: currentDeviceId,
                            loginTime: new Date().toISOString()
                        }).then(() => {
                            // Update local time passwords
                            timePassword.deviceId = currentDeviceId;
                            timePassword.loginTime = new Date().toISOString();
                            
                            completeTimeUnlockProcess(password, timePassword);
                        }).catch(error => {
                            console.error('Error updating time password device info:', error);
                            alert('Error unlocking videos. Please try again.');
                        });
                    } else {
                        // Offline mode - update local data only
                        timePassword.deviceId = currentDeviceId;
                        timePassword.loginTime = new Date().toISOString();
                        
                        completeTimeUnlockProcess(password, timePassword);
                    }
                } else {
                    loginStatus.textContent = 'Invalid password. Please try again.';
                    loginStatus.style.color = 'var(--danger)';
                }
            }
        }

        function completeStoryPasswordUnlockProcess(password, storyName) {
            // Verify the password format matches the story name
            const passwordParts = password.split('.');
            let passwordStoryName = '';
            
            if (passwordParts.length === 2) {
                // Format: storyname.XXXXXX
                passwordStoryName = passwordParts[0];
            } else if (passwordParts.length === 3) {
                // Format: prefix.storyname.XXXXXX
                passwordStoryName = passwordParts[1];
            }
            
            // Check if the password's story name matches the actual story name
            if (passwordStoryName.toLowerCase() !== storyName.toLowerCase()) {
                loginStatus.textContent = 'Password does not match story name. Access denied.';
                loginStatus.style.color = 'var(--danger)';
                alert('Error: Password story name does not match. Access denied.');
                return;
            }
            
            // Auto-remember the password
            rememberPassword('global', password, { storyName: storyName });
            
            // Unlock only videos from the matching story
            unlockVideosForStory(storyName);
            
            // Set up real-time session tracking if online
            if (navigator.onLine && !isOfflineMode) {
                setupUserSession(password);
            }
            
            alert(`Videos from story "${storyName}" unlocked successfully!`);
            
            // Update device statistics
            updateDeviceStatistics();
        }

        function unlockVideosForStory(storyName) {
            // Unlock only videos from the matching story
            document.querySelectorAll('.video-item').forEach(item => {
                const itemText = item.querySelector('p')?.textContent || '';
                if (itemText.includes(` ${storyName}`) || itemText.includes(storyName)) {
                    item.classList.remove('locked');
                }
            });
            
            // Also unlock story for story-specific access
            if (!unlockedStories.includes(storyName)) {
                unlockedStories.push(storyName);
            }
            
            // Update login status
            loginStatus.textContent = `Videos from story "${storyName}" unlocked successfully!`;
            loginStatus.style.color = 'var(--success)';
            
            // Update contact links screen to show password-protected ones from this story
            renderContactLinksScreen();
        }

        function completeMonthlyUnlockProcess(password, monthlyPassword) {
            // Auto-remember the password
            rememberPassword('monthly', password, { 
                duration: monthlyPassword.duration,
                expiry: monthlyPassword.endTime || new Date(Date.now() + monthlyPassword.duration * 30 * 24 * 60 * 60 * 1000).toISOString()
            });
            
            unlockAllContentWithMonthlyPassword(monthlyPassword);
            
            // Set up real-time session tracking if online
            if (navigator.onLine && !isOfflineMode) {
                setupUserSession(password);
            }
            
            const durationText = monthlyPassword.duration > 1 ? 
                `${monthlyPassword.duration} months` : '1 month';
            alert(`All content unlocked successfully! Access will be valid for ${durationText}.`);
            
            // Update device statistics
            updateDeviceStatistics();
        }

        function unlockAllContentWithMonthlyPassword(monthlyPassword) {
            isUserLoggedIn = true;
            
            // Unlock all videos
            document.querySelectorAll('.video-item').forEach(item => {
                if (!item.classList.contains('free')) {
                    item.classList.remove('locked');
                }
            });
            
            // Update login status
            loginStatus.textContent = `All content unlocked with ${monthlyPassword.duration}-month password!`;
            loginStatus.style.color = 'var(--success)';
            
            // Update contact links screen to show password-protected ones
            renderContactLinksScreen();
            
            // Show password timer if end time is set
            if (monthlyPassword.endTime) {
                const endTime = new Date(monthlyPassword.endTime);
                startPasswordExpirationTimer(endTime);
                passwordTimerDisplay.style.display = 'block';
            }
        }

        function completeTimeUnlockProcess(password, timePassword) {
            // Save time password for auto-remember
            rememberPassword('time', password, { 
                expiry: timePassword.expirationDate.toDate().toISOString() 
            });
            
            // Set active time password
            activeTimePassword = password;
            
            // Unlock all content
            unlockAllContentWithTimePassword();
            
            // Start expiration timer
            startPasswordExpirationTimer(timePassword.expirationDate.toDate());
            
            alert(`All videos and contact links unlocked successfully! Access will expire on ${timePassword.expirationDate.toDate().toLocaleDateString()}.`);
            
            // Update device statistics
            updateDeviceStatistics();
        }

        function unlockAllContentWithTimePassword() {
            isUserLoggedIn = true;
            
            // Unlock all videos
            document.querySelectorAll('.video-item').forEach(item => {
                if (!item.classList.contains('free')) {
                    item.classList.remove('locked');
                }
            });
            
            // Update login status
            loginStatus.textContent = `All content unlocked with time-based password!`;
            loginStatus.style.color = 'var(--success)';
            
            // Update contact links screen to show password-protected ones
            renderContactLinksScreen();
            
            // Show password timer
            passwordTimerDisplay.style.display = 'block';
        }

        function startPasswordExpirationTimer(expirationDate) {
            // Clear any existing timer
            if (passwordExpirationTimer) {
                clearInterval(passwordExpirationTimer);
            }
            
            // Update timer immediately
            updatePasswordTimer(expirationDate);
            
            // Update timer every second
            passwordExpirationTimer = setInterval(() => {
                updatePasswordTimer(expirationDate);
            }, 1000);
        }

        function updatePasswordTimer(expirationDate) {
            const now = new Date();
            const timeLeft = expirationDate - now;
            
            if (timeLeft <= 0) {
                // Password expired
                timerText.textContent = 'Password expired!';
                lockTimeBasedContent();
                clearInterval(passwordExpirationTimer);
                return;
            }
            
            // Calculate days, hours, minutes, seconds
            const days = Math.floor(timeLeft / (1000 * 60 * 60 * 24));
            const hours = Math.floor((timeLeft % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const minutes = Math.floor((timeLeft % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((timeLeft % (1000 * 60)) / 1000);
            
            // Format timer text
            let timerString = 'Password expires in: ';
            if (days > 0) {
                timerString += `${days}d `;
            }
            timerString += `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            
            timerText.textContent = timerString;
        }

        function lockTimeBasedContent() {
            // Clear active password
            activeTimePassword = null;
            
            // Remove from localStorage
            localStorage.removeItem('timePassword');
            localStorage.removeItem('timePasswordExpiration');
            localStorage.removeItem('monthlyPassword');
            localStorage.removeItem('monthlyPasswordExpiry');
            
            // Hide timer
            passwordTimerDisplay.style.display = 'none';
            
            // Reset login status
            isUserLoggedIn = false;
            loginStatus.textContent = 'Please enter your password to unlock all videos';
            loginStatus.style.color = 'var(--accent)';
            
            // Re-render video list to show locked state
            renderVideoLibraryWithDownloads();
            
            // Re-render contact links screen
            renderContactLinksScreen();
            
            alert('Your access has expired or been revoked. All content is now locked.');
        }

        function checkActiveMonthlyPassword() {
            const rememberedPasswords = JSON.parse(localStorage.getItem('rememberedPasswords') || '{}');
            
            if (rememberedPasswords.monthly) {
                const monthlyData = rememberedPasswords.monthly;
                const now = new Date();
                const expiry = new Date(monthlyData.expiry);
                
                if (now < expiry) {
                    // Password is still valid
                    const validPassword = monthlyPasswords.find(p => p.password === monthlyData.password);
                    if (validPassword) {
                        // Check single device restriction
                        if (validPassword.singleDevice && validPassword.deviceId && validPassword.deviceId !== currentDeviceId) {
                            // Clear remembered password
                            delete rememberedPasswords.monthly;
                            localStorage.setItem('rememberedPasswords', JSON.stringify(rememberedPasswords));
                            return;
                        }
                        
                        // Auto-login with remembered password
                        document.getElementById('password').value = monthlyData.password;
                        unlockVideos();
                    } else {
                        // Clear invalid remembered password
                        delete rememberedPasswords.monthly;
                        localStorage.setItem('rememberedPasswords', JSON.stringify(rememberedPasswords));
                    }
                } else {
                    // Clear expired password
                    delete rememberedPasswords.monthly;
                    localStorage.setItem('rememberedPasswords', JSON.stringify(rememberedPasswords));
                }
            }
        }

        function checkActiveTimePassword() {
            const rememberedPasswords = JSON.parse(localStorage.getItem('rememberedPasswords') || '{}');
            
            if (rememberedPasswords.time) {
                const timeData = rememberedPasswords.time;
                const now = new Date();
                const expiry = new Date(timeData.expiry);
                
                if (now < expiry) {
                    // Password is still valid
                    activeTimePassword = timeData.password;
                    unlockAllContentWithTimePassword();
                    startPasswordExpirationTimer(expiry);
                } else {
                    // Password expired
                    delete rememberedPasswords.time;
                    localStorage.setItem('rememberedPasswords', JSON.stringify(rememberedPasswords));
                }
            }
        }

        function setupUserSession(password) {
            if (!navigator.onLine || isOfflineMode) return;
            
            userSessionRef = rtdb.ref('userSessions/' + password + '/' + currentDeviceId);
            
            // Set session data
            userSessionRef.set({
                loginTime: new Date().toISOString(),
                lastActive: firebase.database.ServerValue.TIMESTAMP,
                deviceInfo: navigator.userAgent,
                online: true
            });
            
            // Update last active timestamp periodically
            setInterval(() => {
                if (userSessionRef && navigator.onLine && !isOfflineMode) {
                    userSessionRef.update({
                        lastActive: firebase.database.ServerValue.TIMESTAMP,
                        online: true
                    });
                }
            }, 30000); // Update every 30 seconds
            
            // Set up disconnect handler
            userSessionRef.onDisconnect().update({
                online: false,
                lastActive: firebase.database.ServerValue.TIMESTAMP
            });
        }

        function updatePasswordOnlineStatus() {
            if (navigator.onLine && !isOfflineMode) {
                // Update all passwords' online status in real-time database
                passwords.forEach(password => {
                    if (password.deviceId) {
                        const sessionRef = rtdb.ref('userSessions/' + password.password + '/' + password.deviceId);
                        sessionRef.once('value').then(snapshot => {
                            const data = snapshot.val();
                            if (data && data.online === true) {
                                // Update Firestore with online status
                                db.collection('passwords').doc(password.id).update({
                                    online: true
                                });
                            } else {
                                db.collection('passwords').doc(password.id).update({
                                    online: false
                                });
                            }
                        });
                    }
                });
                
                // Update monthly passwords' online status
                monthlyPasswords.forEach(password => {
                    if (password.deviceId) {
                        const sessionRef = rtdb.ref('userSessions/' + password.password + '/' + password.deviceId);
                        sessionRef.once('value').then(snapshot => {
                            const data = snapshot.val();
                            if (data && data.online === true) {
                                // Update Firestore with online status
                                db.collection('monthlyPasswords').doc(password.id).update({
                                    online: true
                                });
                            } else {
                                db.collection('monthlyPasswords').doc(password.id).update({
                                    online: false
                                });
                            }
                        });
                    }
                });
            }
        }

        // ============================================
        // SCREEN MANAGEMENT FUNCTIONS
        // ============================================
        function showScreen(screenNumber) {
            screens.forEach(screen => {
                screen.classList.remove('active');
            });
            
            document.getElementById(`screen${screenNumber}`).classList.add('active');
        }

        // ============================================
        // ADMIN LOGIN FUNCTION
        // ============================================
        function adminLogin() {
            const username = document.getElementById('adminUsername').value;
            const password = document.getElementById('adminPassword').value;
            
            // Fixed admin credentials
            if (username === 'Sun Day' && password === 'sunday@video!01234') {
                isAdmin = true;
                showScreen(2);
                loginModal.style.display = 'none';
                loginMessage.textContent = '';
                
                // Create a mock user for admin
                currentUser = {
                    uid: 'admin',
                    email: 'sunday@video.com'
                };
                
                // Load contact links data and admin message into admin panel
                loadContactLinks();
                loadAdminMessage();
            } else {
                loginMessage.textContent = 'Invalid credentials. Please try again.';
                loginMessage.style.color = 'var(--danger)';
            }
        }

        // ============================================
        // ADMIN MESSAGE FUNCTIONS
        // ============================================
        function loadAdminMessage() {
            // Try to load from Firebase first
            if (navigator.onLine && !isOfflineMode) {
                db.collection('settings').doc('adminMessage').get().then(doc => {
                    if (doc.exists) {
                        const data = doc.data();
                        adminMessageData = data;
                        
                        // Render the admin message
                        renderAdminMessage();
                    } else {
                        // No admin message exists yet
                        adminMessageContent.textContent = 'No message from admin yet.';
                    }
                }).catch(error => {
                    console.error('Error loading admin message from Firebase:', error);
                    // Fall back to default
                    adminMessageContent.textContent = 'No message from admin yet.';
                });
            } else {
                // Offline mode
                adminMessageContent.textContent = 'No message from admin yet.';
            }
        }

        function renderAdminMessage() {
            if (adminMessageData.content) {
                adminMessageContent.innerHTML = adminMessageData.content;
            } else {
                adminMessageContent.textContent = 'No message from admin yet.';
            }
        }

        function saveAdminMessageData() {
            // Get content from editor
            const content = adminMessageEditor.innerHTML;
            
            // Update admin message data
            adminMessageData = {
                content: content,
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            };
            
            // Save to Firebase if online
            if (navigator.onLine && !isOfflineMode) {
                db.collection('settings').doc('adminMessage').set(adminMessageData)
                .then(() => {
                    alert('Admin message saved successfully!');
                    
                    // Update the displayed message
                    renderAdminMessage();
                })
                .catch(error => {
                    console.error('Error saving admin message:', error);
                    alert('Error saving admin message. Please try again.');
                });
            } else {
                alert('Cannot save admin message while offline. Please connect to the internet.');
            }
        }

        // ============================================
        // RICH TEXT EDITOR FUNCTIONS
        // ============================================
        function initRichTextEditor() {
            // Toolbar button click handlers
            toolbarBtns.forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.preventDefault();
                    const command = btn.getAttribute('data-command');
                    
                    if (command) {
                        document.execCommand(command, false, null);
                        adminMessageEditor.focus();
                    }
                });
            });
            
            // Font family change handler
            fontFamilySelect.addEventListener('change', () => {
                const fontFamily = fontFamilySelect.value;
                if (fontFamily) {
                    document.execCommand('fontName', false, fontFamily);
                    adminMessageEditor.style.fontFamily = fontFamily;
                    adminMessageEditor.focus();
                }
            });
            
            // Font size change handler
            fontSizeSelect.addEventListener('change', () => {
                const fontSize = fontSizeSelect.value;
                if (fontSize) {
                    document.execCommand('fontSize', false, fontSize);
                    adminMessageEditor.focus();
                }
            });
            
            // Text color change handler
            textColorInput.addEventListener('change', () => {
                const color = textColorInput.value;
                document.execCommand('foreColor', false, color);
                adminMessageEditor.style.color = color;
                adminMessageEditor.focus();
            });
            
            // Background color change handler
            backgroundColorInput.addEventListener('change', () => {
                const color = backgroundColorInput.value;
                document.execCommand('hiliteColor', false, color);
                adminMessageEditor.style.backgroundColor = color;
                adminMessageEditor.focus();
            });
        }

        // ============================================
        // STYLE SELECTOR FUNCTIONS
        // ============================================
        function initStyleSelector() {
            // Set initial mode to digital
            setStyleMode('digital');
            
            // Add event listeners to style buttons
            normalModeBtn.addEventListener('click', () => setStyleMode('normal'));
            digitalModeBtn.addEventListener('click', () => setStyleMode('digital'));
            darkModeBtn.addEventListener('click', () => setStyleMode('dark'));
        }

        function setStyleMode(mode) {
            // Remove all mode classes
            document.body.classList.remove('normal-mode', 'digital-mode', 'dark-mode');
            
            // Add the selected mode class
            document.body.classList.add(`${mode}-mode`);
            
            // Update active button state
            normalModeBtn.classList.remove('active');
            digitalModeBtn.classList.remove('active');
            darkModeBtn.classList.remove('active');
            
            if (mode === 'normal') {
                normalModeBtn.classList.add('active');
                // Hide digital background elements
                document.querySelector('.digital-bg').style.display = 'none';
                document.querySelector('.digital-grid').style.display = 'none';
                document.querySelector('.digital-particles').style.display = 'none';
            } else if (mode === 'digital') {
                digitalModeBtn.classList.add('active');
                // Show digital background elements
                document.querySelector('.digital-bg').style.display = 'block';
                document.querySelector('.digital-grid').style.display = 'block';
                document.querySelector('.digital-particles').style.display = 'block';
                // Create enhanced particles
                createEnhancedParticles();
            } else if (mode === 'dark') {
                darkModeBtn.classList.add('active');
                // Hide digital background elements
                document.querySelector('.digital-bg').style.display = 'none';
                document.querySelector('.digital-grid').style.display = 'none';
                document.querySelector('.digital-particles').style.display = 'none';
            }
            
            // Save preference to localStorage
            localStorage.setItem('preferredStyleMode', mode);
        }

        // ============================================
        // STORY MENU FUNCTIONS
        // ============================================
        function toggleStoryMenu() {
            storyMenu.classList.toggle('active');
        }

        // Close story menu when clicking outside
        document.addEventListener('click', function(event) {
            if (!event.target.closest('.story-collection-menu') && storyMenu.classList.contains('active')) {
                storyMenu.classList.remove('active');
            }
        });

        // ============================================
        // PASSWORD GENERATION MODAL FUNCTIONS
        // ============================================
        function initPasswordGenerationModal() {
            // Update range value display
            passwordRange.addEventListener('input', function() {
                rangeValue.textContent = this.value;
                modalPasswordCount.value = this.value;
                updatePasswordPreview();
            });
            
            modalPasswordCount.addEventListener('input', function() {
                const value = Math.min(100, Math.max(1, parseInt(this.value) || 1));
                this.value = value;
                passwordRange.value = value;
                rangeValue.textContent = value;
                updatePasswordPreview();
            });
            
            modalStoryName.addEventListener('change', updatePasswordPreview);
            passwordNamePrefix.addEventListener('input', updatePasswordPreview);
            
            // Close modal
            closePasswordModal.addEventListener('click', function() {
                passwordGenerationModal.style.display = 'none';
            });
            
            // Generate passwords
            generateModalPasswordsBtn.addEventListener('click', generateAdvancedPasswords);
        }

        function initMonthlyPasswordGenerationModal() {
            // Update preview when inputs change
            monthlyDuration.addEventListener('change', updateMonthlyPasswordPreview);
            monthlyPasswordCount.addEventListener('input', updateMonthlyPasswordPreview);
            monthlyStoryName.addEventListener('change', updateMonthlyPasswordPreview);
            
            // Close modal
            closeMonthlyPasswordModal.addEventListener('click', function() {
                monthlyPasswordModal.style.display = 'none';
            });
            
            // Open modal
            openMonthlyPasswordModal.addEventListener('click', function() {
                monthlyPasswordModal.style.display = 'flex';
                updateMonthlyPasswordPreview();
            });
            
            // Generate passwords
            generateMonthlyPasswordsBtn.addEventListener('click', generateMonthlyPasswords);
        }

        function updatePasswordPreview() {
            const story = modalStoryName.value;
            const namePrefix = passwordNamePrefix.value;
            const count = parseInt(modalPasswordCount.value) || 1;
            
            previewList.innerHTML = '';
            
            if (!story) {
                previewList.innerHTML = '<div style="text-align: center; color: #999;">Select a story to see preview</div>';
                return;
            }
            
            for (let i = 0; i < Math.min(5, count); i++) {
                const randomDigits = Math.floor(100000 + Math.random() * 900000);
                let password;
                
                if (namePrefix) {
                    password = `${namePrefix}.${story}.${randomDigits}`;
                } else {
                    password = `${story}.${randomDigits}`;
                }
                
                const previewItem = document.createElement('div');
                previewItem.className = 'password-preview-item';
                previewItem.textContent = `${password} (Single Device)`;
                previewList.appendChild(previewItem);
            }
            
            if (count > 5) {
                const moreItem = document.createElement('div');
                moreItem.style.textAlign = 'center';
                moreItem.style.color = '#999';
                moreItem.textContent = `... and ${count - 5} more`;
                previewList.appendChild(moreItem);
            }
        }

        function updateMonthlyPasswordPreview() {
            const story = monthlyStoryName.value;
            const duration = parseInt(monthlyDuration.value) || 1;
            const count = parseInt(monthlyPasswordCount.value) || 5;
            
            monthlyPreviewList.innerHTML = '';
            
            for (let i = 0; i < Math.min(5, count); i++) {
                const randomDigits = Math.floor(1000000 + Math.random() * 9000000);
                const password = `SD.${randomDigits}`;
                
                const previewItem = document.createElement('div');
                previewItem.className = 'password-preview-item';
                previewItem.innerHTML = `
                    <div>${password}</div>
                    <div style="font-size: 7px; color: var(--accent);">${duration} month${duration > 1 ? 's' : ''} (Single Device)</div>
                `;
                monthlyPreviewList.appendChild(previewItem);
            }
            
            if (count > 5) {
                const moreItem = document.createElement('div');
                moreItem.style.textAlign = 'center';
                moreItem.style.color = '#999';
                moreItem.textContent = `... and ${count - 5} more`;
                monthlyPreviewList.appendChild(moreItem);
            }
        }

        // ============================================
        // PASSWORD FILTER FUNCTIONS
        // ============================================
        function initPasswordFilters() {
            passwordFilterButtons.forEach(btn => {
                btn.addEventListener('click', function() {
                    // Remove active class from all buttons
                    passwordFilterButtons.forEach(b => b.classList.remove('active'));
                    
                    // Add active class to clicked button
                    this.classList.add('active');
                    
                    // Update filter
                    currentPasswordFilter = this.getAttribute('data-filter');
                    
                    // Re-render password list
                    renderPasswordList();
                });
            });
        }

        // ============================================
        // CONNECTION STATUS FUNCTIONS
        // ============================================
        function updateConnectionStatus() {
            if (navigator.onLine) {
                connectionStatus.className = 'connection-status online-status-badge';
                connectionStatus.innerHTML = '<i class="fas fa-wifi"></i> Online';
                connectionStatus.style.display = 'flex';
                isOfflineMode = false;
                
                // Hide offline indicator if exists
                const offlineIndicator = document.querySelector('.offline-indicator');
                if (offlineIndicator) {
                    offlineIndicator.remove();
                }
            } else {
                connectionStatus.className = 'connection-status offline-status-badge';
                connectionStatus.innerHTML = '<i class="fas fa-wifi-slash"></i> Offline';
                connectionStatus.style.display = 'flex';
                isOfflineMode = true;
                
                // Show offline indicator
                if (!document.querySelector('.offline-indicator')) {
                    const offlineIndicator = document.createElement('div');
                    offlineIndicator.className = 'offline-indicator';
                    offlineIndicator.innerHTML = '<i class="fas fa-wifi-slash"></i> You are currently offline';
                    document.body.appendChild(offlineIndicator);
                }
                
                // Check if we have downloaded videos
                const hasDownloadedVideos = checkOfflineVideos();
                if (!hasDownloadedVideos) {
                    setTimeout(() => {
                        noInternetModal.style.display = 'flex';
                    }, 1000);
                }
            }
            
            // Update video library for offline mode
            renderVideoLibraryWithDownloads();
        }

        // ============================================
        // EVENT LISTENERS
        // ============================================
        adminLoginBtn.addEventListener('click', () => {
            loginModal.style.display = 'flex';
        });

        closeModal.addEventListener('click', () => {
            loginModal.style.display = 'none';
        });

        loginBtn.addEventListener('click', adminLogin);

        backToScreen1.addEventListener('click', () => {
            showScreen(1);
        });

        nextToScreen3.addEventListener('click', () => {
            showScreen(3);
        });

        nextToScreen4.addEventListener('click', () => {
            showScreen(4);
        });

        backToScreen2.addEventListener('click', () => {
            showScreen(2);
        });

        backToScreen1FromContacts.addEventListener('click', () => {
            showScreen(1);
        });

        showContactLinksScreen.addEventListener('click', () => {
            showScreen(4);
        });

        unlockVideosBtn.addEventListener('click', unlockVideos);

        unlockStoryBtn.addEventListener('click', unlockStory);

        generatePasswordBtn.addEventListener('click', generatePasswords);

        // Open advanced password generation modal
        openAdvancedGenerationBtn.addEventListener('click', function() {
            passwordGenerationModal.style.display = 'flex';
            updatePasswordPreview();
        });

        addCloudinaryBtn.addEventListener('click', addCloudinaryVideo);

        addYoutubeBtn.addEventListener('click', addYouTubeVideo);

        addTelegramBtn.addEventListener('click', addTelegramVideo);

        addHlsBtn.addEventListener('click', addHlsVideo);

        addContactLinkBtn.addEventListener('click', addContactLink);

        exportStoryPasswordsTxtBtn.addEventListener('click', () => exportStoryPasswordsToTxt(passwordStory.value));

        exportStoryPasswordsPdfBtn.addEventListener('click', () => exportStoryPasswordsToPdf(passwordStory.value));

        exportAllPasswordsBtn.addEventListener('click', exportAllPasswords);

        deleteUsedPasswordsBtn.addEventListener('click', deleteUsedPasswords);

        deleteUnusedPasswordsBtn.addEventListener('click', deleteUnusedPasswords);

        deleteAllPasswordsBtn.addEventListener('click', deleteAllPasswords);

        passwordSearch.addEventListener('input', renderPasswordList);

        saveAdminMessage.addEventListener('click', saveAdminMessageData);

        // Story menu toggle
        storyMenuToggle.addEventListener('click', toggleStoryMenu);

        // Continue offline button
        continueOfflineBtn.addEventListener('click', function() {
            noInternetModal.style.display = 'none';
            
            // Check if we have downloaded videos
            const hasDownloadedVideos = checkOfflineVideos();
            if (hasDownloadedVideos) {
                renderDownloadedVideosSection();
                alert('You can access your downloaded videos in the "Downloaded Videos" section.');
            } else {
                alert('No downloaded videos available. Please connect to the internet to download videos.');
            }
        });

        // Prevent right-click on video elements
        document.addEventListener('contextmenu', function(e) {
            if (e.target.tagName === 'VIDEO' || e.target.tagName === 'IFRAME' || e.target.tagName === 'IMG') {
                e.preventDefault();
                return false;
            }
        });

        // Disable video download
        document.addEventListener('keydown', function(e) {
            // Disable F12, Ctrl+Shift+I, Ctrl+Shift+J, Ctrl+Shift+C, Ctrl+U
            if (
                e.keyCode === 123 || // F12
                (e.ctrlKey && e.shiftKey && e.keyCode === 73) || // Ctrl+Shift+I
                (e.ctrlKey && e.shiftKey && e.keyCode === 74) || // Ctrl+Shift+J
                (e.ctrlKey && e.shiftKey && e.keyCode === 67) || // Ctrl+Shift+C
                (e.ctrlKey && e.keyCode === 85) // Ctrl+U
            ) {
                e.preventDefault();
                return false;
            }
        });

        // ============================================
        // INITIALIZE THE APPLICATION
        // ============================================
        initApp();
        
        // Setup auto-cleanup system
        setupAutoCleanup();
    </script>
</body>
</html>